(function(){var geo={isnamespace_:true};geo.ALTITUDE_CLAMP_TO_GROUND=0;geo.ALTITUDE_RELATIVE_TO_GROUND=1;geo.ALTITUDE_ABSOLUTE=2;geo.ALTITUDE_CLAMP_TO_SEA_FLOOR=4;geo.ALTITUDE_RELATIVE_TO_SEA_FLOOR=5;var Sylvester={precision:1e-6};function Vector(){}
Vector.prototype={e:function(i){return(i<1||i>this.elements.length)?null:this.elements[i-1];},dimensions:function(){return this.elements.length;},modulus:function(){return Math.sqrt(this.dot(this));},eql:function(vector){var n=this.elements.length;var V=vector.elements||vector;if(n!=V.length){return false;}
while(n--){if(Math.abs(this.elements[n]-V[n])>Sylvester.precision){return false;}}
return true;},dup:function(){return Vector.create(this.elements);},map:function(fn){var elements=[];this.each(function(x,i){elements.push(fn(x,i));});return Vector.create(elements);},each:function(fn){var n=this.elements.length;for(var i=0;i<n;i++){fn(this.elements[i],i+1);}},toUnitVector:function(){var r=this.modulus();if(r===0){return this.dup();}
return this.map(function(x){return x/r;});},angleFrom:function(vector){var V=vector.elements||vector;var n=this.elements.length,k=n,i;if(n!=V.length){return null;}
var dot=0,mod1=0,mod2=0;this.each(function(x,i){dot+=x*V[i-1];mod1+=x*x;mod2+=V[i-1]*V[i-1];});mod1=Math.sqrt(mod1);mod2=Math.sqrt(mod2);if(mod1*mod2===0){return null;}
var theta=dot/(mod1*mod2);if(theta<-1){theta=-1;}
if(theta>1){theta=1;}
return Math.acos(theta);},isParallelTo:function(vector){var angle=this.angleFrom(vector);return(angle===null)?null:(angle<=Sylvester.precision);},isAntiparallelTo:function(vector){var angle=this.angleFrom(vector);return(angle===null)?null:(Math.abs(angle-Math.PI)<=Sylvester.precision);},isPerpendicularTo:function(vector){var dot=this.dot(vector);return(dot===null)?null:(Math.abs(dot)<=Sylvester.precision);},add:function(vector){var V=vector.elements||vector;if(this.elements.length!=V.length){return null;}
return this.map(function(x,i){return x+V[i-1];});},subtract:function(vector){var V=vector.elements||vector;if(this.elements.length!=V.length){return null;}
return this.map(function(x,i){return x-V[i-1];});},multiply:function(k){return this.map(function(x){return x*k;});},x:function(k){return this.multiply(k);},dot:function(vector){var V=vector.elements||vector;var i,product=0,n=this.elements.length;if(n!=V.length){return null;}
while(n--){product+=this.elements[n]*V[n];}
return product;},cross:function(vector){var B=vector.elements||vector;if(this.elements.length!=3||B.length!=3){return null;}
var A=this.elements;return Vector.create([(A[1]*B[2])-(A[2]*B[1]),(A[2]*B[0])-(A[0]*B[2]),(A[0]*B[1])-(A[1]*B[0])]);},max:function(){var m=0,i=this.elements.length;while(i--){if(Math.abs(this.elements[i])>Math.abs(m)){m=this.elements[i];}}
return m;},indexOf:function(x){var index=null,n=this.elements.length;for(var i=0;i<n;i++){if(index===null&&this.elements[i]==x){index=i+1;}}
return index;},toDiagonalMatrix:function(){return Matrix.Diagonal(this.elements);},round:function(){return this.map(function(x){return Math.round(x);});},snapTo:function(x){return this.map(function(y){return(Math.abs(y-x)<=Sylvester.precision)?x:y;});},distanceFrom:function(obj){if(obj.anchor||(obj.start&&obj.end)){return obj.distanceFrom(this);}
var V=obj.elements||obj;if(V.length!=this.elements.length){return null;}
var sum=0,part;this.each(function(x,i){part=x-V[i-1];sum+=part*part;});return Math.sqrt(sum);},liesOn:function(line){return line.contains(this);},liesIn:function(plane){return plane.contains(this);},rotate:function(t,obj){var V,R=null,x,y,z;if(t.determinant){R=t.elements;}
switch(this.elements.length){case 2:V=obj.elements||obj;if(V.length!=2){return null;}
if(!R){R=Matrix.Rotation(t).elements;}
x=this.elements[0]-V[0];y=this.elements[1]-V[1];return Vector.create([V[0]+R[0][0]*x+R[0][1]*y,V[1]+R[1][0]*x+R[1][1]*y]);break;case 3:if(!obj.direction){return null;}
var C=obj.pointClosestTo(this).elements;if(!R){R=Matrix.Rotation(t,obj.direction).elements;}
x=this.elements[0]-C[0];y=this.elements[1]-C[1];z=this.elements[2]-C[2];return Vector.create([C[0]+R[0][0]*x+R[0][1]*y+R[0][2]*z,C[1]+R[1][0]*x+R[1][1]*y+R[1][2]*z,C[2]+R[2][0]*x+R[2][1]*y+R[2][2]*z]);break;default:return null;}},reflectionIn:function(obj){if(obj.anchor){var P=this.elements.slice();var C=obj.pointClosestTo(P).elements;return Vector.create([C[0]+(C[0]-P[0]),C[1]+(C[1]-P[1]),C[2]+(C[2]-(P[2]||0))]);}else{var Q=obj.elements||obj;if(this.elements.length!=Q.length){return null;}
return this.map(function(x,i){return Q[i-1]+(Q[i-1]-x);});}},to3D:function(){var V=this.dup();switch(V.elements.length){case 3:break;case 2:V.elements.push(0);break;default:return null;}
return V;},inspect:function(){return'['+this.elements.join(', ')+']';},setElements:function(els){this.elements=(els.elements||els).slice();return this;}};Vector.create=function(elements){var V=new Vector();return V.setElements(elements);};var $V=Vector.create;Vector.i=Vector.create([1,0,0]);Vector.j=Vector.create([0,1,0]);Vector.k=Vector.create([0,0,1]);Vector.Random=function(n){var elements=[];while(n--){elements.push(Math.random());}
return Vector.create(elements);};Vector.Zero=function(n){var elements=[];while(n--){elements.push(0);}
return Vector.create(elements);};function Matrix(){}
Matrix.prototype={e:function(i,j){if(i<1||i>this.elements.length||j<1||j>this.elements[0].length){return null;}
return this.elements[i-1][j-1];},row:function(i){if(i>this.elements.length){return null;}
return Vector.create(this.elements[i-1]);},col:function(j){if(j>this.elements[0].length){return null;}
var col=[],n=this.elements.length;for(var i=0;i<n;i++){col.push(this.elements[i][j-1]);}
return Vector.create(col);},dimensions:function(){return{rows:this.elements.length,cols:this.elements[0].length};},rows:function(){return this.elements.length;},cols:function(){return this.elements[0].length;},eql:function(matrix){var M=matrix.elements||matrix;if(typeof(M[0][0])=='undefined'){M=Matrix.create(M).elements;}
if(this.elements.length!=M.length||this.elements[0].length!=M[0].length){return false;}
var i=this.elements.length,nj=this.elements[0].length,j;while(i--){j=nj;while(j--){if(Math.abs(this.elements[i][j]-M[i][j])>Sylvester.precision){return false;}}}
return true;},dup:function(){return Matrix.create(this.elements);},map:function(fn){var els=[],i=this.elements.length,nj=this.elements[0].length,j;while(i--){j=nj;els[i]=[];while(j--){els[i][j]=fn(this.elements[i][j],i+1,j+1);}}
return Matrix.create(els);},isSameSizeAs:function(matrix){var M=matrix.elements||matrix;if(typeof(M[0][0])=='undefined'){M=Matrix.create(M).elements;}
return(this.elements.length==M.length&&this.elements[0].length==M[0].length);},add:function(matrix){var M=matrix.elements||matrix;if(typeof(M[0][0])=='undefined'){M=Matrix.create(M).elements;}
if(!this.isSameSizeAs(M)){return null;}
return this.map(function(x,i,j){return x+M[i-1][j-1];});},subtract:function(matrix){var M=matrix.elements||matrix;if(typeof(M[0][0])=='undefined'){M=Matrix.create(M).elements;}
if(!this.isSameSizeAs(M)){return null;}
return this.map(function(x,i,j){return x-M[i-1][j-1];});},canMultiplyFromLeft:function(matrix){var M=matrix.elements||matrix;if(typeof(M[0][0])=='undefined'){M=Matrix.create(M).elements;}
return(this.elements[0].length==M.length);},multiply:function(matrix){if(!matrix.elements){return this.map(function(x){return x*matrix;});}
var returnVector=matrix.modulus?true:false;var M=matrix.elements||matrix;if(typeof(M[0][0])=='undefined'){M=Matrix.create(M).elements;}
if(!this.canMultiplyFromLeft(M)){return null;}
var i=this.elements.length,nj=M[0].length,j;var cols=this.elements[0].length,c,elements=[],sum;while(i--){j=nj;elements[i]=[];while(j--){c=cols;sum=0;while(c--){sum+=this.elements[i][c]*M[c][j];}
elements[i][j]=sum;}}
var M=Matrix.create(elements);return returnVector?M.col(1):M;},x:function(matrix){return this.multiply(matrix);},minor:function(a,b,c,d){var elements=[],ni=c,i,nj,j;var rows=this.elements.length,cols=this.elements[0].length;while(ni--){i=c-ni-1;elements[i]=[];nj=d;while(nj--){j=d-nj-1;elements[i][j]=this.elements[(a+i-1)%rows][(b+j-1)%cols];}}
return Matrix.create(elements);},transpose:function(){var rows=this.elements.length,i,cols=this.elements[0].length,j;var elements=[],i=cols;while(i--){j=rows;elements[i]=[];while(j--){elements[i][j]=this.elements[j][i];}}
return Matrix.create(elements);},isSquare:function(){return(this.elements.length==this.elements[0].length);},max:function(){var m=0,i=this.elements.length,nj=this.elements[0].length,j;while(i--){j=nj;while(j--){if(Math.abs(this.elements[i][j])>Math.abs(m)){m=this.elements[i][j];}}}
return m;},indexOf:function(x){var index=null,ni=this.elements.length,i,nj=this.elements[0].length,j;for(i=0;i<ni;i++){for(j=0;j<nj;j++){if(this.elements[i][j]==x){return{i:i+1,j:j+1};}}}
return null;},diagonal:function(){if(!this.isSquare){return null;}
var els=[],n=this.elements.length;for(var i=0;i<n;i++){els.push(this.elements[i][i]);}
return Vector.create(els);},toRightTriangular:function(){var M=this.dup(),els;var n=this.elements.length,i,j,np=this.elements[0].length,p;for(i=0;i<n;i++){if(M.elements[i][i]==0){for(j=i+1;j<n;j++){if(M.elements[j][i]!=0){els=[];for(p=0;p<np;p++){els.push(M.elements[i][p]+M.elements[j][p]);}
M.elements[i]=els;break;}}}
if(M.elements[i][i]!=0){for(j=i+1;j<n;j++){var multiplier=M.elements[j][i]/M.elements[i][i];els=[];for(p=0;p<np;p++){els.push(p<=i?0:M.elements[j][p]-M.elements[i][p]*multiplier);}
M.elements[j]=els;}}}
return M;},toUpperTriangular:function(){return this.toRightTriangular();},determinant:function(){if(!this.isSquare()){return null;}
var M=this.toRightTriangular();var det=M.elements[0][0],n=M.elements.length;for(var i=1;i<n;i++){det=det*M.elements[i][i];}
return det;},det:function(){return this.determinant();},isSingular:function(){return(this.isSquare()&&this.determinant()===0);},trace:function(){if(!this.isSquare()){return null;}
var tr=this.elements[0][0],n=this.elements.length;for(var i=1;i<n;i++){tr+=this.elements[i][i];}
return tr;},tr:function(){return this.trace();},rank:function(){var M=this.toRightTriangular(),rank=0;var i=this.elements.length,nj=this.elements[0].length,j;while(i--){j=nj;while(j--){if(Math.abs(M.elements[i][j])>Sylvester.precision){rank++;break;}}}
return rank;},rk:function(){return this.rank();},augment:function(matrix){var M=matrix.elements||matrix;if(typeof(M[0][0])=='undefined'){M=Matrix.create(M).elements;}
var T=this.dup(),cols=T.elements[0].length;var i=T.elements.length,nj=M[0].length,j;if(i!=M.length){return null;}
while(i--){j=nj;while(j--){T.elements[i][cols+j]=M[i][j];}}
return T;},inverse:function(){if(!this.isSquare()||this.isSingular()){return null;}
var n=this.elements.length,i=n,j;var M=this.augment(Matrix.I(n)).toRightTriangular();var np=M.elements[0].length,p,els,divisor;var inverse_elements=[],new_element;while(i--){els=[];inverse_elements[i]=[];divisor=M.elements[i][i];for(p=0;p<np;p++){new_element=M.elements[i][p]/divisor;els.push(new_element);if(p>=n){inverse_elements[i].push(new_element);}}
M.elements[i]=els;j=i;while(j--){els=[];for(p=0;p<np;p++){els.push(M.elements[j][p]-M.elements[i][p]*M.elements[j][i]);}
M.elements[j]=els;}}
return Matrix.create(inverse_elements);},inv:function(){return this.inverse();},round:function(){return this.map(function(x){return Math.round(x);});},snapTo:function(x){return this.map(function(p){return(Math.abs(p-x)<=Sylvester.precision)?x:p;});},inspect:function(){var matrix_rows=[];var n=this.elements.length;for(var i=0;i<n;i++){matrix_rows.push(Vector.create(this.elements[i]).inspect());}
return matrix_rows.join('\n');},setElements:function(els){var i,j,elements=els.elements||els;if(typeof(elements[0][0])!='undefined'){i=elements.length;this.elements=[];while(i--){j=elements[i].length;this.elements[i]=[];while(j--){this.elements[i][j]=elements[i][j];}}
return this;}
var n=elements.length;this.elements=[];for(i=0;i<n;i++){this.elements.push([elements[i]]);}
return this;}};Matrix.create=function(elements){var M=new Matrix();return M.setElements(elements);};var $M=Matrix.create;Matrix.I=function(n){var els=[],i=n,j;while(i--){j=n;els[i]=[];while(j--){els[i][j]=(i==j)?1:0;}}
return Matrix.create(els);};Matrix.Diagonal=function(elements){var i=elements.length;var M=Matrix.I(i);while(i--){M.elements[i][i]=elements[i];}
return M;};Matrix.Rotation=function(theta,a){if(!a){return Matrix.create([[Math.cos(theta),-Math.sin(theta)],[Math.sin(theta),Math.cos(theta)]]);}
var axis=a.dup();if(axis.elements.length!=3){return null;}
var mod=axis.modulus();var x=axis.elements[0]/mod,y=axis.elements[1]/mod,z=axis.elements[2]/mod;var s=Math.sin(theta),c=Math.cos(theta),t=1-c;return Matrix.create([[t*x*x+c,t*x*y-s*z,t*x*z+s*y],[t*x*y+s*z,t*y*y+c,t*y*z-s*x],[t*x*z-s*y,t*y*z+s*x,t*z*z+c]]);};Matrix.RotationX=function(t){var c=Math.cos(t),s=Math.sin(t);return Matrix.create([[1,0,0],[0,c,-s],[0,s,c]]);};Matrix.RotationY=function(t){var c=Math.cos(t),s=Math.sin(t);return Matrix.create([[c,0,s],[0,1,0],[-s,0,c]]);};Matrix.RotationZ=function(t){var c=Math.cos(t),s=Math.sin(t);return Matrix.create([[c,-s,0],[s,c,0],[0,0,1]]);};Matrix.Random=function(n,m){return Matrix.Zero(n,m).map(function(){return Math.random();});};Matrix.Zero=function(n,m){var els=[],i=n,j;while(i--){j=m;els[i]=[];while(j--){els[i][j]=0;}}
return Matrix.create(els);};function Line(){}
Line.prototype={eql:function(line){return(this.isParallelTo(line)&&this.contains(line.anchor));},dup:function(){return Line.create(this.anchor,this.direction);},translate:function(vector){var V=vector.elements||vector;return Line.create([this.anchor.elements[0]+V[0],this.anchor.elements[1]+V[1],this.anchor.elements[2]+(V[2]||0)],this.direction);},isParallelTo:function(obj){if(obj.normal||(obj.start&&obj.end)){return obj.isParallelTo(this);}
var theta=this.direction.angleFrom(obj.direction);return(Math.abs(theta)<=Sylvester.precision||Math.abs(theta-Math.PI)<=Sylvester.precision);},distanceFrom:function(obj){if(obj.normal||(obj.start&&obj.end)){return obj.distanceFrom(this);}
if(obj.direction){if(this.isParallelTo(obj)){return this.distanceFrom(obj.anchor);}
var N=this.direction.cross(obj.direction).toUnitVector().elements;var A=this.anchor.elements,B=obj.anchor.elements;return Math.abs((A[0]-B[0])*N[0]+(A[1]-B[1])*N[1]+(A[2]-B[2])*N[2]);}else{var P=obj.elements||obj;var A=this.anchor.elements,D=this.direction.elements;var PA1=P[0]-A[0],PA2=P[1]-A[1],PA3=(P[2]||0)-A[2];var modPA=Math.sqrt(PA1*PA1+PA2*PA2+PA3*PA3);if(modPA===0)return 0;var cosTheta=(PA1*D[0]+PA2*D[1]+PA3*D[2])/modPA;var sin2=1-cosTheta*cosTheta;return Math.abs(modPA*Math.sqrt(sin2<0?0:sin2));}},contains:function(obj){if(obj.start&&obj.end){return this.contains(obj.start)&&this.contains(obj.end);}
var dist=this.distanceFrom(obj);return(dist!==null&&dist<=Sylvester.precision);},positionOf:function(point){if(!this.contains(point)){return null;}
var P=point.elements||point;var A=this.anchor.elements,D=this.direction.elements;return(P[0]-A[0])*D[0]+(P[1]-A[1])*D[1]+((P[2]||0)-A[2])*D[2];},liesIn:function(plane){return plane.contains(this);},intersects:function(obj){if(obj.normal){return obj.intersects(this);}
return(!this.isParallelTo(obj)&&this.distanceFrom(obj)<=Sylvester.precision);},intersectionWith:function(obj){if(obj.normal||(obj.start&&obj.end)){return obj.intersectionWith(this);}
if(!this.intersects(obj)){return null;}
var P=this.anchor.elements,X=this.direction.elements,Q=obj.anchor.elements,Y=obj.direction.elements;var X1=X[0],X2=X[1],X3=X[2],Y1=Y[0],Y2=Y[1],Y3=Y[2];var PsubQ1=P[0]-Q[0],PsubQ2=P[1]-Q[1],PsubQ3=P[2]-Q[2];var XdotQsubP=-X1*PsubQ1-X2*PsubQ2-X3*PsubQ3;var YdotPsubQ=Y1*PsubQ1+Y2*PsubQ2+Y3*PsubQ3;var XdotX=X1*X1+X2*X2+X3*X3;var YdotY=Y1*Y1+Y2*Y2+Y3*Y3;var XdotY=X1*Y1+X2*Y2+X3*Y3;var k=(XdotQsubP*YdotY/XdotX+XdotY*YdotPsubQ)/(YdotY-XdotY*XdotY);return Vector.create([P[0]+k*X1,P[1]+k*X2,P[2]+k*X3]);},pointClosestTo:function(obj){if(obj.start&&obj.end){var P=obj.pointClosestTo(this);return(P===null)?null:this.pointClosestTo(P);}else if(obj.direction){if(this.intersects(obj)){return this.intersectionWith(obj);}
if(this.isParallelTo(obj)){return null;}
var D=this.direction.elements,E=obj.direction.elements;var D1=D[0],D2=D[1],D3=D[2],E1=E[0],E2=E[1],E3=E[2];var x=(D3*E1-D1*E3),y=(D1*E2-D2*E1),z=(D2*E3-D3*E2);var N=[x*E3-y*E2,y*E1-z*E3,z*E2-x*E1];var P=Plane.create(obj.anchor,N);return P.intersectionWith(this);}else{var P=obj.elements||obj;if(this.contains(P)){return Vector.create(P);}
var A=this.anchor.elements,D=this.direction.elements;var D1=D[0],D2=D[1],D3=D[2],A1=A[0],A2=A[1],A3=A[2];var x=D1*(P[1]-A2)-D2*(P[0]-A1),y=D2*((P[2]||0)-A3)-D3*(P[1]-A2),z=D3*(P[0]-A1)-D1*((P[2]||0)-A3);var V=Vector.create([D2*x-D3*z,D3*y-D1*x,D1*z-D2*y]);var k=this.distanceFrom(P)/V.modulus();return Vector.create([P[0]+V.elements[0]*k,P[1]+V.elements[1]*k,(P[2]||0)+V.elements[2]*k]);}},rotate:function(t,line){if(typeof(line.direction)=='undefined'){line=Line.create(line.to3D(),Vector.k);}
var R=Matrix.Rotation(t,line.direction).elements;var C=line.pointClosestTo(this.anchor).elements;var A=this.anchor.elements,D=this.direction.elements;var C1=C[0],C2=C[1],C3=C[2],A1=A[0],A2=A[1],A3=A[2];var x=A1-C1,y=A2-C2,z=A3-C3;return Line.create([C1+R[0][0]*x+R[0][1]*y+R[0][2]*z,C2+R[1][0]*x+R[1][1]*y+R[1][2]*z,C3+R[2][0]*x+R[2][1]*y+R[2][2]*z],[R[0][0]*D[0]+R[0][1]*D[1]+R[0][2]*D[2],R[1][0]*D[0]+R[1][1]*D[1]+R[1][2]*D[2],R[2][0]*D[0]+R[2][1]*D[1]+R[2][2]*D[2]]);},reverse:function(){return Line.create(this.anchor,this.direction.x(-1));},reflectionIn:function(obj){if(obj.normal){var A=this.anchor.elements,D=this.direction.elements;var A1=A[0],A2=A[1],A3=A[2],D1=D[0],D2=D[1],D3=D[2];var newA=this.anchor.reflectionIn(obj).elements;var AD1=A1+D1,AD2=A2+D2,AD3=A3+D3;var Q=obj.pointClosestTo([AD1,AD2,AD3]).elements;var newD=[Q[0]+(Q[0]-AD1)-newA[0],Q[1]+(Q[1]-AD2)-newA[1],Q[2]+(Q[2]-AD3)-newA[2]];return Line.create(newA,newD);}else if(obj.direction){return this.rotate(Math.PI,obj);}else{var P=obj.elements||obj;return Line.create(this.anchor.reflectionIn([P[0],P[1],(P[2]||0)]),this.direction);}},setVectors:function(anchor,direction){anchor=Vector.create(anchor);direction=Vector.create(direction);if(anchor.elements.length==2){anchor.elements.push(0);}
if(direction.elements.length==2){direction.elements.push(0);}
if(anchor.elements.length>3||direction.elements.length>3){return null;}
var mod=direction.modulus();if(mod===0){return null;}
this.anchor=anchor;this.direction=Vector.create([direction.elements[0]/mod,direction.elements[1]/mod,direction.elements[2]/mod]);return this;}};Line.create=function(anchor,direction){var L=new Line();return L.setVectors(anchor,direction);};var $L=Line.create;Line.X=Line.create(Vector.Zero(3),Vector.i);Line.Y=Line.create(Vector.Zero(3),Vector.j);Line.Z=Line.create(Vector.Zero(3),Vector.k);geo.linalg={};geo.linalg.Vector=function(){return Vector.create.apply(null,arguments);};geo.linalg.Vector.create=Vector.create;geo.linalg.Vector.i=Vector.i;geo.linalg.Vector.j=Vector.j;geo.linalg.Vector.k=Vector.k;geo.linalg.Vector.Random=Vector.Random;geo.linalg.Vector.Zero=Vector.Zero;geo.linalg.Matrix=function(){return Matrix.create.apply(null,arguments);};geo.linalg.Matrix.create=Matrix.create;geo.linalg.Matrix.I=Matrix.I;geo.linalg.Matrix.Random=Matrix.Random;geo.linalg.Matrix.Rotation=Matrix.Rotation;geo.linalg.Matrix.RotationX=Matrix.RotationX;geo.linalg.Matrix.RotationY=Matrix.RotationY;geo.linalg.Matrix.RotationZ=Matrix.RotationZ;geo.linalg.Matrix.Zero=Matrix.Zero;geo.linalg.Line=function(){return Line.create.apply(null,arguments);};geo.linalg.Line.create=Line.create;geo.linalg.Line.X=Line.X;geo.linalg.Line.Y=Line.Y;geo.linalg.Line.Z=Line.Z;geo.math={isnamespace_:true};if(!('toDegrees'in Number.prototype)){Number.prototype.toDegrees=function(){return this*180/Math.PI;};}
if(!('toRadians'in Number.prototype)){Number.prototype.toRadians=function(){return this*Math.PI/180;};}
geo.math.normalizeAngle=function(angleRad){angleRad=angleRad%(2*Math.PI);return angleRad>=0?angleRad:angleRad+2*Math.PI;};geo.math.normalizeLat=function(lat){return Math.max(-90,Math.min(90,lat));};geo.math.normalizeLng=function(lng){if(lng%360==180){return 180;}
lng=lng%360;return lng<-180?lng+360:lng>180?lng-360:lng;};geo.math.reverseAngle=function(angleRad){return geo.math.normalizeAngle(angleRad+Math.PI);};geo.math.wrapValue=function(value,range,favorMin){if(!range||!geo.util.isArray(range)||range.length!=2){throw new TypeError('The range parameter must be an array of 2 numbers.');}
if(value===range[0]){return range[0];}
value-=range[0];value=value%(range[1]-range[0]);if(value<0){value+=(range[1]-range[0]);}
value+=range[0];return(value===range[0])?(favorMin?range[0]:range[1]):value;};geo.math.constrainValue=function(value,range){if(!range||!geo.util.isArray(range)||range.length!=2){throw new TypeError('The range parameter must be an array of 2 numbers.');}
return Math.max(range[0],Math.min(range[1],value));};geo.math.EARTH_RADIUS=6378135;geo.math.EARTH_RADIUS_CURVATURE_AVG=6372795;geo.math.distance=function(point1,point2){return geo.math.EARTH_RADIUS*geo.math.angularDistance(point1,point2);};geo.math.angularDistance=function(point1,point2){var phi1=point1.lat().toRadians();var phi2=point2.lat().toRadians();var d_phi=(point2.lat()-point1.lat()).toRadians();var d_lmd=(point2.lng()-point1.lng()).toRadians();var A=Math.pow(Math.sin(d_phi/2),2)+
Math.cos(phi1)*Math.cos(phi2)*Math.pow(Math.sin(d_lmd/2),2);return 2*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));};geo.math.heading=function(start,dest){var phi1=start.lat().toRadians();var phi2=dest.lat().toRadians();var cos_phi2=Math.cos(phi2);var d_lmd=(dest.lng()-start.lng()).toRadians();return geo.math.normalizeAngle(Math.atan2(Math.sin(d_lmd)*cos_phi2,Math.cos(phi1)*Math.sin(phi2)-Math.sin(phi1)*cos_phi2*Math.cos(d_lmd))).toDegrees();};geo.math.bearing=geo.math.heading;geo.math.midpoint=function(point1,point2,fraction){if(geo.util.isUndefined(fraction)||fraction===null){fraction=0.5;}
if(point1.equals(point2)){return new geo.Point(point1);}
var phi1=point1.lat().toRadians();var phi2=point2.lat().toRadians();var lmd1=point1.lng().toRadians();var lmd2=point2.lng().toRadians();var cos_phi1=Math.cos(phi1);var cos_phi2=Math.cos(phi2);var angularDistance=geo.math.angularDistance(point1,point2);var sin_angularDistance=Math.sin(angularDistance);var A=Math.sin((1-fraction)*angularDistance)/sin_angularDistance;var B=Math.sin(fraction*angularDistance)/sin_angularDistance;var x=A*cos_phi1*Math.cos(lmd1)+
B*cos_phi2*Math.cos(lmd2);var y=A*cos_phi1*Math.sin(lmd1)+
B*cos_phi2*Math.sin(lmd2);var z=A*Math.sin(phi1)+
B*Math.sin(phi2);return new geo.Point(Math.atan2(z,Math.sqrt(Math.pow(x,2)+
Math.pow(y,2))).toDegrees(),Math.atan2(y,x).toDegrees());};geo.math.destination=function(start,options){if(!('heading'in options&&'distance'in options)){throw new TypeError('destination() requres both heading and '+'distance options.');}
var phi1=start.lat().toRadians();var sin_phi1=Math.sin(phi1);var angularDistance=options.distance/geo.math.EARTH_RADIUS;var heading_rad=options.heading.toRadians();var sin_angularDistance=Math.sin(angularDistance);var cos_angularDistance=Math.cos(angularDistance);var phi2=Math.asin(sin_phi1*cos_angularDistance+
Math.cos(phi1)*sin_angularDistance*Math.cos(heading_rad));return new geo.Point(phi2.toDegrees(),Math.atan2(Math.sin(heading_rad)*sin_angularDistance*Math.cos(phi2),cos_angularDistance-sin_phi1*Math.sin(phi2)).toDegrees()+
start.lng());};geo.Point=function(){var pointArraySrc=null;if(arguments.length==1){var point=arguments[0];if(point.constructor===geo.Point){this.lat_=point.lat();this.lng_=point.lng();this.altitude_=point.altitude();this.altitudeMode_=point.altitudeMode();}else if(geo.util.isArray(point)){pointArraySrc=point;}else if(isEarthAPIObject_(point)){var type=point.getType();if(type=='KmlPoint'||type=='KmlLookAt'){this.lat_=point.getLatitude();this.lng_=point.getLongitude();this.altitude_=point.getAltitude();this.altitudeMode_=point.getAltitudeMode();}else if(type=='KmlCoord'||type=='KmlLocation'){this.lat_=point.getLatitude();this.lng_=point.getLongitude();this.altitude_=point.getAltitude();}else{throw new TypeError('Could not create a point from the given Earth object');}}else if(isGLatLng_(point)){this.lat_=point.lat();this.lng_=point.lng();}else{throw new TypeError('Could not create a point from the given arguments');}}else{pointArraySrc=arguments;}
if(pointArraySrc){for(var i=0;i<pointArraySrc.length;i++){if(typeof pointArraySrc[i]!='number'){throw new TypeError('Coordinates must be numerical');}}
this.lat_=pointArraySrc[0];this.lng_=pointArraySrc[1];if(pointArraySrc.length>=3){this.altitude_=pointArraySrc[2];if(pointArraySrc.length>=4){this.altitudeMode_=pointArraySrc[3];}}}
this.lat_=geo.math.normalizeLat(this.lat_);this.lng_=geo.math.normalizeLng(this.lng_);};geo.Point.prototype.lat=function(){return this.lat_;};geo.Point.prototype.lat_=0;geo.Point.prototype.lng=function(){return this.lng_;};geo.Point.prototype.lng_=0;geo.Point.prototype.altitude=function(){return this.altitude_;};geo.Point.prototype.altitude_=0;geo.Point.prototype.altitudeMode=function(){return this.altitudeMode_;};geo.Point.prototype.altitudeMode_=geo.ALTITUDE_RELATIVE_TO_GROUND;geo.Point.prototype.toString=function(){return'('+this.lat().toString()+', '+this.lng().toString()+', '+
this.altitude().toString()+')';};geo.Point.prototype.flatten=function(){return new geo.Point(this.lat(),this.lng());};geo.Point.prototype.is3D=function(){return this.altitude_!==0;};geo.Point.prototype.equals=function(p2){return this.lat()==p2.lat()&&this.lng()==p2.lng()&&this.altitude()==p2.altitude()&&this.altitudeMode()==p2.altitudeMode();};geo.Point.prototype.angularDistance=function(dest){return geo.math.angularDistance(this,dest);};geo.Point.prototype.distance=function(dest){return geo.math.distance(this,dest);};geo.Point.prototype.heading=function(dest){return geo.math.heading(this,dest);};geo.Point.prototype.midpoint=function(dest,fraction){return geo.math.midpoint(this,dest,fraction);};geo.Point.prototype.destination=function(options){return geo.math.destination(this,options);};geo.Point.prototype.toCartesian=function(){var sin_phi=Math.sin(this.lng().toRadians());var cos_phi=Math.cos(this.lng().toRadians());var sin_lmd=Math.sin(this.lat().toRadians());var cos_lmd=Math.cos(this.lat().toRadians());var r=geo.math.EARTH_RADIUS+this.altitude();return new geo.linalg.Vector([r*cos_phi*cos_lmd,r*sin_lmd,r*-sin_phi*cos_lmd]);};geo.Point.fromCartesian=function(cartesianVector){var r=cartesianVector.distanceFrom(geo.linalg.Vector.Zero(3));var unitVector=cartesianVector.toUnitVector();var altitude=r-geo.math.EARTH_RADIUS;var lat=Math.asin(unitVector.e(2)).toDegrees();if(lat>90){lat-=180;}
var lng=0;if(Math.abs(lat)<90){lng=-Math.atan2(unitVector.e(3),unitVector.e(1)).toDegrees();}
return new geo.Point(lat,lng,altitude);};geo.Bounds=function(){if(arguments.length==1){if(arguments[0].constructor===geo.Bounds){var bounds=arguments[0];this.sw_=new geo.Point(bounds.southWestBottom());this.ne_=new geo.Point(bounds.northEastTop());}else{this.sw_=this.ne_=new geo.Point(arguments[0]);}}else if(arguments.length==2){var sw=new geo.Point(arguments[0]);var ne=new geo.Point(arguments[1]);if(!sw&&!ne){return;}else if(!sw){sw=ne;}else if(!ne){ne=sw;}
if(sw.lat()>ne.lat()){throw new RangeError('Bounds southwest coordinate cannot be north of '+'the northeast coordinate');}
if(sw.altitude()>ne.altitude()){throw new RangeError('Bounds southwest coordinate cannot be north of '+'the northeast coordinate');}
this.sw_=sw;this.ne_=ne;}};geo.Bounds.prototype.southWestBottom=function(){return this.sw_;};geo.Bounds.prototype.sw_=null;geo.Bounds.prototype.south=function(){return!this.isEmpty()?this.sw_.lat():null;};geo.Bounds.prototype.west=function(){return!this.isEmpty()?this.sw_.lng():null;};geo.Bounds.prototype.bottom=function(){return!this.isEmpty()?this.sw_.altitude():null;};geo.Bounds.prototype.northEastTop=function(){return this.ne_;};geo.Bounds.prototype.ne_=null;geo.Bounds.prototype.north=function(){return!this.isEmpty()?this.ne_.lat():null;};geo.Bounds.prototype.east=function(){return!this.isEmpty()?this.ne_.lng():null;};geo.Bounds.prototype.top=function(){return!this.isEmpty()?this.ne_.altitude():null;};geo.Bounds.prototype.crossesAntimeridian=function(){return!this.isEmpty()&&(this.sw_.lng()>this.ne_.lng());};geo.Bounds.prototype.is3D=function(){return!this.isEmpty()&&(this.sw_.is3D()||this.ne_.is3D());};geo.Bounds.prototype.containsPoint=function(point){point=new geo.Point(point);if(this.isEmpty()){return false;}
if(!(this.south()<=point.lat()&&point.lat()<=this.north())){return false;}
if(this.is3D()&&!(this.bottom()<=point.altitude()&&point.altitude()<=this.top())){return false;}
return this.containsLng_(point.lng());};geo.Bounds.prototype.containsLng_=function(lng){if(this.crossesAntimeridian()){return(lng<=this.east()||lng>=this.west());}else{return(this.west()<=lng&&lng<=this.east());}};function lngSpan_(west,east){return(west>east)?(east+360-west):(east-west);}
geo.Bounds.prototype.extend=function(point){point=new geo.Point(point);if(this.containsPoint(point)){return;}
if(this.isEmpty()){this.sw_=this.ne_=point;return;}
var newBottom=this.bottom();var newTop=this.top();if(this.is3D()){newBottom=Math.min(newBottom,point.altitude());newTop=Math.max(newTop,point.altitude());}
var newSouth=Math.min(this.south(),point.lat());var newNorth=Math.max(this.north(),point.lat());var newWest=this.west();var newEast=this.east();if(!this.containsLng_(point.lng())){var extendEastLngSpan=lngSpan_(newWest,point.lng());var extendWestLngSpan=lngSpan_(point.lng(),newEast);if(extendEastLngSpan<=extendWestLngSpan){newEast=point.lng();}else{newWest=point.lng();}}
this.sw_=new geo.Point(newSouth,newWest,newBottom);this.ne_=new geo.Point(newNorth,newEast,newTop);};geo.Bounds.prototype.span=function(){if(this.isEmpty()){return{lat:0,lng:0,altitude:0};}
return{lat:(this.ne_.lat()-this.sw_.lat()),lng:lngSpan_(this.sw_.lng(),this.ne_.lng()),altitude:this.is3D()?(this.ne_.altitude()-this.sw_.altitude()):null};};geo.Bounds.prototype.isEmpty=function(){return(this.sw_===null&&this.sw_===null);};geo.Bounds.prototype.center=function(){if(this.isEmpty()){return null;}
return new geo.Point((this.sw_.lat()+this.ne_.lat())/2,this.crossesAntimeridian()?geo.math.normalizeLng(this.sw_.lng()+
lngSpan_(this.sw_.lng(),this.ne_.lng())/2):(this.sw_.lng()+this.ne_.lng())/2,(this.sw_.altitude()+this.ne_.altitude())/2);};geo.Bounds.prototype.getCenter=geo.Bounds.prototype.center;geo.Bounds.prototype.isFullLat=function(){return!this.isEmpty()&&(this.south()==-90&&this.north()==90);};geo.Bounds.prototype.isFullLng=function(){return!this.isEmpty()&&(this.west()==-180&&this.east()==180);};geo.Path=function(){this.coords_=[];var coordArraySrc=null;var i,n;if(arguments.length==1){var path=arguments[0];if(path.constructor===geo.Path){for(i=0;i<path.numCoords();i++){this.coords_.push(new geo.Point(path.coord(i)));}}else if(geo.util.isArray(path)){coordArraySrc=path;}else if(isEarthAPIObject_(path)){var type=path.getType();if(type=='KmlLineString'||type=='KmlLinearRing'){n=path.getCoordinates().getLength();for(i=0;i<n;i++){this.coords_.push(new geo.Point(path.getCoordinates().get(i)));}}else{throw new TypeError('Could not create a path from the given arguments');}}else if('getVertex'in path&&'getVertexCount'in path){n=path.getVertexCount();for(i=0;i<n;i++){this.coords_.push(new geo.Point(path.getVertex(i)));}}else{throw new TypeError('Could not create a path from the given arguments');}}else{coordArraySrc=arguments;}
if(coordArraySrc){for(i=0;i<coordArraySrc.length;i++){this.coords_.push(new geo.Point(coordArraySrc[i]));}}};geo.Path.prototype.coords_=null;geo.Path.prototype.toString=function(){return'['+geo.util.arrayMap(this.coords_,function(p){return p.toString();}).join(', ')+']';};geo.Path.prototype.equals=function(p2){for(var i=0;i<p2.numCoords();i++){if(!this.coord(i).equals(p2.coord(i))){return false;}}
return true;};geo.Path.prototype.numCoords=function(){return this.coords_.length;};geo.Path.prototype.coord=function(i){return this.coords_[i];};geo.Path.prototype.prepend=function(coord){this.coords_.unshift(new geo.Point(coord));};geo.Path.prototype.append=function(coord){this.coords_.push(new geo.Point(coord));};geo.Path.prototype.insert=function(i,coord){this.coords_.splice(i,0,new geo.Point(coord));};geo.Path.prototype.remove=function(i){this.coords_.splice(i,1);};geo.Path.prototype.subPath=function(startIndex,endIndex){return this.coords_.slice(startIndex,endIndex);};geo.Path.prototype.reverse=function(){this.coords_.reverse();};geo.Path.prototype.distance=function(){var dist=0;for(var i=0;i<this.coords_.length-1;i++){dist+=this.coords_[i].distance(this.coords_[i+1]);}
return dist;};geo.Path.prototype.containsPoint=function(point){var oddNodes=false;var y=point.lat();var x=point.lng();for(var i=0;i<this.coords_.length;i++){var j=(i+1)%this.coords_.length;if(((this.coords_[i].lat()<y&&this.coords_[j].lat()>=y)||(this.coords_[j].lat()<y&&this.coords_[i].lat()>=y))&&(this.coords_[i].lng()+(y-this.coords_[i].lat())/(this.coords_[j].lat()-this.coords_[i].lat())*(this.coords_[j].lng()-this.coords_[i].lng())<x)){oddNodes=!oddNodes;}}
return oddNodes;};geo.Path.prototype.bounds=function(){if(!this.numCoords()){return new geo.Bounds();}
var bounds=new geo.Bounds(this.coord(0));var numCoords=this.numCoords();for(var i=1;i<numCoords;i++){bounds.extend(this.coord(i));}
return bounds;};geo.Path.prototype.signedArea_=function(){var a=0;var b=this.bounds();var x0=b.west();var y0=b.south();var numCoords=this.numCoords();for(var i=0;i<numCoords;i++){var j=(i+1)%numCoords;var x1=this.coord(i).distance(new geo.Point(this.coord(i).lat(),x0));var x2=this.coord(j).distance(new geo.Point(this.coord(j).lat(),x0));var y1=this.coord(i).distance(new geo.Point(y0,this.coord(i).lng()));var y2=this.coord(j).distance(new geo.Point(y0,this.coord(j).lng()));a+=x1*y2-x2*y1;}
return a*0.5;};geo.Path.prototype.area=function(){return Math.abs(this.signedArea_());};geo.Path.prototype.isCounterClockwise_=function(){return Boolean(this.signedArea_()>=0);};geo.Polygon=function(){this.outerBoundary_=new geo.Path();this.innerBoundaries_=[];var i;if(arguments.length===0){}else if(arguments.length==1){var poly=arguments[0];if(poly.constructor===geo.Polygon){this.outerBoundary_=new geo.Path(poly.outerBoundary());for(i=0;i<poly.innerBoundaries().length;i++){this.innerBoundaries_.push(new geo.Path(poly.innerBoundaries()[i]));}}else if(isEarthAPIObject_(poly)){var type=poly.getType();if(type=='KmlLineString'||type=='KmlLinearRing'){this.outerBoundary_=new geo.Path(poly);}else if(type=='KmlPolygon'){this.outerBoundary_=new geo.Path(poly.getOuterBoundary());var ibChildNodes=poly.getInnerBoundaries().getChildNodes();var n=ibChildNodes.getLength();for(i=0;i<n;i++){this.innerBoundaries_.push(new geo.Path(ibChildNodes.item(i)));}}else{throw new TypeError('Could not create a polygon from the given arguments');}}else{this.outerBoundary_=new geo.Path(arguments[0]);}}else{if(arguments[0].length&&typeof arguments[0][0]=='number'){this.outerBoundary_=new geo.Path(arguments);}else if(arguments[1]){this.outerBoundary_=new geo.Path(arguments[0]);if(!geo.util.isArray(arguments[1])){throw new TypeError('Second argument to geo.Polygon constructor '+'must be an array of paths.');}
for(i=0;i<arguments[1].length;i++){this.innerBoundaries_.push(new geo.Path(arguments[1][i]));}}else{throw new TypeError('Cannot create a path from the given arguments.');}}};geo.Polygon.prototype.outerBoundary_=null;geo.Polygon.prototype.innerBoundaries_=null;geo.Polygon.prototype.toString=function(){return'Polygon: '+this.outerBoundary().toString()+
(this.innerBoundaries().length?', ('+this.innerBoundaries().length+' inner boundaries)':'');};geo.Polygon.prototype.outerBoundary=function(){return this.outerBoundary_;};geo.Polygon.prototype.innerBoundaries=function(){return this.innerBoundaries_;};geo.Polygon.prototype.containsPoint=function(point){if(!this.outerBoundary_.containsPoint(point)){return false;}
for(var i=0;i<this.innerBoundaries_.length;i++){if(this.innerBoundaries_[i].containsPoint(point)){return false;}}
return true;};geo.Polygon.prototype.bounds=function(){return this.outerBoundary_.bounds();};geo.Polygon.prototype.area=function(){var area=this.outerBoundary_.area();for(var i=0;i<this.innerBoundaries_.length;i++){area-=this.innerBoundaries_[i].area();}
return area;};geo.Polygon.prototype.isCounterClockwise=function(){return this.outerBoundary_.isCounterClockwise_();};geo.Polygon.prototype.makeCounterClockwise=function(){if(this.isCounterClockwise()){this.outerBoundary_.reverse();}};geo.util={isnamespace_:true};geo.util.arrayMap=(function(){function arrayMap(arr,mapFn,thisp){return arr.map(mapFn,thisp);}
function noArrayMap(arr,mapFn,thisp){if(typeof mapFn!='function'){throw new TypeError('map() requires a mapping function.');}
var len=arr.length,res=new Array(len);for(var i=0;i<len;i++){if(i in arr){res[i]=mapFn.call(thisp,arr[i],i,arr);}}
return res;}
if(!('map'in Array.prototype)){return noArrayMap;}else{return arrayMap;}})();geo.util.isUndefined=function(object){return typeof object=='undefined';};geo.util.isArray=function(object){return object!==null&&typeof object=='object'&&'splice'in object&&'join'in object;};geo.util.isFunction=function(object){return object!==null&&typeof object=='function'&&'call'in object&&'apply'in object;};function isEarthAPIObject_(object){return object!==null&&(typeof object=='function'||typeof object=='object')&&'getType'in object;}
geo.util.isObjectLiteral=function(object){return object!==null&&typeof object=='object'&&object.constructor===Object&&!isEarthAPIObject_(object);};function isGLatLng_(object){return(window.google&&window.google.maps&&window.google.maps.LatLng&&object.constructor===window.google.maps.LatLng);}
window.geo=geo;})();(function(){var GEarthExtensions=function(pluginInstance){var me=this;this.pluginInstance=pluginInstance;function bindFunction_(fn_){return function(){return fn_.apply(me,arguments);};}
function bindNamespaceMembers_(nsParent){for(var mstr in nsParent){var member=nsParent[mstr];if(geo.util.isFunction(member)){if(member.isclass_){member.extInstance_=me;}else{nsParent[mstr]=bindFunction_(member);}}
if(isExtensionsNamespace_(member)){var nsDuplicate={};for(var subMstr in member){nsDuplicate[subMstr]=member[subMstr];}
bindNamespaceMembers_(nsDuplicate);nsParent[mstr]=nsDuplicate;}}}
bindNamespaceMembers_(this);};var AUTO_=Infinity;var ALLOWED_=null;var REQUIRED_=undefined;function checkParameters_(explicitParams,allowAll,paramSpec){var finalParams={};explicitParams=explicitParams||{};paramSpec=paramSpec||{};for(var member in explicitParams){if(!allowAll&&!(member in paramSpec)){var allowed=[];for(var m in paramSpec){allowed.push(m);}
throw new Error('Unexpected parameter \''+member+'\'. '+'Allowed parameters are: '+allowed.join(', ')+'.');}
finalParams[member]=explicitParams[member];}
for(member in paramSpec){if(!(member in finalParams)){if(paramSpec[member]===REQUIRED_){throw new Error('Required parameter \''+member+'\' was not passed.');}
if(paramSpec[member]!=ALLOWED_&&paramSpec[member]!=AUTO_){finalParams[member]=paramSpec[member];}}}
return finalParams;}
function createClass_(){var mixins=[];var constructorFn=null;if(geo.util.isArray(arguments[0])){mixins=arguments[0];constructorFn=arguments[1];}else{constructorFn=arguments[0];}
constructorFn.isclass_=true;for(var i=0;i<mixins.length;i++){for(var k in mixins[i].prototype){constructorFn.prototype[k]=mixins[i].prototype[k];}}
return constructorFn;}
function isExtensionsNamespace_(object){return object!==null&&typeof object=='object'&&'isnamespace_'in object&&object.isnamespace_;}
GEarthExtensions.isInstanceOfEarthInterface=function(object,type){return object!==null&&(typeof object=='object'||typeof object=='function')&&'getType'in object&&object.getType()==type;};GEarthExtensions.prototype.dom={isnamespace_:true};function domBuilder_(params){if(params.apiInterface&&!geo.util.isArray(params.apiInterface)){params.apiInterface=[params.apiInterface];}
var base=params.base;while(base){if('propertySpec'in base.builderParams){if(!('propertySpec'in params)){params.propertySpec=[];}
for(var member in base.builderParams.propertySpec){if(!(member in params.propertySpec)){params.propertySpec[member]=base.builderParams.propertySpec[member];}}}
if(!params.apiInterface){params.apiInterface=base.builderParams.apiInterface;}
if(!params.apiFactoryFn){params.apiFactoryFn=base.builderParams.apiFactoryFn;}
base=base.builderParams.base;}
var rootPropertySpec={id:''};for(member in rootPropertySpec){if(!(member in params.propertySpec)){params.propertySpec[member]=rootPropertySpec[member];}}
var builderFn=function(){var options={};var i;if(arguments.length===0){throw new TypeError('Cannot create object without any arguments!');}else if(arguments.length==1){for(i=0;i<params.apiInterface.length;i++){if(GEarthExtensions.isInstanceOfEarthInterface(arguments[0],params.apiInterface[i])){return arguments[0];}}
var arg=arguments[0];if(geo.util.isObjectLiteral(arg)){options=arg;}else if('defaultProperty'in params){options[params.defaultProperty]=arg;}else{throw new TypeError('Expected options object');}}else if(arguments.length==2){if('defaultProperty'in params){options=arguments[1];options[params.defaultProperty]=arguments[0];}else{throw new Error('No default property for the DOM builder');}}
options=checkParameters_(options,false,params.propertySpec);var newObj=this.pluginInstance[params.apiFactoryFn](options.id);if(!geo.util.isUndefined(params.constructor)){params.constructor.call(this,newObj,options);}
base=params.base;while(base){if('constructor'in base.builderParams){base.builderParams.constructor.call(this,newObj,options);}
base=base.builderParams.base;}
for(var property in params.propertySpec){if(params.propertySpec[property]===AUTO_&&property in options){newObj['set'+property.charAt(0).toUpperCase()+property.substr(1)](options[property]);}}
return newObj;};builderFn.builderParams=params;return builderFn;}
GEarthExtensions.prototype.dom.buildFeature_=domBuilder_({propertySpec:{name:AUTO_,visibility:AUTO_,description:AUTO_,snippet:AUTO_,region:ALLOWED_},constructor:function(featureObj,options){if(options.region){featureObj.setRegion(this.dom.buildRegion(options.region));}}});GEarthExtensions.prototype.dom.buildPlacemark=domBuilder_({apiInterface:'KmlPlacemark',base:GEarthExtensions.prototype.dom.buildFeature_,apiFactoryFn:'createPlacemark',propertySpec:{point:ALLOWED_,lineString:ALLOWED_,linearRing:ALLOWED_,polygon:ALLOWED_,model:ALLOWED_,geometries:ALLOWED_,altitudeMode:ALLOWED_,stockIcon:ALLOWED_,icon:ALLOWED_,style:ALLOWED_,highlightStyle:ALLOWED_},constructor:function(placemarkObj,options){var geometries=[];if(options.point){geometries.push(this.dom.buildPoint(options.point));}
if(options.lineString){geometries.push(this.dom.buildLineString(options.lineString));}
if(options.linearRing){geometries.push(this.dom.buildLinearRing(options.linearRing));}
if(options.polygon){geometries.push(this.dom.buildPolygon(options.polygon));}
if(options.model){geometries.push(this.dom.buildModel(options.model));}
if(options.multiGeometry){geometries.push(this.dom.buildMultiGeometry(options.multiGeometry));}
if(options.geometries){geometries=geometries.concat(options.geometries);}
if(geometries.length>1){placemarkObj.setGeometry(this.dom.buildMultiGeometry(geometries));}else if(geometries.length==1){placemarkObj.setGeometry(geometries[0]);}
if(options.stockIcon){options.icon=options.icon||{};options.icon.stockIcon=options.stockIcon;}
if(options.icon){if(!options.style){options.style={};}
options.style.icon=options.icon;}
if('altitudeMode'in options){placemarkObj.getGeometry().setAltitudeMode(options.altitudeMode);}
if(options.style){if(options.highlightStyle){var styleMap=this.pluginInstance.createStyleMap('');if(typeof options.style=='string'){styleMap.setNormalStyleUrl(options.style);}else{styleMap.setNormalStyle(this.dom.buildStyle(options.style));}
if(typeof options.highlightStyle=='string'){styleMap.setHighlightStyleUrl(options.highlightStyle);}else{styleMap.setHighlightStyle(this.dom.buildStyle(options.highlightStyle));}
placemarkObj.setStyleSelector(styleMap);}else{if(typeof options.style=='string'){placemarkObj.setStyleUrl(options.style);}else{placemarkObj.setStyleSelector(this.dom.buildStyle(options.style));}}}}});GEarthExtensions.prototype.dom.buildPointPlacemark=domBuilder_({base:GEarthExtensions.prototype.dom.buildPlacemark,defaultProperty:'point'});GEarthExtensions.prototype.dom.buildLineStringPlacemark=domBuilder_({base:GEarthExtensions.prototype.dom.buildPlacemark,defaultProperty:'lineString'});GEarthExtensions.prototype.dom.buildPolygonPlacemark=domBuilder_({base:GEarthExtensions.prototype.dom.buildPlacemark,defaultProperty:'polygon'});GEarthExtensions.prototype.dom.buildNetworkLink=domBuilder_({apiInterface:'KmlNetworkLink',base:GEarthExtensions.prototype.dom.buildFeature_,apiFactoryFn:'createNetworkLink',defaultProperty:'link',propertySpec:{link:ALLOWED_,flyToView:AUTO_,refreshVisibility:AUTO_},constructor:function(networkLinkObj,options){if(options.link){networkLinkObj.setLink(this.dom.buildLink(options.link));}}});GEarthExtensions.prototype.dom.buildContainer_=domBuilder_({base:GEarthExtensions.prototype.dom.buildFeature_,propertySpec:{children:ALLOWED_},constructor:function(containerObj,options){if(options.children){for(var i=0;i<options.children.length;i++){containerObj.getFeatures().appendChild(options.children[i]);}}}});GEarthExtensions.prototype.dom.buildFolder=domBuilder_({apiInterface:'KmlFolder',base:GEarthExtensions.prototype.dom.buildContainer_,apiFactoryFn:'createFolder',defaultProperty:'children'});GEarthExtensions.prototype.dom.buildDocument=domBuilder_({apiInterface:'KmlDocument',base:GEarthExtensions.prototype.dom.buildContainer_,apiFactoryFn:'createDocument',defaultProperty:'children'});GEarthExtensions.prototype.dom.buildOverlay_=domBuilder_({base:GEarthExtensions.prototype.dom.buildFeature_,propertySpec:{color:ALLOWED_,icon:ALLOWED_,drawOrder:AUTO_},constructor:function(overlayObj,options){if(options.color){overlayObj.getColor().set(this.util.parseColor(options.color));}
if(options.icon){var icon=this.pluginInstance.createIcon('');overlayObj.setIcon(icon);if(typeof options.icon=='string'){icon.setHref(options.icon);}}}});GEarthExtensions.prototype.dom.buildGroundOverlay=domBuilder_({apiInterface:'KmlGroundOverlay',base:GEarthExtensions.prototype.dom.buildOverlay_,apiFactoryFn:'createGroundOverlay',defaultProperty:'icon',propertySpec:{box:REQUIRED_,altitude:AUTO_,altitudeMode:AUTO_},constructor:function(groundOverlayObj,options){if(options.box){var box=this.pluginInstance.createLatLonBox('');box.setBox(options.box.north,options.box.south,options.box.east,options.box.west,options.box.rotation?options.box.rotation:0);groundOverlayObj.setLatLonBox(box);}}});GEarthExtensions.prototype.dom.buildScreenOverlay=domBuilder_({apiInterface:'KmlScreenOverlay',base:GEarthExtensions.prototype.dom.buildOverlay_,apiFactoryFn:'createScreenOverlay',defaultProperty:'icon',propertySpec:{screenXY:REQUIRED_,size:REQUIRED_,rotation:AUTO_,overlayXY:{left:0,top:0},rotationXY:ALLOWED_},constructor:function(screenOverlayObj,options){this.dom.setVec2(screenOverlayObj.getScreenXY(),options.overlayXY);this.dom.setVec2(screenOverlayObj.getOverlayXY(),options.screenXY);this.dom.setVec2(screenOverlayObj.getSize(),options.size);if('rotationXY'in options){this.dom.setVec2(screenOverlayObj.getRotationXY(),options.rotationXY);}}});var autoDomAdd_=['Placemark','PointPlacemark','LineStringPlacemark','PolygonPlacemark','Folder','NetworkLink','GroundOverlay','ScreenOverlay','Style'];for(var i=0;i<autoDomAdd_.length;i++){GEarthExtensions.prototype.dom['add'+autoDomAdd_[i]]=function(shortcutBase){return function(){var obj=this.dom['build'+shortcutBase].apply(null,arguments);this.pluginInstance.getFeatures().appendChild(obj);return obj;};}(autoDomAdd_[i]);}
GEarthExtensions.prototype.dom.buildExtrudableGeometry_=domBuilder_({propertySpec:{altitudeMode:AUTO_,extrude:AUTO_,tessellate:AUTO_}});GEarthExtensions.prototype.dom.buildPoint=domBuilder_({apiInterface:'KmlPoint',base:GEarthExtensions.prototype.dom.buildExtrudableGeometry_,apiFactoryFn:'createPoint',defaultProperty:'point',propertySpec:{point:REQUIRED_},constructor:function(pointObj,options){var point=new geo.Point(options.point);pointObj.set(point.lat(),point.lng(),point.altitude(),('altitudeMode'in options)?options.altitudeMode:point.altitudeMode(),false,false);}});GEarthExtensions.prototype.dom.buildLineString=domBuilder_({apiInterface:'KmlLineString',base:GEarthExtensions.prototype.dom.buildExtrudableGeometry_,apiFactoryFn:'createLineString',defaultProperty:'path',propertySpec:{path:REQUIRED_},constructor:function(lineStringObj,options){var coordsObj=lineStringObj.getCoordinates();var path=new geo.Path(options.path);var numCoords=path.numCoords();for(var i=0;i<numCoords;i++){coordsObj.pushLatLngAlt(path.coord(i).lat(),path.coord(i).lng(),path.coord(i).altitude());}}});GEarthExtensions.prototype.dom.buildLinearRing=domBuilder_({apiInterface:'KmlLinearRing',base:GEarthExtensions.prototype.dom.buildLineString,apiFactoryFn:'createLinearRing',defaultProperty:'path',constructor:function(linearRingObj,options){}});GEarthExtensions.prototype.dom.buildPolygon=domBuilder_({apiInterface:'KmlPolygon',base:GEarthExtensions.prototype.dom.buildExtrudableGeometry_,apiFactoryFn:'createPolygon',defaultProperty:'polygon',propertySpec:{polygon:REQUIRED_},constructor:function(polygonObj,options){var polygon=new geo.Polygon(options.polygon);polygonObj.setOuterBoundary(this.dom.buildLinearRing(polygon.outerBoundary()));if(polygon.innerBoundaries().length){var innerBoundaries=polygon.innerBoundaries();for(var i=0;i<innerBoundaries.length;i++){polygonObj.getInnerBoundaries().appendChild(this.dom.buildLinearRing(innerBoundaries[i]));}}}});GEarthExtensions.prototype.dom.buildModel=domBuilder_({apiInterface:'KmlModel',apiFactoryFn:'createModel',defaultProperty:'link',propertySpec:{altitudeMode:AUTO_,link:ALLOWED_,location:ALLOWED_,scale:ALLOWED_,orientation:ALLOWED_},constructor:function(modelObj,options){if(options.link){modelObj.setLink(this.dom.buildLink(options.link));}
if(options.location){var pointObj=new geo.Point(options.location);var locationObj=this.pluginInstance.createLocation('');locationObj.setLatLngAlt(pointObj.lat(),pointObj.lng(),pointObj.altitude());modelObj.setLocation(locationObj);modelObj.setAltitudeMode(pointObj.altitudeMode());}
if(options.scale){var scaleObj=this.pluginInstance.createScale('');if(typeof options.scale=='number'){scaleObj.set(options.scale,options.scale,options.scale);}else if(geo.util.isArray(options.scale)){scaleObj.set(options.scale[0],options.scale[1],options.scale[2]);}
modelObj.setScale(scaleObj);}
if(options.orientation){var orientationObj=this.pluginInstance.createOrientation('');if('heading'in options.orientation&&'tilt'in options.orientation&&'roll'in options.orientation){orientationObj.set(options.orientation.heading,options.orientation.tilt,options.orientation.roll);}
modelObj.setOrientation(orientationObj);}}});GEarthExtensions.prototype.dom.buildMultiGeometry=domBuilder_({apiInterface:'KmlMultiGeometry',apiFactoryFn:'createMultiGeometry',defaultProperty:'geometries',propertySpec:{geometries:ALLOWED_},constructor:function(multiGeometryObj,options){var geometriesObj=multiGeometryObj.getGeometries();if(geo.util.isArray(options.geometries)){for(var i=0;i<options.geometries.length;i++){geometriesObj.appendChild(options.geometries[i]);}}}});GEarthExtensions.prototype.dom.buildLink=domBuilder_({apiInterface:'KmlLink',apiFactoryFn:'createLink',defaultProperty:'href',propertySpec:{href:AUTO_,refreshMode:AUTO_,refreshInterval:AUTO_,viewRefreshMode:AUTO_,viewBoundScale:AUTO_}});GEarthExtensions.prototype.dom.buildRegion=domBuilder_({apiInterface:'KmlRegion',apiFactoryFn:'createRegion',propertySpec:{box:REQUIRED_,lod:ALLOWED_},constructor:function(regionObj,options){var box=this.pluginInstance.createLatLonAltBox('');if(options.box.center&&options.box.span){if(!geo.util.isArray(options.box.span)&&typeof options.box.span==='number'){options.box.span=[options.box.span,options.box.span];}
var center=new geo.Point(options.box.center);options.box.north=center.lat()+options.box.span[0]/2;options.box.south=center.lat()-options.box.span[0]/2;options.box.east=center.lng()+options.box.span[1]/2;options.box.west=center.lng()-options.box.span[1]/2;}
box.setAltBox(options.box.north,options.box.south,options.box.east,options.box.west,options.box.rotation||0,options.box.minAltitude||0,options.box.maxAltitude||0,options.box.altitudeMode||this.pluginInstance.ALTITUDE_CLAMP_TO_GROUND);var lod=this.pluginInstance.createLod('');lod.set(-1,-1,0,0);if(options.lod&&geo.util.isArray(options.lod)){if(options.lod.length==2){lod.set(options.lod[0],options.lod[1],0,0);}else if(options.lod.length==4){lod.set(options.lod[0],options.lod[3],options.lod[1],options.lod[2]);}else{}}
regionObj.setLatLonAltBox(box);regionObj.setLod(lod);}});GEarthExtensions.prototype.dom.buildStyle=domBuilder_({apiInterface:['KmlStyle','KmlStyleMap'],apiFactoryFn:'createStyle',propertySpec:{icon:ALLOWED_,label:ALLOWED_,line:ALLOWED_,poly:ALLOWED_,balloon:ALLOWED_},constructor:function(styleObj,options){var pad2=function(s){return((s.length<2)?'0':'')+s;};var me=this;var mergeColorOpacity_=function(color,opacity){color=color?me.util.parseColor(color):'ffffffff';if(!geo.util.isUndefined(opacity)){color=pad2(Math.floor(255*opacity).toString(16))+
color.substring(2);}
return color;};if(options.icon){var iconStyle=styleObj.getIconStyle();if(typeof options.icon=='string'){options.icon={href:options.icon};}
var icon=this.pluginInstance.createIcon('');iconStyle.setIcon(icon);if('href'in options.icon){icon.setHref(options.icon.href);}else if('stockIcon'in options.icon){icon.setHref('http://maps.google.com/mapfiles/kml/'+
options.icon.stockIcon+'.png');}else{icon.setHref('http://maps.google.com/mapfiles/kml/'+'paddle/wht-blank.png');iconStyle.getHotSpot().set(0.5,this.pluginInstance.UNITS_FRACTION,0,this.pluginInstance.UNITS_FRACTION);}
if('scale'in options.icon){iconStyle.setScale(options.icon.scale);}
if('heading'in options.icon){iconStyle.setHeading(options.icon.heading);}
if('color'in options.icon||'opacity'in options.icon){options.icon.color=mergeColorOpacity_(options.icon.color,options.icon.opacity);iconStyle.getColor().set(options.icon.color);}
if('opacity'in options.icon){if(!('color'in options.icon)){options.icon.color='ffffffff';}
options.icon.color=pad2(options.icon.opacity.toString(16))+
options.icon.color.substring(2);}
if('hotSpot'in options.icon){this.dom.setVec2(iconStyle.getHotSpot(),options.icon.hotSpot);}}
if(options.label){var labelStyle=styleObj.getLabelStyle();if(typeof options.label=='string'){options.label={color:options.label};}
if('scale'in options.label){labelStyle.setScale(options.label.scale);}
if('color'in options.label||'opacity'in options.label){options.label.color=mergeColorOpacity_(options.label.color,options.label.opacity);labelStyle.getColor().set(options.label.color);}}
if(options.line){var lineStyle=styleObj.getLineStyle();if(typeof options.line=='string'){options.line={color:options.line};}
if('width'in options.line){lineStyle.setWidth(options.line.width);}
if('color'in options.line||'opacity'in options.line){options.line.color=mergeColorOpacity_(options.line.color,options.line.opacity);lineStyle.getColor().set(options.line.color);}}
if(options.poly){var polyStyle=styleObj.getPolyStyle();if(typeof options.poly=='string'){options.poly={color:options.poly};}
if('fill'in options.poly){polyStyle.setFill(options.poly.fill);}
if('outline'in options.poly){polyStyle.setOutline(options.poly.outline);}
if('color'in options.poly||'opacity'in options.poly){options.poly.color=mergeColorOpacity_(options.poly.color,options.poly.opacity);polyStyle.getColor().set(options.poly.color);}}
if(options.balloon){var balloonStyle=styleObj.getBalloonStyle();if(typeof options.balloon=='string'){options.balloon={bgColor:options.balloon};}
if('bgColor'in options.balloon){balloonStyle.getBgColor().set(me.util.parseColor(options.balloon.bgColor));}
if('textColor'in options.balloon){balloonStyle.getTextColor().set(me.util.parseColor(options.balloon.textColor));}
if('text'in options.balloon){balloonStyle.setText(options.balloon.text);}}}});GEarthExtensions.prototype.dom.clearFeatures=function(){var featureContainer=this.pluginInstance.getFeatures();var c;while((c=featureContainer.getLastChild())!==null){featureContainer.removeChild(c);}};GEarthExtensions.prototype.dom.walk=function(){var options;if(arguments.length==1){if(geo.util.isObjectLiteral(arguments[0])){options=arguments[0];}else if(geo.util.isFunction(arguments[0])){options={visitCallback:arguments[0]};}else{throw new TypeError('walk requires a visit callback function or '+'options literal as a first parameter');}}else{throw new Error('walk takes at most 1 arguments');}
options=checkParameters_(options,false,{visitCallback:REQUIRED_,features:true,geometries:false,rootObject:this.pluginInstance,rootContext:ALLOWED_});var recurse_=function(object,currentContext){var contextArgument={current:currentContext,child:currentContext,walkChildren:true};var retValue=options.visitCallback.call(object,contextArgument);if(!retValue&&!geo.util.isUndefined(retValue)){return false;}
if(!contextArgument.walkChildren){return true;}
var objectContainer=null;if('getFeatures'in object){if(options.features){objectContainer=object.getFeatures();}}else if('getGeometry'in object){if(options.geometries&&object.getGeometry()){recurse_(object.getGeometry(),contextArgument.child);}}else if('getGeometries'in object){if(options.geometries){objectContainer=object.getGeometries();}}else if('getOuterBoundary'in object){if(options.geometries&&object.getOuterBoundary()){recurse_(object.getOuterBoundary(),contextArgument.child);objectContainer=object.getInnerBoundaries();}}
if(objectContainer&&objectContainer.hasChildNodes()){var childNodes=objectContainer.getChildNodes();var numChildNodes=childNodes.getLength();for(var i=0;i<numChildNodes;i++){var child=childNodes.item(i);if(!recurse_(child,contextArgument.child)){return false;}}}
return true;};if(options.rootObject){recurse_(options.rootObject,options.rootContext);}};GEarthExtensions.prototype.dom.getObjectById=function(id,options){options=checkParameters_(options,false,{recursive:true,rootObject:this.pluginInstance});if('getId'in options.rootObject&&options.rootObject.getId()==id){return options.rootObject;}
var returnObject=null;this.dom.walk({rootObject:options.rootObject,features:true,geometries:true,visitCallback:function(){if('getId'in this&&this.getId()==id){returnObject=this;return false;}}});return returnObject;};GEarthExtensions.prototype.dom.removeObject=function(object){if(!object){return;}
var parent=object.getParentNode();if(!parent){throw new Error('Cannot remove an object without a parent.');}
var objectContainer=null;if('getFeatures'in parent){objectContainer=parent.getFeatures();}else if('getGeometries'in parent){objectContainer=parent.getGeometries();}else if('getInnerBoundaries'in parent){objectContainer=parent.getInnerBoundaries();}
objectContainer.removeChild(object);};GEarthExtensions.prototype.dom.setVec2=function(vec2,options){if('getType'in options&&options.getType()=='KmlVec2'){vec2.set(options.getX(),options.getXUnits(),options.getY(),options.getYUnits());return;}
options=checkParameters_(options,false,{left:ALLOWED_,top:ALLOWED_,right:ALLOWED_,bottom:ALLOWED_,width:ALLOWED_,height:ALLOWED_});if('width'in options){options.left=options.width;}
if('height'in options){options.bottom=options.height;}
var x=0.0;var xUnits=this.pluginInstance.UNITS_PIXELS;var y=0.0;var yUnits=this.pluginInstance.UNITS_PIXELS;if('left'in options){if(typeof options.left=='number'){x=options.left;}else if(typeof options.left=='string'&&options.left.charAt(options.left.length-1)=='%'){x=parseFloat(options.left)/100;xUnits=this.pluginInstance.UNITS_FRACTION;}else{throw new TypeError('left must be a number or string indicating a '+'percentage');}}else if('right'in options){if(typeof options.right=='number'){x=options.right;xUnits=this.pluginInstance.UNITS_INSET_PIXELS;}else if(typeof options.right=='string'&&options.right.charAt(options.right.length-1)=='%'){x=1.0-parseFloat(options.right)/100;xUnits=this.pluginInstance.UNITS_FRACTION;}else{throw new TypeError('right must be a number or string indicating a '+'percentage');}}
if('bottom'in options){if(typeof options.bottom=='number'){y=options.bottom;}else if(typeof options.bottom=='string'&&options.bottom.charAt(options.bottom.length-1)=='%'){y=parseFloat(options.bottom)/100;yUnits=this.pluginInstance.UNITS_FRACTION;}else{throw new TypeError('bottom must be a number or string indicating a '+'percentage');}}else if('top'in options){if(typeof options.top=='number'){y=options.top;yUnits=this.pluginInstance.UNITS_INSET_PIXELS;}else if(typeof options.top=='string'&&options.top.charAt(options.top.length-1)=='%'){y=1.0-parseFloat(options.top)/100;yUnits=this.pluginInstance.UNITS_FRACTION;}else{throw new TypeError('top must be a number or string indicating a '+'percentage');}}
vec2.set(x,xUnits,y,yUnits);};GEarthExtensions.prototype.dom.computeBounds=function(object){var bounds=new geo.Bounds();this.dom.walk({rootObject:object,features:true,geometries:true,visitCallback:function(){if('getType'in this){var type=this.getType();switch(type){case'KmlGroundOverlay':var llb=this.getLatLonBox();if(llb){var alt=this.getAltitude();bounds.extend(new geo.Point(llb.getNorth(),llb.getEast(),alt));bounds.extend(new geo.Point(llb.getNorth(),llb.getWest(),alt));bounds.extend(new geo.Point(llb.getSouth(),llb.getEast(),alt));bounds.extend(new geo.Point(llb.getSouth(),llb.getWest(),alt));}
break;case'KmlModel':bounds.extend(new geo.Point(this.getLocation()));break;case'KmlLinearRing':case'KmlLineString':var coords=this.getCoordinates();if(coords){var n=coords.getLength();for(var i=0;i<n;i++){bounds.extend(new geo.Point(coords.get(i)));}}
break;case'KmlCoord':case'KmlLocation':case'KmlPoint':bounds.extend(new geo.Point(this));break;}}}});return bounds;};GEarthExtensions.prototype.dom.buildLookAt=domBuilder_({apiInterface:'KmlLookAt',apiFactoryFn:'createLookAt',defaultProperty:'point',propertySpec:{copy:false,point:REQUIRED_,heading:ALLOWED_,tilt:ALLOWED_,range:ALLOWED_},constructor:function(lookAtObj,options){var point=new geo.Point(options.point);var defaults={heading:0,tilt:0,range:1000};if(options.copy){var currentLookAt=this.util.getLookAt(defaults.altitudeMode);defaults.heading=currentLookAt.getHeading();defaults.tilt=currentLookAt.getTilt();defaults.range=currentLookAt.getRange();}
options=checkParameters_(options,true,defaults);lookAtObj.set(point.lat(),point.lng(),point.altitude(),point.altitudeMode(),options.heading,options.tilt,options.range);}});GEarthExtensions.prototype.dom.buildCamera=domBuilder_({apiInterface:'KmlCamera',apiFactoryFn:'createCamera',defaultProperty:'point',propertySpec:{copy:false,point:REQUIRED_,heading:ALLOWED_,tilt:ALLOWED_,roll:ALLOWED_},constructor:function(cameraObj,options){var point=new geo.Point(options.point);var defaults={heading:0,tilt:0,roll:0};if(options.copy){var currentCamera=this.util.getCamera(defaults.altitudeMode);defaults.heading=currentCamera.getHeading();defaults.tilt=currentCamera.getTilt();defaults.roll=currentCamera.getRoll();}
options=checkParameters_(options,true,defaults);cameraObj.set(point.lat(),point.lng(),point.altitude(),point.altitudeMode(),options.heading,options.tilt,options.roll);}});GEarthExtensions.prototype.edit={isnamespace_:true};var DRAGDATA_JSDATA_KEY='_GEarthExtensions_dragData';var currentDragContext_=null;function beginDragging_(extInstance,placemark){var placemarkDragData=extInstance.util.getJsDataValue(placemark,DRAGDATA_JSDATA_KEY)||{};currentDragContext_={placemark:placemark,startAltitude:placemark.getGeometry().getAltitude(),draggableOptions:placemarkDragData.draggableOptions,dragged:false};}
function makeMouseMoveListener_(extInstance){return function(event){if(currentDragContext_){event.preventDefault();if(!event.getDidHitGlobe()){return;}
if(!currentDragContext_.dragged){currentDragContext_.dragged=true;if(currentDragContext_.draggableOptions.draggingStyle){currentDragContext_.oldStyle=currentDragContext_.placemark.getStyleSelector();currentDragContext_.placemark.setStyleSelector(extInstance.dom.buildStyle(currentDragContext_.draggableOptions.draggingStyle));}
if(currentDragContext_.draggableOptions.bounce){extInstance.fx.cancel(currentDragContext_.placemark);extInstance.fx.bounce(currentDragContext_.placemark,{phase:1});}
if(currentDragContext_.draggableOptions.targetScreenOverlay){var overlay=extInstance.dom.buildScreenOverlay(currentDragContext_.draggableOptions.targetScreenOverlay);extInstance.pluginInstance.getFeatures().appendChild(overlay);currentDragContext_.activeTargetScreenOverlay=overlay;}}
if(currentDragContext_.activeTargetScreenOverlay){extInstance.dom.setVec2(currentDragContext_.activeTargetScreenOverlay.getOverlayXY(),{left:event.getClientX(),top:event.getClientY()});}
var point=currentDragContext_.placemark.getGeometry();point.setLatitude(event.getLatitude());point.setLongitude(event.getLongitude());currentDragContext_.placemark.setVisibility(true);if(currentDragContext_.draggableOptions.dragCallback){currentDragContext_.draggableOptions.dragCallback.call(currentDragContext_.placemark);}}};}
function stopDragging_(extInstance,abort){if(currentDragContext_){if(currentDragContext_.dragged){if(currentDragContext_.oldStyle){currentDragContext_.placemark.setStyleSelector(currentDragContext_.oldStyle);delete currentDragContext_.oldStyle;}
if(currentDragContext_.activeTargetScreenOverlay){extInstance.pluginInstance.getFeatures().removeChild(currentDragContext_.activeTargetScreenOverlay);delete currentDragContext_.activeTargetScreenOverlay;}
if(currentDragContext_.draggableOptions.bounce){extInstance.fx.cancel(currentDragContext_.placemark);extInstance.fx.bounce(currentDragContext_.placemark,{startAltitude:currentDragContext_.startAltitude,phase:2,repeat:1,dampen:0.3});}}
var dragContext_=currentDragContext_;currentDragContext_=null;if(dragContext_.dragged&&dragContext_.draggableOptions.dropCallback&&!abort){dragContext_.draggableOptions.dropCallback.call(dragContext_.placemark);}}}
GEarthExtensions.prototype.edit.makeDraggable=function(placemark,options){this.edit.endDraggable(placemark);options=checkParameters_(options,false,{bounce:true,dragCallback:ALLOWED_,dropCallback:ALLOWED_,draggingStyle:ALLOWED_,targetScreenOverlay:ALLOWED_});var me=this;var mouseMoveListener=makeMouseMoveListener_(me);var mouseUpListener;mouseUpListener=function(event){if(currentDragContext_&&event.getButton()===0){google.earth.removeEventListener(me.pluginInstance.getWindow(),'mousemove',mouseMoveListener);google.earth.removeEventListener(me.pluginInstance.getWindow(),'mouseup',mouseUpListener);if(currentDragContext_.dragged){event.preventDefault();}
stopDragging_(me);}};var mouseDownListener=function(event){if(event.getButton()===0){beginDragging_(me,event.getTarget());google.earth.addEventListener(me.pluginInstance.getWindow(),'mousemove',mouseMoveListener);google.earth.addEventListener(me.pluginInstance.getWindow(),'mouseup',mouseUpListener);}};this.util.setJsDataValue(placemark,DRAGDATA_JSDATA_KEY,{draggableOptions:options,abortAndEndFn:function(){if(currentDragContext_&&currentDragContext_.placemark.equals(placemark)){google.earth.removeEventListener(me.pluginInstance.getWindow(),'mousemove',mouseMoveListener);google.earth.removeEventListener(me.pluginInstance.getWindow(),'mouseup',mouseUpListener);stopDragging_(me,true);}
google.earth.removeEventListener(placemark,'mousedown',mouseDownListener);}});google.earth.addEventListener(placemark,'mousedown',mouseDownListener);};GEarthExtensions.prototype.edit.endDraggable=function(placemark){var placemarkDragData=this.util.getJsDataValue(placemark,DRAGDATA_JSDATA_KEY);if(placemarkDragData){placemarkDragData.abortAndEndFn.call(null);this.util.clearJsDataValue(placemark,DRAGDATA_JSDATA_KEY);}};GEarthExtensions.prototype.edit.place=function(placemark,options){options=checkParameters_(options,false,{bounce:true,dragCallback:ALLOWED_,dropCallback:ALLOWED_,draggingStyle:ALLOWED_,targetScreenOverlay:ALLOWED_});var me=this;var mouseMoveListener=makeMouseMoveListener_(me);placemark.setVisibility(false);var mouseDownListener;mouseDownListener=function(event){if(currentDragContext_&&event.getButton()===0){event.preventDefault();event.stopPropagation();google.earth.removeEventListener(me.pluginInstance.getWindow(),'mousemove',mouseMoveListener);google.earth.removeEventListener(me.pluginInstance.getWindow(),'mousedown',mouseDownListener);stopDragging_(me);}};this.util.setJsDataValue(placemark,DRAGDATA_JSDATA_KEY,{draggableOptions:options,abortAndEndFn:function(){if(currentDragContext_&&currentDragContext_.placemark.equals(placemark)){google.earth.removeEventListener(me.pluginInstance.getWindow(),'mousemove',mouseMoveListener);google.earth.removeEventListener(me.pluginInstance.getWindow(),'mousedown',mouseDownListener);stopDragging_(me,true);}}});beginDragging_(me,placemark);google.earth.addEventListener(me.pluginInstance.getWindow(),'mousemove',mouseMoveListener);google.earth.addEventListener(me.pluginInstance.getWindow(),'mousedown',mouseDownListener);};var LINESTRINGEDITDATA_JSDATA_KEY='_GEarthExtensions_lineStringEditData';var LINESTRING_COORD_ICON='http://maps.google.com/mapfiles/kml/'+'shapes/placemark_circle.png';var LINESTRING_COORD_ICON_SCALE=0.85;var LINESTRING_MIDPOINT_ICON_SCALE=0.6;function coordsEqual_(coord1,coord2){return coord1.getLatitude()==coord2.getLatitude()&&coord1.getLongitude()==coord2.getLongitude()&&coord1.getAltitude()==coord2.getAltitude();}
GEarthExtensions.prototype.edit.drawLineString=function(lineString,options){options=checkParameters_(options,false,{bounce:true,drawCallback:ALLOWED_,finishCallback:ALLOWED_,ensureCounterClockwise:true});var lineStringEditData=this.util.getJsDataValue(lineString,LINESTRINGEDITDATA_JSDATA_KEY)||{};if(lineStringEditData){this.edit.endEditLineString(lineString);}
var me=this;var isReverse=false;var tempPoly=new geo.Polygon();var done=false;var placemarks=[];var altitudeMode=lineString.getAltitudeMode();var headPlacemark=null;var isRing=(lineString.getType()=='KmlLinearRing');var coords=lineString.getCoordinates();var innerDoc=this.pluginInstance.parseKml(['<Document>','<Style id="_GEarthExtensions_regularCoordinate"><IconStyle>','<Icon><href>',LINESTRING_COORD_ICON,'</href></Icon>','<scale>',LINESTRING_COORD_ICON_SCALE,'</scale></IconStyle></Style>','<Style id="_GEarthExtensions_firstCoordinateHighlight"><IconStyle>','<Icon><href>',LINESTRING_COORD_ICON,'</href></Icon>','<scale>',LINESTRING_COORD_ICON_SCALE*1.3,'</scale>','<color>ff00ff00</color></IconStyle></Style>','<StyleMap id="_GEarthExtensions_firstCoordinate">','<Pair><key>normal</key>','<styleUrl>#_GEarthExtensions_regularCoordinate</styleUrl>','</Pair><Pair><key>highlight</key>','<styleUrl>#_GEarthExtensions_firstCoordinateHighlight</styleUrl>','</Pair></StyleMap>','</Document>'].join(''));var finishListener;var endFunction=function(abort){google.earth.removeEventListener(me.pluginInstance.getWindow(),'dblclick',finishListener);var numCoords=coords.getLength();if(numCoords&&isRing){var firstCoord=coords.get(0);var lastCoord=coords.get(numCoords-1);if(!coordsEqual_(firstCoord,lastCoord)){coords.pushLatLngAlt(firstCoord.getLatitude(),firstCoord.getLongitude(),firstCoord.getAltitude());}}
me.edit.endDraggable(headPlacemark);me.dom.removeObject(innerDoc);me.util.clearJsDataValue(lineString,LINESTRINGEDITDATA_JSDATA_KEY);placemarks=[];done=true;if(options.finishCallback&&!abort){options.finishCallback.call(null);}};finishListener=function(event){event.preventDefault();endFunction.call(null);};var drawNext;drawNext=function(){headPlacemark=me.dom.buildPointPlacemark([0,0],{altitudeMode:altitudeMode,style:'#_GEarthExtensions_regularCoordinate',visibility:false});innerDoc.getFeatures().appendChild(headPlacemark);if(isReverse){placemarks.unshift(headPlacemark);}else{placemarks.push(headPlacemark);}
me.edit.place(headPlacemark,{bounce:options.bounce,dropCallback:function(){if(!done){var coord=[headPlacemark.getGeometry().getLatitude(),headPlacemark.getGeometry().getLongitude(),0];if(isReverse){coords.unshiftLatLngAlt(coord[0],coord[1],coord[2]);}else{coords.pushLatLngAlt(coord[0],coord[1],coord[2]);}
if(options.ensureCounterClockwise){if(isReverse){tempPoly.outerBoundary().prepend(coord);}else{tempPoly.outerBoundary().append(coord);}
if(!tempPoly.isCounterClockwise()){tempPoly.outerBoundary().reverse();coords.reverse();isReverse=!isReverse;}}
if(options.drawCallback){options.drawCallback.call(null,isReverse?0:coords.getLength()-1);}
if(placemarks.length==1){placemarks[0].setStyleUrl('#_GEarthExtensions_firstCoordinate');google.earth.addEventListener(placemarks[0],'mousedown',function(firstCoord){return function(event){if(isReverse){coords.unshiftLatLngAlt(firstCoord[0],firstCoord[1],firstCoord[2]);}else{coords.pushLatLngAlt(firstCoord[0],firstCoord[1],firstCoord[2]);}
finishListener(event);};}(coord));}
setTimeout(drawNext,0);}}});};drawNext.call(null);google.earth.addEventListener(me.pluginInstance.getWindow(),'dblclick',finishListener);this.pluginInstance.getFeatures().appendChild(innerDoc);this.util.setJsDataValue(lineString,LINESTRINGEDITDATA_JSDATA_KEY,{abortAndEndFn:function(){endFunction.call(null,true);}});};GEarthExtensions.prototype.edit.editLineString=function(lineString,options){options=checkParameters_(options,false,{editCallback:ALLOWED_});var lineStringEditData=this.util.getJsDataValue(lineString,LINESTRINGEDITDATA_JSDATA_KEY)||{};if(lineStringEditData){this.edit.endEditLineString(lineString);}
var me=this;var isRing=(lineString.getType()=='KmlLinearRing');var altitudeMode=lineString.getAltitudeMode();var coords=lineString.getCoordinates();var numCoords=coords.getLength();if(numCoords&&isRing){var firstCoord=coords.get(0);var lastCoord=coords.get(numCoords-1);if(!coordsEqual_(firstCoord,lastCoord)){coords.pushLatLngAlt(firstCoord.getLatitude(),firstCoord.getLongitude(),firstCoord.getAltitude());numCoords++;}}
var innerDoc=this.pluginInstance.parseKml(['<Document>','<Style id="_GEarthExtensions_regularCoordinate"><IconStyle>','<Icon><href>',LINESTRING_COORD_ICON,'</href></Icon>','<color>ffffffff</color>','<scale>',LINESTRING_COORD_ICON_SCALE,'</scale></IconStyle></Style>','<StyleMap id="_GEarthExtensions_midCoordinate">','<Pair><key>normal</key>','<Style><IconStyle>','<Icon><href>',LINESTRING_COORD_ICON,'</href></Icon>','<color>60ffffff</color><scale>',LINESTRING_MIDPOINT_ICON_SCALE,'</scale></IconStyle></Style></Pair>','<Pair><key>highlight</key>','<styleUrl>#_GEarthExtensions_regularCoordinate</styleUrl>','</Pair></StyleMap>','</Document>'].join(''));var coordDataArr=[];var checkDupMidpoints_=function(){if(!isRing){return;}
if(numCoords==3){coordDataArr[1].rightMidPlacemark.setVisibility(false);}else if(numCoords>=4){coordDataArr[numCoords-2].rightMidPlacemark.setVisibility(true);}};var makeRegularDeleteEventListener_=function(coordData){return function(event){event.preventDefault();var leftCoordData=null;if(coordData.index>0||isRing){var leftIndex=coordData.index-1;if(leftIndex<0){leftIndex+=numCoords;}
if(isRing&&coordData.index===0){leftIndex--;}
leftCoordData=coordDataArr[leftIndex];}
for(i=coordData.index;i<numCoords-1;i++){coords.set(i,coords.get(i+1));}
coords.pop();if(isRing&&coordData.index===0){coords.set(numCoords-2,coords.get(0));}
numCoords--;if(!coordData.rightMidPlacemark&&leftCoordData){me.edit.endDraggable(leftCoordData.rightMidPlacemark);me.dom.removeObject(leftCoordData.rightMidPlacemark);leftCoordData.rightMidPlacemark=null;}
if(coordData.rightMidPlacemark){me.edit.endDraggable(coordData.rightMidPlacemark);me.dom.removeObject(coordData.rightMidPlacemark);}
me.edit.endDraggable(coordData.regularPlacemark);google.earth.removeEventListener(coordData.regularPlacemark,'dblclick',coordData.deleteEventListener);me.dom.removeObject(coordData.regularPlacemark);coordDataArr.splice(coordData.index,1);for(i=0;i<numCoords;i++){coordDataArr[i].index=i;}
if(leftCoordData){leftCoordData.regularDragCallback.call(leftCoordData.regularPlacemark,leftCoordData);}
checkDupMidpoints_();if(options.editCallback){options.editCallback(null);}};};var makeRegularDragCallback_=function(coordData){return function(){coords.setLatLngAlt(coordData.index,this.getGeometry().getLatitude(),this.getGeometry().getLongitude(),this.getGeometry().getAltitude());if(isRing&&numCoords>=2&&coordData.index===0){var firstCoord=coords.get(0);var lastCoord=coords.get(numCoords-1);coords.setLatLngAlt(0,this.getGeometry().getLatitude(),this.getGeometry().getLongitude(),this.getGeometry().getAltitude());coords.setLatLngAlt(numCoords-1,this.getGeometry().getLatitude(),this.getGeometry().getLongitude(),this.getGeometry().getAltitude());}
var curCoord=coords.get(coordData.index);if(coordData.index>0||isRing){var leftIndex=coordData.index-1;if(leftIndex<0){leftIndex+=numCoords;}
if(isRing&&coordData.index===0){leftIndex--;}
var leftMidPt=new geo.Point(coords.get(leftIndex)).midpoint(new geo.Point(curCoord));coordDataArr[leftIndex].rightMidPlacemark.getGeometry().setLatitude(leftMidPt.lat());coordDataArr[leftIndex].rightMidPlacemark.getGeometry().setLongitude(leftMidPt.lng());coordDataArr[leftIndex].rightMidPlacemark.getGeometry().setAltitude(leftMidPt.altitude());}
if(coordData.index<numCoords-1||isRing){var rightCoord;if((isRing&&coordData.index==numCoords-2)||(!isRing&&coordData.index==numCoords-1)){rightCoord=coords.get(0);}else{rightCoord=coords.get(coordData.index+1);}
var rightMidPt=new geo.Point(curCoord).midpoint(new geo.Point(rightCoord));coordData.rightMidPlacemark.getGeometry().setLatitude(rightMidPt.lat());coordData.rightMidPlacemark.getGeometry().setLongitude(rightMidPt.lng());coordData.rightMidPlacemark.getGeometry().setAltitude(rightMidPt.altitude());}
checkDupMidpoints_();if(options.editCallback){options.editCallback(null);}};};var makeMidDragCallback_=function(coordData){var convertedToRegular=false;var newCoordData=null;return function(){if(!convertedToRegular){convertedToRegular=true;var i;this.setStyleUrl('#_GEarthExtensions_regularCoordinate');coords.push(coords.get(numCoords-1));for(i=numCoords-1;i>coordData.index+1;i--){coords.set(i,coords.get(i-1));}
numCoords++;newCoordData={};newCoordData.index=coordData.index+1;newCoordData.regularPlacemark=this;coordData.rightMidPlacemark=me.dom.buildPointPlacemark({point:coords.get(coordData.index),altitudeMode:altitudeMode,style:'#_GEarthExtensions_midCoordinate'});innerDoc.getFeatures().appendChild(coordData.rightMidPlacemark);me.edit.makeDraggable(coordData.rightMidPlacemark,{bounce:false,dragCallback:makeMidDragCallback_(coordData)});newCoordData.rightMidPlacemark=me.dom.buildPointPlacemark({point:coords.get(coordData.index),altitudeMode:altitudeMode,style:'#_GEarthExtensions_midCoordinate'});innerDoc.getFeatures().appendChild(newCoordData.rightMidPlacemark);me.edit.makeDraggable(newCoordData.rightMidPlacemark,{bounce:false,dragCallback:makeMidDragCallback_(newCoordData)});newCoordData.deleteEventListener=makeRegularDeleteEventListener_(newCoordData);google.earth.addEventListener(this,'dblclick',newCoordData.deleteEventListener);newCoordData.regularDragCallback=makeRegularDragCallback_(newCoordData);coordDataArr.splice(newCoordData.index,0,newCoordData);for(i=0;i<numCoords;i++){coordDataArr[i].index=i;}}
newCoordData.regularDragCallback.call(this,newCoordData);};};me.util.batchExecute(function(){for(var i=0;i<numCoords;i++){var curCoord=coords.get(i);var nextCoord=coords.get((i+1)%numCoords);var coordData={};coordDataArr.push(coordData);coordData.index=i;if(isRing&&i==numCoords-1){continue;}
coordData.regularPlacemark=me.dom.buildPointPlacemark(curCoord,{altitudeMode:altitudeMode,style:'#_GEarthExtensions_regularCoordinate'});innerDoc.getFeatures().appendChild(coordData.regularPlacemark);coordData.regularDragCallback=makeRegularDragCallback_(coordData);me.edit.makeDraggable(coordData.regularPlacemark,{bounce:false,dragCallback:coordData.regularDragCallback});coordData.deleteEventListener=makeRegularDeleteEventListener_(coordData);google.earth.addEventListener(coordData.regularPlacemark,'dblclick',coordData.deleteEventListener);if(i<numCoords-1||isRing){coordData.rightMidPlacemark=me.dom.buildPointPlacemark({point:new geo.Point(curCoord).midpoint(new geo.Point(nextCoord)),altitudeMode:altitudeMode,style:'#_GEarthExtensions_midCoordinate'});innerDoc.getFeatures().appendChild(coordData.rightMidPlacemark);me.edit.makeDraggable(coordData.rightMidPlacemark,{bounce:false,dragCallback:makeMidDragCallback_(coordData)});}}
checkDupMidpoints_();me.pluginInstance.getFeatures().appendChild(innerDoc);});me.util.setJsDataValue(lineString,LINESTRINGEDITDATA_JSDATA_KEY,{innerDoc:innerDoc,abortAndEndFn:function(){me.util.batchExecute(function(){var numCoords=coords.getLength();if(numCoords&&isRing){var firstCoord=coords.get(0);var lastCoord=coords.get(numCoords-1);if(!coordsEqual_(firstCoord,lastCoord)){coords.pushLatLngAlt(firstCoord.getLatitude(),firstCoord.getLongitude(),firstCoord.getAltitude());}}
for(var i=0;i<coordDataArr.length;i++){if(!coordDataArr[i].regularPlacemark){continue;}
google.earth.removeEventListener(coordDataArr[i].regularPlacemark,'dblclick',coordDataArr[i].deleteEventListener);me.edit.endDraggable(coordDataArr[i].regularPlacemark);if(coordDataArr[i].rightMidPlacemark){me.edit.endDraggable(coordDataArr[i].rightMidPlacemark);}}
me.dom.removeObject(innerDoc);});}});};GEarthExtensions.prototype.edit.endEditLineString=function(lineString){var lineStringEditData=this.util.getJsDataValue(lineString,LINESTRINGEDITDATA_JSDATA_KEY);if(lineStringEditData){lineStringEditData.abortAndEndFn.call(null);this.util.clearJsDataValue(lineString,LINESTRINGEDITDATA_JSDATA_KEY);}};GEarthExtensions.prototype.fx={isnamespace_:true};GEarthExtensions.prototype.fx.AnimationManager_=createClass_(function(){this.extInstance=arguments.callee.extInstance_;this.animations_=[];this.running_=false;this.globalTime_=0.0;});GEarthExtensions.prototype.fx.AnimationManager_.prototype.startAnimation=function(anim){this.animations_.push({obj:anim,startGlobalTime:this.globalTime_});this.start_();};GEarthExtensions.prototype.fx.AnimationManager_.prototype.stopAnimation=function(anim){for(var i=0;i<this.animations_.length;i++){if(this.animations_[i].obj==anim){this.animations_.splice(i,1);return;}}};GEarthExtensions.prototype.fx.AnimationManager_.prototype.start_=function(){if(this.running_){return;}
this.startTimeStamp_=Number(new Date());this.tick_();for(var i=0;i<this.animations_.length;i++){this.animations_[i].obj.renderFrame(0);}
var me=this;this.frameendListener_=function(){me.tick_();};this.tickInterval_=window.setInterval(this.frameendListener_,100);google.earth.addEventListener(this.extInstance.pluginInstance,'frameend',this.frameendListener_);this.running_=true;};GEarthExtensions.prototype.fx.AnimationManager_.prototype.stop_=function(){if(!this.running_){return;}
google.earth.removeEventListener(this.extInstance.pluginInstance,'frameend',this.frameendListener_);this.frameendListener_=null;window.clearInterval(this.tickInterval_);this.tickInterval_=null;this.running_=false;this.globalTime_=0.0;};GEarthExtensions.prototype.fx.AnimationManager_.prototype.tick_=function(){if(!this.running_){return;}
this.globalTime_=Number(new Date())-this.startTimeStamp_;this.renderCurrentFrame_();};GEarthExtensions.prototype.fx.AnimationManager_.prototype.renderCurrentFrame_=function(){for(var i=this.animations_.length-1;i>=0;i--){var animation=this.animations_[i];animation.obj.renderFrame(this.globalTime_-animation.startGlobalTime);}
if(this.animations_.length===0){this.stop_();}};GEarthExtensions.prototype.fx.getAnimationManager_=function(){if(!this.fx.animationManager_){this.fx.animationManager_=new this.fx.AnimationManager_();}
return this.fx.animationManager_;};GEarthExtensions.prototype.fx.Animation=createClass_(function(renderFn,completionFn){this.extInstance=arguments.callee.extInstance_;this.renderFn=renderFn;this.completionFn=completionFn||function(){};});GEarthExtensions.prototype.fx.Animation.prototype.start=function(){this.extInstance.fx.getAnimationManager_().startAnimation(this);};GEarthExtensions.prototype.fx.Animation.prototype.stop=function(completed){this.extInstance.fx.getAnimationManager_().stopAnimation(this);this.completionFn({cancelled:!Boolean(completed||geo.util.isUndefined(completed))});};GEarthExtensions.prototype.fx.Animation.prototype.rewind=function(){this.renderFrame(0);this.stop(false);};GEarthExtensions.prototype.fx.Animation.prototype.renderFrame=function(t){this.renderFn.call(this,t);};GEarthExtensions.prototype.fx.TimedAnimation=createClass_([GEarthExtensions.prototype.fx.Animation],function(duration,renderFn,completionFn){this.extInstance=arguments.callee.extInstance_;this.duration=duration;this.renderFn=renderFn;this.complete=false;this.completionFn=completionFn||function(){};});GEarthExtensions.prototype.fx.TimedAnimation.prototype.renderFrame=function(t){if(this.complete){return;}
if(t>this.duration){this.renderFn.call(this,this.duration);this.stop();this.complete=true;return;}
this.renderFn.call(this,t);};GEarthExtensions.prototype.fx.bounce=function(placemark,options){options=checkParameters_(options,false,{duration:300,startAltitude:ALLOWED_,altitude:this.util.getCamera().getAltitude()/5,phase:ALLOWED_,repeat:0,dampen:0.3,callback:function(){}});var me=this;this.fx.rewind(placemark);if(!'getGeometry'in placemark||!placemark.getGeometry()||placemark.getGeometry().getType()!='KmlPoint'){throw new TypeError('Placemark must be a KmlPoint geometry');}
var point=placemark.getGeometry();var origAltitudeMode=point.getAltitudeMode();if(origAltitudeMode==this.pluginInstance.ALTITUDE_CLAMP_TO_GROUND){point.setAltitude(0);point.setAltitudeMode(this.pluginInstance.ALTITUDE_RELATIVE_TO_GROUND);}
if(origAltitudeMode==this.pluginInstance.ALTITUDE_CLAMP_TO_SEA_FLOOR){point.setAltitude(0);point.setAltitudeMode(this.pluginInstance.ALTITUDE_RELATIVE_TO_SEA_FLOOR);}
if(typeof options.startAltitude!='number'){options.startAltitude=point.getAltitude();}
var phase1,phase2;phase1=function(){me.fx.animateProperty(point,'altitude',{duration:options.duration/2,end:options.startAltitude+options.altitude,easing:'out',featureProxy:placemark,callback:phase2||function(){}});};phase2=function(e){if(e&&e.cancelled){return;}
me.fx.animateProperty(point,'altitude',{duration:options.duration/2,start:options.startAltitude+options.altitude,end:options.startAltitude,easing:'in',featureProxy:placemark,callback:function(e2){point.setAltitudeMode(origAltitudeMode);if(e2.cancelled){point.setAltitude(options.startAltitude);options.callback.call(placemark,e2);return;}
if(options.repeat>=1){--options.repeat;options.altitude*=options.dampen;options.duration*=Math.sqrt(options.dampen);options.phase=0;me.fx.bounce(placemark,options);}else{options.callback.call(placemark,e2);}}});};if(options.phase===1){phase2=null;phase1.call();}else if(options.phase===2){phase2.call();}else{phase1.call();}};GEarthExtensions.prototype.fx.cancel=function(feature){var animations=this.util.getJsDataValue(feature,'_GEarthExtensions_anim')||[];for(var i=0;i<animations.length;i++){animations[i].stop(false);}};GEarthExtensions.prototype.fx.rewind=function(feature){var animations=this.util.getJsDataValue(feature,'_GEarthExtensions_anim')||[];for(var i=0;i<animations.length;i++){animations[i].rewind();}};GEarthExtensions.prototype.fx.animateProperty=function(obj,property,options){options=checkParameters_(options,false,{duration:500,start:ALLOWED_,end:ALLOWED_,delta:ALLOWED_,easing:'none',callback:ALLOWED_,featureProxy:ALLOWED_});if(typeof options.easing=='string'){options.easing={'none':function(t){return t;},'in':function(t){return t*t*t;},'out':function(t){var ts=t*t;var tc=ts*t;return tc-3*ts+3*t;},'both':function(t){var ts=t*t;var tc=ts*t;return 6*tc*ts-15*ts*ts+10*tc;}}[options.easing];}
var propertyTitleCase=property.charAt(0).toUpperCase()+
property.substr(1);var me=this;var doAnimate_;if(property=='color'){if(options.delta){throw new Error('Cannot use delta with color animations.');}
var colorObj=obj.getColor()||{get:function(){return'';}};if(!options.start){options.start=colorObj.get();}
if(!options.end){options.end=colorObj.get();}
doAnimate_=function(f){colorObj.set(me.util.blendColors(options.start,options.end,options.easing.call(null,f)));};}else{var getter=function(){return obj['get'+propertyTitleCase]();};var setter=function(val){return obj['set'+propertyTitleCase](val);};if(!isFinite(options.start)&&!isFinite(options.end)){if(!isFinite(options.delta)){options.delta=0.0;}
options.start=getter();options.end=getter()+options.delta;}else{if(!isFinite(options.start)){options.start=getter();}
if(!isFinite(options.end)){options.end=getter();}}
doAnimate_=function(f){setter(options.start+(options.end-options.start)*options.easing.call(null,f));};}
var anim=new this.fx.TimedAnimation(options.duration,function(t){doAnimate_(1.0*t/options.duration);},function(e){var animations=me.util.getJsDataValue(options.featureProxy||obj,'_GEarthExtensions_anim');if(animations){for(var i=0;i<animations.length;i++){if(animations[i]==this){animations.splice(i,1);break;}}
if(!animations.length){me.util.clearJsDataValue(options.featureProxy||obj,'_GEarthExtensions_anim');}}
if(options.callback){options.callback.call(obj,e);}});var animations=this.util.getJsDataValue(options.featureProxy||obj,'_GEarthExtensions_anim');if(animations){animations.push(anim);}else{this.util.setJsDataValue(options.featureProxy||obj,'_GEarthExtensions_anim',[anim]);}
anim.start();return anim;};GEarthExtensions.prototype.math3d={isnamespace_:true};function eulerAnglesToMatrix_(eulerAngles){var I=2;var J=0;var K=1;var m=[[0,0,0],[0,0,0],[0,0,0]];var cos_ti=Math.cos(eulerAngles[0]);var cos_tj=Math.cos(eulerAngles[1]);var cos_th=Math.cos(eulerAngles[2]);var sin_ti=Math.sin(eulerAngles[0]);var sin_tj=Math.sin(eulerAngles[1]);var sin_th=Math.sin(eulerAngles[2]);var cos_c=cos_ti*cos_th;var cos_s=cos_ti*sin_th;var sin_c=sin_ti*cos_th;var sin_s=sin_ti*sin_th;m[I][I]=cos_tj*cos_th;m[I][J]=sin_tj*sin_c-cos_s;m[I][K]=sin_tj*cos_c+sin_s;m[J][I]=cos_tj*sin_th;m[J][J]=sin_tj*sin_s+cos_c;m[J][K]=sin_tj*cos_s-sin_c;m[K][I]=-sin_tj;m[K][J]=cos_tj*sin_ti;m[K][K]=cos_tj*cos_ti;return new geo.linalg.Matrix(m);}
function matrixToEulerAngles_(matrix){var I=2+1;var J=0+1;var K=1+1;var FLT_EPSILON=1e-6;var cy=Math.sqrt(matrix.e(I,I)*matrix.e(I,I)+
matrix.e(J,I)*matrix.e(J,I));if(cy<=16*FLT_EPSILON){return[Math.atan2(-matrix.e(J,K),matrix.e(J,J)),Math.atan2(-matrix.e(K,I),cy),0];}
return[Math.atan2(matrix.e(K,J),matrix.e(K,K)),Math.atan2(-matrix.e(K,I),cy),Math.atan2(matrix.e(J,I),matrix.e(I,I))];}
GEarthExtensions.prototype.math3d.htrToLocalFrame=function(htr){return eulerAnglesToMatrix_([htr[0].toRadians(),htr[1].toRadians(),htr[2].toRadians()]);};GEarthExtensions.prototype.math3d.localFrameToHtr=function(matrix){var htr=matrixToEulerAngles_(matrix);return[htr[0].toDegrees(),htr[1].toDegrees(),htr[2].toDegrees()];};GEarthExtensions.prototype.math3d.makeOrthonormalFrame=function(dir,up){var newRight=dir.cross(up).toUnitVector();if(newRight.eql(geo.linalg.Vector.Zero(3))){return null;}
var newDir=up.cross(newRight).toUnitVector();var newUp=newRight.cross(newDir);return new geo.linalg.Matrix([newRight.elements,newDir.elements,newUp.elements]);};GEarthExtensions.prototype.math3d.makeLocalToGlobalFrame=function(point){var vertical=point.toCartesian().toUnitVector();var east=new geo.linalg.Vector([0,1,0]).cross(vertical).toUnitVector();var north=vertical.cross(east).toUnitVector();return new geo.linalg.Matrix([east.elements,north.elements,vertical.elements]);};GEarthExtensions.prototype.util={isnamespace_:true};GEarthExtensions.NAMED_COLORS={'aqua':'ffffff00','black':'ff000000','blue':'ffff0000','fuchsia':'ffff00ff','gray':'ff808080','green':'ff008000','lime':'ff00ff00','maroon':'ff000080','navy':'ff800000','olive':'ff008080','purple':'ff800080','red':'ff0000ff','silver':'ffc0c0c0','teal':'ff808000','white':'ffffffff','yellow':'ff00ffff'};GEarthExtensions.prototype.util.parseColor=function(arg,opacity){var pad2_=function(s){return((s.length<2)?'0':'')+s;};if(geo.util.isArray(arg)){return pad2_(((arg.length>=4)?arg[3].toString(16):'ff'))+
pad2_(arg[2].toString(16))+
pad2_(arg[1].toString(16))+
pad2_(arg[0].toString(16));}else if(typeof arg=='string'){if(arg.toLowerCase()in GEarthExtensions.NAMED_COLORS){return GEarthExtensions.NAMED_COLORS[arg.toLowerCase()];}if(arg.length>7){return arg.match(/^[0-9a-f]{8}$/i)?arg:null;}else{var kmlColor=null;if(arg.length>4){kmlColor=arg.replace(/#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})/i,'ff$3$2$1').toLowerCase();}else{kmlColor=arg.replace(/#?([0-9a-f])([0-9a-f])([0-9a-f])/i,'ff$3$3$2$2$1$1').toLowerCase();}
if(kmlColor==arg){return null;}
if(!geo.util.isUndefined(opacity)){kmlColor=pad2_(Math.floor(255*opacity).toString(16))+
kmlColor.substring(2);}
return kmlColor;}}
return null;};GEarthExtensions.prototype.util.blendColors=function(color1,color2,fraction){if(geo.util.isUndefined(fraction)||fraction===null){fraction=0.5;}
color1=this.util.parseColor(color1);color2=this.util.parseColor(color2);var pad2_=function(s){return((s.length<2)?'0':'')+s;};var blendHexComponent_=function(c1,c2){c1=parseInt(c1,16);c2=parseInt(c2,16);return pad2_(Math.floor((c2-c1)*fraction+c1).toString(16));};return blendHexComponent_(color1.substr(0,2),color2.substr(0,2))+
blendHexComponent_(color1.substr(2,2),color2.substr(2,2))+
blendHexComponent_(color1.substr(4,2),color2.substr(4,2))+
blendHexComponent_(color1.substr(6,2),color2.substr(6,2));};var jsData_={};function randomUUID_(){var s=[],itoh='0123456789ABCDEF',i=0;for(i=0;i<36;i++){s[i]=Math.floor(Math.random()*0x10);}
s[14]=4;s[19]=(s[19]&0x3)|0x8;for(i=0;i<36;i++){s[i]=itoh.charAt(s[i]);}
s[8]=s[13]=s[18]=s[23]='-';return s.join('');}
function getJsTag_(object){for(var tag in jsData_){if(jsData_[tag].object.equals(object)){return tag;}}
return null;}
GEarthExtensions.prototype.util.hasJsData=function(object){return getJsTag_(object)?true:false;};GEarthExtensions.prototype.util.clearAllJsData=function(object){var jsTag=getJsTag_(object);if(jsTag){delete jsData_[jsTag];}};GEarthExtensions.prototype.util.getJsDataValue=function(object,key){var jsTag=getJsTag_(object);if(jsTag&&key in jsData_[jsTag].data){return jsData_[jsTag].data[key];}
return undefined;};GEarthExtensions.prototype.util.setJsDataValue=function(object,key,value){var jsTag=getJsTag_(object);if(!jsTag){jsTag=null;while(!jsTag||jsTag in jsData_){jsTag=randomUUID_();}
jsData_[jsTag]={object:object,data:{}};}
jsData_[jsTag].data[key]=value;};GEarthExtensions.prototype.util.clearJsDataValue=function(object,key){var jsTag=getJsTag_(object);if(jsTag&&key in jsData_[jsTag].data){delete jsData_[jsTag].data[key];for(var k in jsData_[jsTag].data){return;}
this.util.clearAllJsData(object);}};GEarthExtensions.prototype.util.displayKml=function(url,options){options=checkParameters_(options,false,{cacheBuster:false,flyToView:false,flyToBoundsFallback:true,aspectRatio:1.0});if(options.cacheBuster){url+=(url.match(/\?/)?'&':'?')+'_cacheBuster='+
Number(new Date()).toString();}
var me=this;google.earth.fetchKml(me.pluginInstance,url,function(kmlObject){if(kmlObject){me.pluginInstance.getFeatures().appendChild(kmlObject);if(options.flyToView){me.util.flyToObject(kmlObject,{boundsFallback:options.flyToBoundsFallback,aspectRatio:options.aspectRatio});}}});};GEarthExtensions.prototype.util.displayKmlString=function(str,options){options=checkParameters_(options,false,{flyToView:false,flyToBoundsFallback:true,aspectRatio:1.0});var kmlObject=this.pluginInstance.parseKml(str);if(kmlObject){this.pluginInstance.getFeatures().appendChild(kmlObject);if(options.flyToView){this.util.flyToObject(kmlObject,{boundsFallback:options.flyToBoundsFallback,aspectRatio:options.aspectRatio});}}
return kmlObject;};GEarthExtensions.prototype.util.lookAt=function(){this.pluginInstance.getView().setAbstractView(this.dom.buildLookAt.apply(null,arguments));};GEarthExtensions.prototype.util.getLookAt=function(altitudeMode){if(geo.util.isUndefined(altitudeMode)){altitudeMode=this.pluginInstance.ALTITUDE_ABSOLUTE;}
return this.pluginInstance.getView().copyAsLookAt(altitudeMode);};GEarthExtensions.prototype.util.getCamera=function(altitudeMode){if(geo.util.isUndefined(altitudeMode)){altitudeMode=this.pluginInstance.ALTITUDE_ABSOLUTE;}
return this.pluginInstance.getView().copyAsCamera(altitudeMode);};GEarthExtensions.prototype.util.flyToObject=function(obj,options){options=checkParameters_(options,false,{boundsFallback:true,aspectRatio:1.0});if(!obj){throw new Error('flyToObject was given an invalid object.');}
if('getAbstractView'in obj&&obj.getAbstractView()){this.pluginInstance.getView().setAbstractView(obj.getAbstractView());}else if(options.boundsFallback){var bounds=this.dom.computeBounds(obj);if(bounds&&!bounds.isEmpty()){this.view.setToBoundsView(bounds,{aspectRatio:options.aspectRatio});}}};GEarthExtensions.prototype.util.batchExecute=function(batchFn,context){var me=this;google.earth.executeBatch(this.pluginInstance,function(){batchFn.call(me,context);});};GEarthExtensions.prototype.util.takeOverCamera=function(enable){if(enable||geo.util.isUndefined(enable)){if(this.cameraControlOldProps_){return;}
this.cameraControlOldProps_={flyToSpeed:this.pluginInstance.getOptions().getFlyToSpeed(),mouseNavEnabled:this.pluginInstance.getOptions().getMouseNavigationEnabled(),navControlVis:this.pluginInstance.getNavigationControl().getVisibility()};this.pluginInstance.getOptions().setFlyToSpeed(this.pluginInstance.SPEED_TELEPORT);this.pluginInstance.getOptions().setMouseNavigationEnabled(false);this.pluginInstance.getNavigationControl().setVisibility(this.pluginInstance.VISIBILITY_HIDE);}else{if(!this.cameraControlOldProps_){return;}
this.pluginInstance.getOptions().setFlyToSpeed(this.cameraControlOldProps_.flyToSpeed);this.pluginInstance.getOptions().setMouseNavigationEnabled(this.cameraControlOldProps_.mouseNavEnabled);this.pluginInstance.getNavigationControl().setVisibility(this.cameraControlOldProps_.navControlVis);delete this.cameraControlOldProps_;}};var ALPHABET_='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_';GEarthExtensions.prototype.util.encodeArray=function(arr){var s='';for(var i=0;i<arr.length;i++){var sgn_num=arr[i]<<1;sgn_num=(arr[i]<0)?~sgn_num:sgn_num;while(sgn_num>=0x20){s+=ALPHABET_.charAt(0x20|(sgn_num&0x1f));sgn_num>>=5;}
s+=ALPHABET_.charAt(sgn_num);}
return s;};GEarthExtensions.prototype.util.decodeArray=function(str){var len=str.length;var index=0;var array=[];while(index<len){var b;var shift=0;var result=0;do{b=ALPHABET_.indexOf(str.charAt(index++));result|=(b&0x1f)<<shift;shift+=5;}while(b>=0x20);array.push(((result&1)?~(result>>1):(result>>1)));}
return array;};GEarthExtensions.prototype.view={isnamespace_:true};GEarthExtensions.prototype.view.createBoundsView=function(bounds,options){options=checkParameters_(options,false,{aspectRatio:REQUIRED_,defaultRange:1000,scaleRange:1.5});var center=bounds.center();var lookAtRange=options.defaultRange;var boundsSpan=bounds.span();if(boundsSpan.lat||boundsSpan.lng){var distEW=new geo.Point(center.lat(),bounds.east()).distance(new geo.Point(center.lat(),bounds.west()));var distNS=new geo.Point(bounds.north(),center.lng()).distance(new geo.Point(bounds.south(),center.lng()));var aspectRatio=Math.min(Math.max(options.aspectRatio,distEW/distNS),1.0);var alpha=(45.0/(aspectRatio+0.4)-2.0).toRadians();var expandToDistance=Math.max(distNS,distEW);var beta=Math.min((90).toRadians(),alpha+expandToDistance/(2*geo.math.EARTH_RADIUS));lookAtRange=options.scaleRange*geo.math.EARTH_RADIUS*(Math.sin(beta)*Math.sqrt(1+1/Math.pow(Math.tan(alpha),2))-1);}
return this.dom.buildLookAt(new geo.Point(center.lat(),center.lng(),bounds.top(),bounds.northEastTop().altitudeMode()),{range:lookAtRange});};GEarthExtensions.prototype.view.setToBoundsView=function(){this.pluginInstance.getView().setAbstractView(this.view.createBoundsView.apply(this,arguments));};var ENC_OVERFLOW_=1073741824;function encodeCamera_(extInstance,cam){var alt=Math.floor(cam.altitude*1e1);return extInstance.util.encodeArray([Math.floor(geo.math.constrainValue(cam.lat,[-90,90])*1e5),Math.floor(geo.math.wrapValue(cam.lng,[-180,180])*1e5),Math.floor(alt/ENC_OVERFLOW_),(alt>=0)?alt%ENC_OVERFLOW_:(ENC_OVERFLOW_-Math.abs(alt)%ENC_OVERFLOW_),Math.floor(geo.math.wrapValue(cam.heading,[0,360])*1e1),Math.floor(geo.math.wrapValue(cam.tilt,[0,180])*1e1),Math.floor(geo.math.wrapValue(cam.roll,[-180,180])*1e1)]);}
function decodeCamera_(extInstance,str){var arr=extInstance.util.decodeArray(str);return{lat:geo.math.constrainValue(arr[0]*1e-5,[-90,90]),lng:geo.math.wrapValue(arr[1]*1e-5,[-180,180]),altitude:(ENC_OVERFLOW_*arr[2]+arr[3])*1e-1,heading:geo.math.wrapValue(arr[4]*1e-1,[0,360]),tilt:geo.math.wrapValue(arr[5]*1e-1,[0,180]),roll:geo.math.wrapValue(arr[6]*1e-1,[-180,180])};}
GEarthExtensions.prototype.view.serialize=function(){var camera=this.pluginInstance.getView().copyAsCamera(this.pluginInstance.ALTITUDE_ABSOLUTE);return'0'+encodeCamera_(this,{lat:camera.getLatitude(),lng:camera.getLongitude(),altitude:camera.getAltitude(),heading:camera.getHeading(),tilt:camera.getTilt(),roll:camera.getRoll()});};GEarthExtensions.prototype.view.deserialize=function(s){if(s.charAt(0)!='0'){throw new Error('Invalid serialized view string.');}
var cameraProps=decodeCamera_(this,s.substr(1));var camera=this.pluginInstance.createCamera('');camera.set(cameraProps.lat,cameraProps.lng,cameraProps.altitude,this.pluginInstance.ALTITUDE_ABSOLUTE,cameraProps.heading,cameraProps.tilt,cameraProps.roll);this.pluginInstance.getView().setAbstractView(camera);};GEarthExtensions.prototype.util.serializeView=GEarthExtensions.prototype.view.serialize;GEarthExtensions.prototype.util.deserializeView=GEarthExtensions.prototype.view.deserialize;GEarthExtensions.prototype.view.createVantageView=function(cameraPoint,lookAtPoint){cameraPoint=new geo.Point(cameraPoint);lookAtPoint=new geo.Point(lookAtPoint);var heading=cameraPoint.heading(lookAtPoint);var roll=0;var cameraCartesian=cameraPoint.toCartesian();var lookAtCartesian=lookAtPoint.toCartesian();var frame=this.math3d.makeLocalToGlobalFrame(cameraPoint);var lookVec=lookAtCartesian.subtract(cameraCartesian).toUnitVector();var downVec=new geo.linalg.Vector(frame.elements[2]).multiply(-1);var tilt=Math.acos(downVec.dot(lookVec)).toDegrees();return this.dom.buildCamera(cameraPoint,{heading:heading,tilt:tilt});};window.GEarthExtensions=GEarthExtensions;})();;(function($){$.fn.ajaxSubmit=function(options){if(!this.length){log('ajaxSubmit: skipping submit process - no element selected');return this;}
if(typeof options=='function'){options={success:options};}
var action=this.attr('action');var url=(typeof action==='string')?$.trim(action):'';if(url){url=(url.match(/^([^#]+)/)||[])[1];}
url=url||window.location.href||'';options=$.extend(true,{url:url,success:$.ajaxSettings.success,type:this[0].getAttribute('method')||'GET',iframeSrc:/^https/i.test(window.location.href||'')?'javascript:false':'about:blank'},options);var veto={};this.trigger('form-pre-serialize',[this,options,veto]);if(veto.veto){log('ajaxSubmit: submit vetoed via form-pre-serialize trigger');return this;}
if(options.beforeSerialize&&options.beforeSerialize(this,options)===false){log('ajaxSubmit: submit aborted via beforeSerialize callback');return this;}
var n,v,a=this.formToArray(options.semantic);if(options.data){options.extraData=options.data;for(n in options.data){if(options.data[n]instanceof Array){for(var k in options.data[n]){a.push({name:n,value:options.data[n][k]});}}
else{v=options.data[n];v=$.isFunction(v)?v():v;a.push({name:n,value:v});}}}
if(options.beforeSubmit&&options.beforeSubmit(a,this,options)===false){log('ajaxSubmit: submit aborted via beforeSubmit callback');return this;}
this.trigger('form-submit-validate',[a,this,options,veto]);if(veto.veto){log('ajaxSubmit: submit vetoed via form-submit-validate trigger');return this;}
var q=$.param(a);if(options.type.toUpperCase()=='GET'){options.url+=(options.url.indexOf('?')>=0?'&':'?')+q;options.data=null;}
else{options.data=q;}
var $form=this,callbacks=[];if(options.resetForm){callbacks.push(function(){$form.resetForm();});}
if(options.clearForm){callbacks.push(function(){$form.clearForm();});}
if(!options.dataType&&options.target){var oldSuccess=options.success||function(){};callbacks.push(function(data){var fn=options.replaceTarget?'replaceWith':'html';$(options.target)[fn](data).each(oldSuccess,arguments);});}
else if(options.success){callbacks.push(options.success);}
options.success=function(data,status,xhr){var context=options.context||options;for(var i=0,max=callbacks.length;i<max;i++){callbacks[i].apply(context,[data,status,xhr||$form,$form]);}};var fileInputs=$('input:file',this).length>0;var mp='multipart/form-data';var multipart=($form.attr('enctype')==mp||$form.attr('encoding')==mp);if(options.iframe!==false&&(fileInputs||options.iframe||multipart)){if(options.closeKeepAlive){$.get(options.closeKeepAlive,fileUpload);}
else{fileUpload();}}
else{$.ajax(options);}
this.trigger('form-submit-notify',[this,options]);return this;function fileUpload(){var form=$form[0];if($(':input[name=submit],:input[id=submit]',form).length){alert('Error: Form elements must not have name or id of "submit".');return;}
var s=$.extend(true,{},$.ajaxSettings,options);s.context=s.context||s;var id='jqFormIO'+(new Date().getTime()),fn='_'+id;var $io=$('<iframe id="'+id+'" name="'+id+'" src="'+s.iframeSrc+'" />');var io=$io[0];$io.css({position:'absolute',top:'-1000px',left:'-1000px'});var xhr={aborted:0,responseText:null,responseXML:null,status:0,statusText:'n/a',getAllResponseHeaders:function(){},getResponseHeader:function(){},setRequestHeader:function(){},abort:function(){log('aborting upload...');var e='aborted';this.aborted=1;$io.attr('src',s.iframeSrc);xhr.error=e;s.error&&s.error.call(s.context,xhr,'error',e);g&&$.event.trigger("ajaxError",[xhr,s,e]);s.complete&&s.complete.call(s.context,xhr,'error');}};var g=s.global;if(g&&!$.active++){$.event.trigger("ajaxStart");}
if(g){$.event.trigger("ajaxSend",[xhr,s]);}
if(s.beforeSend&&s.beforeSend.call(s.context,xhr,s)===false){if(s.global){$.active--;}
return;}
if(xhr.aborted){return;}
var timedOut=0;var sub=form.clk;if(sub){var n=sub.name;if(n&&!sub.disabled){s.extraData=s.extraData||{};s.extraData[n]=sub.value;if(sub.type=="image"){s.extraData[n+'.x']=form.clk_x;s.extraData[n+'.y']=form.clk_y;}}}
function doSubmit(){var t=$form.attr('target'),a=$form.attr('action');form.setAttribute('target',id);if(form.getAttribute('method')!='POST'){form.setAttribute('method','POST');}
if(form.getAttribute('action')!=s.url){form.setAttribute('action',s.url);}
if(!s.skipEncodingOverride){$form.attr({encoding:'multipart/form-data',enctype:'multipart/form-data'});}
if(s.timeout){setTimeout(function(){timedOut=true;cb();},s.timeout);}
var extraInputs=[];try{if(s.extraData){for(var n in s.extraData){extraInputs.push($('<input type="hidden" name="'+n+'" value="'+s.extraData[n]+'" />').appendTo(form)[0]);}}
$io.appendTo('body');io.attachEvent?io.attachEvent('onload',cb):io.addEventListener('load',cb,false);form.submit();}
finally{form.setAttribute('action',a);if(t){form.setAttribute('target',t);}else{$form.removeAttr('target');}
$(extraInputs).remove();}}
if(s.forceSync){doSubmit();}
else{setTimeout(doSubmit,10);}
var data,doc,domCheckCount=50;function cb(){if(xhr.aborted){return;}
var doc=io.contentWindow?io.contentWindow.document:io.contentDocument?io.contentDocument:io.document;if(!doc||doc.location.href==s.iframeSrc){if(!timedOut)
return;}
io.detachEvent?io.detachEvent('onload',cb):io.removeEventListener('load',cb,false);var ok=true;try{if(timedOut){throw'timeout';}
var isXml=s.dataType=='xml'||doc.XMLDocument||$.isXMLDoc(doc);log('isXml='+isXml);if(!isXml&&window.opera&&(doc.body==null||doc.body.innerHTML=='')){if(--domCheckCount){log('requeing onLoad callback, DOM not available');setTimeout(cb,250);return;}}
xhr.responseText=doc.body?doc.body.innerHTML:doc.documentElement?doc.documentElement.innerHTML:null;xhr.responseXML=doc.XMLDocument?doc.XMLDocument:doc;xhr.getResponseHeader=function(header){var headers={'content-type':s.dataType};return headers[header];};var scr=/(json|script)/.test(s.dataType);if(scr||s.textarea){var ta=doc.getElementsByTagName('textarea')[0];if(ta){xhr.responseText=ta.value;}
else if(scr){var pre=doc.getElementsByTagName('pre')[0];var b=doc.getElementsByTagName('body')[0];if(pre){xhr.responseText=pre.textContent;}
else if(b){xhr.responseText=b.innerHTML;}}}
else if(s.dataType=='xml'&&!xhr.responseXML&&xhr.responseText!=null){xhr.responseXML=toXml(xhr.responseText);}
data=httpData(xhr,s.dataType,s);}
catch(e){log('error caught:',e);ok=false;xhr.error=e;s.error&&s.error.call(s.context,xhr,'error',e);g&&$.event.trigger("ajaxError",[xhr,s,e]);}
if(xhr.aborted){log('upload aborted');ok=false;}
if(ok){s.success&&s.success.call(s.context,data,'success',xhr);g&&$.event.trigger("ajaxSuccess",[xhr,s]);}
g&&$.event.trigger("ajaxComplete",[xhr,s]);if(g&&!--$.active){$.event.trigger("ajaxStop");}
s.complete&&s.complete.call(s.context,xhr,ok?'success':'error');setTimeout(function(){$io.removeData('form-plugin-onload');$io.remove();xhr.responseXML=null;},100);}
var toXml=$.parseXML||function(s,doc){if(window.ActiveXObject){doc=new ActiveXObject('Microsoft.XMLDOM');doc.async='false';doc.loadXML(s);}
else{doc=(new DOMParser()).parseFromString(s,'text/xml');}
return(doc&&doc.documentElement&&doc.documentElement.nodeName!='parsererror')?doc:null;};var parseJSON=$.parseJSON||function(s){return window['eval']('('+s+')');};var httpData=function(xhr,type,s){var ct=xhr.getResponseHeader('content-type')||'',xml=type==='xml'||!type&&ct.indexOf('xml')>=0,data=xml?xhr.responseXML:xhr.responseText;if(xml&&data.documentElement.nodeName==='parsererror'){$.error&&$.error('parsererror');}
if(s&&s.dataFilter){data=s.dataFilter(data,type);}
if(typeof data==='string'){if(type==='json'||!type&&ct.indexOf('json')>=0){data=parseJSON(data);}else if(type==="script"||!type&&ct.indexOf("javascript")>=0){$.globalEval(data);}}
return data;};}};$.fn.ajaxForm=function(options){if(this.length===0){var o={s:this.selector,c:this.context};if(!$.isReady&&o.s){log('DOM not ready, queuing ajaxForm');$(function(){$(o.s,o.c).ajaxForm(options);});return this;}
log('terminating; zero elements found by selector'+($.isReady?'':' (DOM not ready)'));return this;}
return this.ajaxFormUnbind().bind('submit.form-plugin',function(e){if(!e.isDefaultPrevented()){e.preventDefault();$(this).ajaxSubmit(options);}}).bind('click.form-plugin',function(e){var target=e.target;var $el=$(target);if(!($el.is(":submit,input:image"))){var t=$el.closest(':submit');if(t.length==0){return;}
target=t[0];}
var form=this;form.clk=target;if(target.type=='image'){if(e.offsetX!=undefined){form.clk_x=e.offsetX;form.clk_y=e.offsetY;}else if(typeof $.fn.offset=='function'){var offset=$el.offset();form.clk_x=e.pageX-offset.left;form.clk_y=e.pageY-offset.top;}else{form.clk_x=e.pageX-target.offsetLeft;form.clk_y=e.pageY-target.offsetTop;}}
setTimeout(function(){form.clk=form.clk_x=form.clk_y=null;},100);});};$.fn.ajaxFormUnbind=function(){return this.unbind('submit.form-plugin click.form-plugin');};$.fn.formToArray=function(semantic){var a=[];if(this.length===0){return a;}
var form=this[0];var els=semantic?form.getElementsByTagName('*'):form.elements;if(!els){return a;}
var i,j,n,v,el,max,jmax;for(i=0,max=els.length;i<max;i++){el=els[i];n=el.name;if(!n){continue;}
if(semantic&&form.clk&&el.type=="image"){if(!el.disabled&&form.clk==el){a.push({name:n,value:$(el).val()});a.push({name:n+'.x',value:form.clk_x},{name:n+'.y',value:form.clk_y});}
continue;}
v=$.fieldValue(el,true);if(v&&v.constructor==Array){for(j=0,jmax=v.length;j<jmax;j++){a.push({name:n,value:v[j]});}}
else if(v!==null&&typeof v!='undefined'){a.push({name:n,value:v});}}
if(!semantic&&form.clk){var $input=$(form.clk),input=$input[0];n=input.name;if(n&&!input.disabled&&input.type=='image'){a.push({name:n,value:$input.val()});a.push({name:n+'.x',value:form.clk_x},{name:n+'.y',value:form.clk_y});}}
return a;};$.fn.formSerialize=function(semantic){return $.param(this.formToArray(semantic));};$.fn.fieldSerialize=function(successful){var a=[];this.each(function(){var n=this.name;if(!n){return;}
var v=$.fieldValue(this,successful);if(v&&v.constructor==Array){for(var i=0,max=v.length;i<max;i++){a.push({name:n,value:v[i]});}}
else if(v!==null&&typeof v!='undefined'){a.push({name:this.name,value:v});}});return $.param(a);};$.fn.fieldValue=function(successful){for(var val=[],i=0,max=this.length;i<max;i++){var el=this[i];var v=$.fieldValue(el,successful);if(v===null||typeof v=='undefined'||(v.constructor==Array&&!v.length)){continue;}
v.constructor==Array?$.merge(val,v):val.push(v);}
return val;};$.fieldValue=function(el,successful){var n=el.name,t=el.type,tag=el.tagName.toLowerCase();if(successful===undefined){successful=true;}
if(successful&&(!n||el.disabled||t=='reset'||t=='button'||(t=='checkbox'||t=='radio')&&!el.checked||(t=='submit'||t=='image')&&el.form&&el.form.clk!=el||tag=='select'&&el.selectedIndex==-1)){return null;}
if(tag=='select'){var index=el.selectedIndex;if(index<0){return null;}
var a=[],ops=el.options;var one=(t=='select-one');var max=(one?index+1:ops.length);for(var i=(one?index:0);i<max;i++){var op=ops[i];if(op.selected){var v=op.value;if(!v){v=(op.attributes&&op.attributes['value']&&!(op.attributes['value'].specified))?op.text:op.value;}
if(one){return v;}
a.push(v);}}
return a;}
return $(el).val();};$.fn.clearForm=function(){return this.each(function(){$('input,select,textarea',this).clearFields();});};$.fn.clearFields=$.fn.clearInputs=function(){return this.each(function(){var t=this.type,tag=this.tagName.toLowerCase();if(t=='text'||t=='password'||tag=='textarea'){this.value='';}
else if(t=='checkbox'||t=='radio'){this.checked=false;}
else if(tag=='select'){this.selectedIndex=-1;}});};$.fn.resetForm=function(){return this.each(function(){if(typeof this.reset=='function'||(typeof this.reset=='object'&&!this.reset.nodeType)){this.reset();}});};$.fn.enable=function(b){if(b===undefined){b=true;}
return this.each(function(){this.disabled=!b;});};$.fn.selected=function(select){if(select===undefined){select=true;}
return this.each(function(){var t=this.type;if(t=='checkbox'||t=='radio'){this.checked=select;}
else if(this.tagName.toLowerCase()=='option'){var $sel=$(this).parent('select');if(select&&$sel[0]&&$sel[0].type=='select-one'){$sel.find('option').selected(false);}
this.selected=select;}});};function log(){if($.fn.ajaxSubmit.debug){var msg='[jquery.form] '+Array.prototype.join.call(arguments,'');if(window.console&&window.console.log){window.console.log(msg);}
else if(window.opera&&window.opera.postError){window.opera.postError(msg);}}};})(jQuery);jQuery.fn.selText=function(){var obj=this[0];if($.browser.msie){var range=obj.offsetParent.createTextRange();range.moveToElementText(obj);range.select();}else if($.browser.mozilla||$.browser.opera){var selection=obj.ownerDocument.defaultView.getSelection();var range=obj.ownerDocument.createRange();range.selectNodeContents(obj);selection.removeAllRanges();selection.addRange(range);}else if($.browser.safari){var selection=obj.ownerDocument.defaultView.getSelection();selection.setBaseAndExtent(obj,0,obj,1);}
return this;}
var madrona=(function(){var options={};var that={};var layers=[];var localAuthority=new URI(window.location.href).getAuthority();var constructor_defaults={hideGoogleLayers:false,rememberMapExtent:true,displayEnhancedContent:false,srcWhitelist:[new RegExp('^http://'+localAuthority)],targetWhitelist:[new RegExp('^http://'+localAuthority)]};that.addLayer=function(url,opts){layers.push({url:url,opts:opts});};that.init=function(opts){options=jQuery.extend({},constructor_defaults,opts);that.options=opts;$('#sidebar').tabs({select:function(event,ui){if($(this).hasClass('masked')){event.preventDefault();}}});var selectedTab=getStore('selectedTab');if(selectedTab){$('#sidebar').tabs('select',selectedTab);};resize();$('.madrona-panel').live('click',function(){if(!$(this).hasClass('madrona-menu-items')){madrona.menu_items.closeAll();}});if(window.google){google.earth.createInstance("map",function(i){geInit(i);},function(code){geFailure(code);});setupListeners();madrona.menu_items.init($('.menu_items'));}else{geFailure();}
$(document).find('#meta-navigation a, a.button, a.close, '+'.menu_items span, .ui-tabs-nav a').live('dragstart',function(){return false;});};var geInit=function(pluginInstance){ge=pluginInstance;ge.getWindow().setVisibility(true);ge.getOptions().setStatusBarVisibility(true);gex=new GEarthExtensions(ge);$(that).trigger('geReady');that.geocoder=new madrona.map.geocoder(gex,$('#flyToLocation'));that.measureTool=new madrona.measureTool();$('#measure_distance').click(function(){that.measureTool.clear();that.measureTool.measureDistance(gex,"measureAmount");$('#measure_clear').removeClass('disabled');$('#measureAmountHolder').show();});$('#measure_area').click(function(){that.measureTool.clear();that.measureTool.measureArea(gex,"measureAmount");$('#measure_clear').removeClass('disabled');$('#measureAmountHolder').show();});$('#measure_clear').click(function(){that.measureTool.clear();$(this).addClass('disabled');$('#measureAmountHolder').hide();});$('#measure_units').change(function(){that.measureTool.setUnits($(this).val());});var setEarthOptions=function(){$('#earthOptions li').each(function(){var li=$(this);switch(li.attr('id')){case'nav':if(li.hasClass('visible')){ge.getNavigationControl().setVisibility(ge.VISIBILITY_AUTO);}else{ge.getNavigationControl().setVisibility(ge.VISIBILITY_HIDE);}
break;case'overview':ge.getOptions().setOverviewMapVisibility(li.hasClass('visible'));break;case'scale':ge.getOptions().setScaleLegendVisibility(li.hasClass('visible'));break;case'atm':ge.getOptions().setAtmosphereVisibility(li.hasClass('visible'));break;case'terrain':ge.getLayerRoot().enableLayerById(ge.LAYER_TERRAIN,li.hasClass('visible'));break;}});}
$('#earthOptions li').click(function(e){$(this).toggleClass('visible');setEarthOptions();});setEarthOptionsFromLocalStore();setEarthOptions();var cameraSet=false;if(options.rememberMapExtent){cameraSet=setCameraFromLocalStorage();}
for(var i=0;i<layers.length;i++){var div=$('<div id="datalayerstree'+i+'"></div>');$('#datalayerstree').append(div);layers[i].tree=kmltree({url:layers[i].url,gex:gex,mapElement:$('#map'),element:div,restoreState:!$.browser.msie,refreshWithState:false,displayEnhancedContent:options.displayEnhancedContent,setExtent:!cameraSet&&layers[i].opts&&layers[i].opts.setExtent});layers[i].tree.load();if(layers[i].url.indexOf('public')!=-1){$(layers[i].tree).bind("kmlLoaded",function(){$(that).trigger('publicReady',[ge,gex]);});};if(layers[i]['opts']&&layers[i]['opts'].showDownloadLink){$('#datalayerstree').append('<p class="download_layer"><a href="'+layers[i].url+'">Download this layer</a> for use in Google Earth or your own website.</p>');}}
that.layers=layers;if(!that.options.hideGoogleLayers){var div=$('<div id="googlelayers"></div>');$('#datalayerstree').append(div);var googleLayers=kmltree({url:options.media_url+'common/fixtures/earthLayers.kml',gex:gex,mapElement:$('#map'),element:div,restoreState:true,supportItemIcon:true});var updateGoogleLayers=function(tree){$('#googlelayers li').each(function(){var item=$(this);var name=item.find('span.name').text();switch(name){case'Grid':ge.getOptions().setGridVisibility(item.hasClass('visible'));break;case'3d Buildings':ge.getLayerRoot().enableLayerById(ge.LAYER_BUILDINGS,item.hasClass('visible'));break;case'Low Resolution 3d Buildings':ge.getLayerRoot().enableLayerById(ge.LAYER_BUILDINGS_LOW_RESOLUTION,item.hasClass('visible'));break;case'Roads':ge.getLayerRoot().enableLayerById(ge.LAYER_ROADS,item.hasClass('visible'));break;case'Borders and Labels':ge.getLayerRoot().enableLayerById(ge.LAYER_BORDERS,item.hasClass('visible'));break;}});}
$(googleLayers).bind('kmlLoaded',function(){updateGoogleLayers(googleLayers);$(that).trigger('earthReady',[ge,gex]);});$(googleLayers).bind('toggleItem',function(){updateGoogleLayers(googleLayers);});googleLayers.load();}else{$(that).trigger('earthReady',[ge,gex]);}
var panel=madrona.panel({appendTo:$('#panel-holder'),showCloseButton:false});setupSidebarLinkHandler(panel);var editors=[];if(options.myshapes){for(var i=0;i<options.myshapes.length;i++){var url=options.myshapes[i].url;var callback=options.myshapes[i]['callback'];var editor=madrona.features.kmlEditor({gex:gex,appendTo:'#myshapestree',url:options.myshapes[i].url,enhancedContent:options.displayEnhancedContent,panel:panel,textLookup:options.textLookup,refreshButton:options.refreshButton});if(callback){$(editor).bind('kmlLoaded',function(event,e,kmlObject){callback(this,this.el,kmlObject)});}
editors.push(editor);$(editor.tree).bind('copyDone',function(e,location){var myshapesEditor=editors[0];myshapesEditor.tree.clearSelection();myshapesEditor.refresh(function(){var node=myshapesEditor.tree.getNodesById(location);if(node.length===1){myshapesEditor.tree.selectNode(node);}});});}}
$('a.myshapes-link').live('click',function(e){e.preventDefault();$('.madrona-panel:visible a.close').click();var href=$(this).attr('href');for(var i=0;i<editors.length;i++){var editor=editors[i];var nodes=editor.tree.getNodesById(href);if(nodes.length===1){editor.tree.selectNode(nodes);nodes.trigger('dblclick');return false;}}
return false;});that.editors=editors;if(options.sharedshapes){for(var i=0;i<options.sharedshapes.length;i++){var editor=madrona.features.kmlEditor({gex:gex,appendTo:'#sharedshapestree',url:options.sharedshapes[i],enhancedContent:options.displayEnhancedContent,panel:panel,textLookup:options.textLookup,refreshButton:options.refreshButton});$(editor.tree).bind('copyDone',function(e,location){$('#sidebar').tabs('select',"#MyShapes");var myshapesEditor=that.editors[0];myshapesEditor.tree.clearSelection();myshapesEditor.refresh(function(){var node=myshapesEditor.tree.getNodesById(location);if(node.length===1){myshapesEditor.tree.selectNode(node);}});});editors.push(editor);}}
var onEditorSelect=function(e,originalEvent,node,kmlObject){if(node){if(node.parents('#MyShapes').length!==0){$('#sidebar').tabs('select','#MyShapes');}else{$('#sidebar').tabs('select','#SharedShapes');}}};var onEditorEdit=function(e,data,status,xhr,context){var editor=editors[0];$('a[href=#MyShapes]').click();var info=typeof data==='object'?data:jQuery.parseJSON(data);var select=info['X-Madrona-Select'];var show=info['X-Madrona-Show'];var untoggle=info['X-Madrona-UnToggle'];var hint=info['X-Madrona-Parent-Hint'];$(editor.tree).one('kmlLoaded',function(){if(select){editor.tree.clearSelection();select=select.split(' ');var nodes=[];for(var i=0;i<select.length;i++){var id=select[i];var ns=editor.tree.getNodesById(id);if(ns.length){nodes.push(ns[0]);}}
if(nodes.length){editor.tree.selectNodes($(nodes));}else{var nl=editor.tree.getNodesById(hint.split(' ')[0]);if(nl.length){$(editor.tree).one('networklinkload',function(){var nodes=[];for(var i=0;i<select.length;i++){var id=select[i];var ns=editor.tree.getNodesById(id);if(ns.length){nodes.push(ns[0]);}}
if(nodes.length){editor.tree.selectNodes($(nodes));};});editor.tree.openNetworkLink(nl);}}}
setTimeout(function(){if(untoggle){untoggle=untoggle.split(' ');for(var i=0;i<untoggle.length;i++){var id=untoggle[i];var ns=editor.tree.getNodesById(id);$(ns[0]).find('> .toggler').click();}}
if(show){var node=editor.tree.getNodesById(show);if(node.length){$(node).trigger('dblclick');}}},20);});editor.refresh();}
for(var i=0;i<editors.length;i++){$(editors[i]).bind('select',onEditorSelect);$(editors[i]).bind('edit',onEditorEdit);};$('#sidebar, #meta-navigation').click(function(e){if(e.target===this||e.target===$('#MyShapes')[0]){for(var i=0;i<editors.length;i++){editors[i].clearSelection();}}});$('#news').click(function(e){opts={};opts['load_msg']='Loading News';opts['showClose']=true;panel.showUrl(that.options.news_url,opts);e.preventDefault();});$('#about').click(function(e){opts={};opts['load_msg']='Loading Intro';opts['showClose']=true;panel.showUrl(that.options.about_url,opts);e.preventDefault();});$('#signin').click(function(e){opts={};opts['load_msg']='Loading Sign In Form';opts['showClose']=true;panel.showUrl(that.options.signin_url,opts);e.preventDefault();});$('#profile').click(function(e){opts={};opts['load_msg']='Loading User Profile';opts['showClose']=true;panel.showUrl(that.options.profile_url,opts);e.preventDefault();});$('#register').click(function(e){opts={};opts['load_msg']='Loading Registration Form';opts['showClose']=true;panel.showUrl(that.options.registration_url,opts);e.preventDefault();});$('#help').click(function(e){opts={};opts['load_msg']='Loading Help Page';opts['showClose']=true;panel.showUrl(that.options.help_url,opts);e.preventDefault();});if(options.show_panel){opts={};opts['showClose']=true;if(options.show_panel=='about'&&that.options.about_url){panel.showUrl(that.options.about_url,opts);}else if(options.show_panel=='news'&&that.options.news_url){panel.showUrl(that.options.news_url,opts);}else if(options.show_panel=='signin'&&that.options.signin_url){panel.showUrl(that.options.signin_url,opts);}}
var url=that.options.media_url+'common/kml/shadow.kmz';google.earth.fetchKml(ge,url,function(k){ge.getFeatures().appendChild(k);});$('#sidebar-toggler').click(function(){$('#map_container').css({'width':'100%','left':0,'z-index':10});$('.menu_items').hide();$('#sidebar > .ui-tabs-nav').hide();$(this).hide();$('#show-sidebar').show();});$('#show-sidebar').click(function(){$(this).hide();$('#map_container').css({left:500});$('.menu_items').show();$('#sidebar > .ui-tabs-nav').show();$('#sidebar-toggler').show();resize();});$('#create_bookmark').click(function(){var camera=ge.getView().copyAsCamera(ge.ALTITUDE_RELATIVE_TO_GROUND);var url="/bookmark/tool/";var tree=null;for(var i=0;i<madrona.layers.length;i++){if(madrona.layers[i].url.indexOf('public')!=-1){tree=madrona.layers[i].tree;break;}}
if(tree){var publicstate=JSON.stringify(tree.getState());}else{var publicstate='{}';}
var params={Latitude:camera.getLatitude(),Longitude:camera.getLongitude(),Altitude:camera.getAltitude(),Heading:camera.getHeading(),Tilt:camera.getTilt(),Roll:camera.getRoll(),AltitudeMode:camera.getAltitudeMode(),publicstate:publicstate};xhr=$.post(url,params,function(data,status,xhr){$('#bookmark_url').text(data);}).error(function(a,b,c){$('#bookmark_url').html("We encountered an error while saving your bookmark:<br/>"+a.responseText+" <br/> "+c+" , "+a.status);}).complete(function(){$('#bookmark_results').show();$('#bookmark_url').selText();});});window.onbeforeunload=function(){setCameraToLocalStorage();saveEarthOptionsToLocalStore();setStore('selectedTab',$('#sidebar > ul > .ui-tabs-selected a').attr('href'));}};var studyRegionLoaded=function(kmlObject,node){$('#datalayerstree').prepend(node);if(kmlObject.getAbstractView()){ge.getView().setAbstractView(kmlObject.getAbstractView());}};var setStore=function(key,value){if(!!window.localStorage){localStorage.setItem(key,value);}};var getStore=function(key){if(!!window.localStorage){return localStorage.getItem(key);}else{return false;}}
var setEarthOptionsFromLocalStore=function(){if(!!window.localStorage&&localStorage.getItem('earthOptions')){var json=JSON.parse(localStorage.getItem('earthOptions'));for(key in json){$('#earthOptions').find('#'+key).toggleClass('visible',json[key]);}}else{return false;}};var saveEarthOptionsToLocalStore=function(){if(!!window.localStorage){var json={};$('#earthOptions li').each(function(){json[$(this).attr('id')]=$(this).hasClass('visible');});localStorage.setItem('earthOptions',JSON.stringify(json));}};var geFailure=function(errorCode){}
var setupListeners=function(){$(window).smartresize(function(){resize();});$('#meta-navigation').click(function(){madrona.menu_items.closeAll();$('#panel-holder').find('a.close:visible').click();});$('#sidebar').bind('mouseup',function(e){madrona.menu_items.closeAll();});$('#sidebar-mask').click(function(){madrona.menu_items.closeAll();});$('#sidebar > .ui-tabs-nav li a').click(function(){$('#panel-holder').find('a.close:visible').click();});$('#panel-holder').click(function(e){if(e.originalTarget===this){madrona.menu_items.closeAll();$('#panel-holder').find('a.close:visible').click();}});};var resize=function(){var mh=$('#meta-navigation').outerHeight();var h=$(document.body).height()-mh;$('#sidebar').css({top:mh,height:h});$('#panel-holder').css({top:mh,height:h});var w=$(document.body).width()-$('#sidebar').width();$('#map_container').height(h).width(w);};that.resize=resize;that.maskSidebar=function(){$('#panel-holder').show();$('#sidebar').addClass('masked');};that.unmaskSidebar=function(){if($('#panel-holder').find('.madrona-panel:visible').length===0){$('#panel-holder').hide();$('#sidebar').removeClass('masked');}};that.showLoadingMask=function(msg){var msg=msg||'Loading';var lmsg=$('#sidebar-mask').find('span.loadingMsg');lmsg.text(msg);lmsg.show();madrona.menu_items.disable();$('#sidebar').addClass('masked');};that.hideLoadingMask=function(){$('#sidebar-mask').find('span.loadingMsg').hide();madrona.menu_items.enable();that.unmaskSidebar();}
var panels=[];that.addPanel=function(panel){panels.push(panel);$(panel).bind('panelshow',onPanelShown);$(panel).bind('panelhide',onPanelHide);$(panel).bind('panelclose',onPanelHide);};var onPanelShown=function(e,panel){that.maskSidebar();};var onPanelHide=function(e,panel){var count=0;for(var i=0;i<panels.length;i++){var p=panels[i];if(p.shown){count++;}}
if(count<=0){that.unmaskSidebar();}};var setCameraToLocalStorage=function(){if(!!window.localStorage){localStorage.setItem('madrona-camera',gex.view.serialize());}};var setCameraFromLocalStorage=function(){if(!!window.localStorage&&localStorage.getItem('madrona-camera')){gex.view.deserialize(localStorage.getItem('madrona-camera'));return true;}
return false;};that.persistentReports={};var setupSidebarLinkHandler=function(panel){$('#map a[rel=sidebar]').live('click',function(e){var balloon=ge.getBalloon();if(balloon){var feature=balloon.getFeature();if(feature&&'getUrl'in feature){var src=feature.getUrl();if(src){var target=$(this).attr('href');if(safeURI(src,target)){panel.showUrl(target,{load_msg:$(this).attr('title')});e.preventDefault();}}}}});};var safeURI=function(src,target){var src=new URI(src);var target=new URI(target);var wuri=new URI(window.location.href);if(target.getAuthority()===null){target=target.resolve(wuri);}
if(src.getAuthority()===null){src=src.resolve(wuri);}
src=src.toString();target=target.toString();var safeSrc=false;for(var i=0;i<options.srcWhitelist.length;i++){if(safeSrc===false){safeSrc=options.srcWhitelist[i].test(src);}}
var safeTarget=false;for(var i=0;i<options.targetWhitelist.length;i++){if(safeTarget===false){safeTarget=options.targetWhitelist[i].test(target);}}
return(safeTarget&&safeSrc);};return that;})();(function(){var cache={};this.tmpl=function tmpl(str,data){var fn=!/\W/.test(str)?cache[str]=cache[str]||tmpl(document.getElementById(str).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};"+"with(obj){p.push('"+
str.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")
+"');}return p.join('');");return data?fn(data):fn;};})();(function($,sr){var debounce=function(func,threshold,execAsap){var timeout;return function debounced(){var obj=this,args=arguments;function delayed(){if(!execAsap)
func.apply(obj,args);timeout=null;};if(timeout)
clearTimeout(timeout);else if(execAsap)
func.apply(obj,args);timeout=setTimeout(delayed,threshold||100);};}
jQuery.fn[sr]=function(fn){return fn?this.bind('resize',debounce(fn)):this.trigger(sr);};})(jQuery,'smartresize');Raphael=(function(){var separator=/[, ]+/,elements=/^(circle|rect|path|ellipse|text|image)$/,doc=document,win=window,oldRaphael={was:"Raphael"in win,is:win.Raphael},R=function(){if(R.is(arguments[0],"array")){var a=arguments[0],cnv=create[apply](R,a.splice(0,3+R.is(a[0],nu))),res=cnv.set();for(var i=0,ii=a[length];i<ii;i++){var j=a[i]||{};elements.test(j.type)&&res[push](cnv[j.type]().attr(j));}
return res;}
return create[apply](R,arguments);},Paper=function(){},appendChild="appendChild",apply="apply",concat="concat",E="",S=" ",split="split",events="click dblclick mousedown mousemove mouseout mouseover mouseup"[split](S),has="hasOwnProperty",join="join",length="length",proto="prototype",lowerCase=String[proto].toLowerCase,math=Math,mmax=math.max,mmin=math.min,nu="number",toString="toString",objectToString=Object[proto][toString],paper={},pow=math.pow,push="push",rg=/^(?=[\da-f]$)/,ISURL=/^url\(['"]?([^\)]+)['"]?\)$/i,colourRegExp=/^\s*((#[a-f\d]{6})|(#[a-f\d]{3})|rgb\(\s*([\d\.]+\s*,\s*[\d\.]+\s*,\s*[\d\.]+)\s*\)|rgb\(\s*([\d\.]+%\s*,\s*[\d\.]+%\s*,\s*[\d\.]+%)\s*\)|hs[bl]\(\s*([\d\.]+\s*,\s*[\d\.]+\s*,\s*[\d\.]+)\s*\)|hs[bl]\(\s*([\d\.]+%\s*,\s*[\d\.]+%\s*,\s*[\d\.]+%)\s*\))\s*$/i,round=math.round,setAttribute="setAttribute",toFloat=parseFloat,toInt=parseInt,upperCase=String[proto].toUpperCase,availableAttrs={"clip-rect":"0 0 1e9 1e9",cursor:"default",cx:0,cy:0,fill:"#fff","fill-opacity":1,font:'10px "Arial"',"font-family":'"Arial"',"font-size":"10","font-style":"normal","font-weight":400,gradient:0,height:0,href:"http://raphaeljs.com/",opacity:1,path:"M0,0",r:0,rotation:0,rx:0,ry:0,scale:"1 1",src:"",stroke:"#000","stroke-dasharray":"","stroke-linecap":"butt","stroke-linejoin":"butt","stroke-miterlimit":0,"stroke-opacity":1,"stroke-width":1,target:"_blank","text-anchor":"middle",title:"Raphael",translation:"0 0",width:0,x:0,y:0},availableAnimAttrs={along:"along","clip-rect":"csv",cx:nu,cy:nu,fill:"colour","fill-opacity":nu,"font-size":nu,height:nu,opacity:nu,path:"path",r:nu,rotation:"csv",rx:nu,ry:nu,scale:"csv",stroke:"colour","stroke-opacity":nu,"stroke-width":nu,translation:"csv",width:nu,x:nu,y:nu},rp="replace";R.version="1.3.1";R.type=(win.SVGAngle||doc.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")?"SVG":"VML");if(R.type=="VML"){var d=document.createElement("div");d.innerHTML='<!--[if vml]><br><br><![endif]-->';if(d.childNodes[length]!=2){return null;}}
R.svg=!(R.vml=R.type=="VML");Paper[proto]=R[proto];R._id=0;R._oid=0;R.fn={};R.is=function(o,type){type=lowerCase.call(type);return((type=="object"||type=="undefined")&&typeof o==type)||(o==null&&type=="null")||lowerCase.call(objectToString.call(o).slice(8,-1))==type;};R.setWindow=function(newwin){win=newwin;doc=win.document;};var toHex=function(color){if(R.vml){var trim=/^\s+|\s+$/g;toHex=cacher(function(color){var bod;color=(color+E)[rp](trim,E);try{var docum=new ActiveXObject("htmlfile");docum.write("<body>");docum.close();bod=docum.body;}catch(e){bod=createPopup().document.body;}
var range=bod.createTextRange();try{bod.style.color=color;var value=range.queryCommandValue("ForeColor");value=((value&255)<<16)|(value&65280)|((value&16711680)>>>16);return"#"+("000000"+value[toString](16)).slice(-6);}catch(e){return"none";}});}else{var i=doc.createElement("i");i.title="Rapha\xebl Colour Picker";i.style.display="none";doc.body[appendChild](i);toHex=cacher(function(color){i.style.color=color;return doc.defaultView.getComputedStyle(i,E).getPropertyValue("color");});}
return toHex(color);};R.hsb2rgb=cacher(function(hue,saturation,brightness){if(R.is(hue,"object")&&"h"in hue&&"s"in hue&&"b"in hue){brightness=hue.b;saturation=hue.s;hue=hue.h;}
var red,green,blue;if(brightness==0){return{r:0,g:0,b:0,hex:"#000"};}
if(hue>1||saturation>1||brightness>1){hue/=255;saturation/=255;brightness/=255;}
var i=~~(hue*6),f=(hue*6)-i,p=brightness*(1-saturation),q=brightness*(1-(saturation*f)),t=brightness*(1-(saturation*(1-f)));red=[brightness,q,p,p,t,brightness,brightness][i];green=[t,brightness,brightness,q,p,p,t][i];blue=[p,p,t,brightness,brightness,q,p][i];red*=255;green*=255;blue*=255;var rgb={r:red,g:green,b:blue},r=(~~red)[toString](16),g=(~~green)[toString](16),b=(~~blue)[toString](16);r=r[rp](rg,"0");g=g[rp](rg,"0");b=b[rp](rg,"0");rgb.hex="#"+r+g+b;return rgb;},R);R.rgb2hsb=cacher(function(red,green,blue){if(R.is(red,"object")&&"r"in red&&"g"in red&&"b"in red){blue=red.b;green=red.g;red=red.r;}
if(R.is(red,"string")){var clr=R.getRGB(red);red=clr.r;green=clr.g;blue=clr.b;}
if(red>1||green>1||blue>1){red/=255;green/=255;blue/=255;}
var max=mmax(red,green,blue),min=mmin(red,green,blue),hue,saturation,brightness=max;if(min==max){return{h:0,s:0,b:max};}else{var delta=(max-min);saturation=delta/max;if(red==max){hue=(green-blue)/delta;}else if(green==max){hue=2+((blue-red)/delta);}else{hue=4+((red-green)/delta);}
hue/=6;hue<0&&hue++;hue>1&&hue--;}
return{h:hue,s:saturation,b:brightness};},R);var p2s=/,?([achlmqrstvxz]),?/gi;R._path2string=function(){return this.join(",")[rp](p2s,"$1");};function cacher(f,scope,postprocessor){function newf(){var arg=Array[proto].slice.call(arguments,0),args=arg[join]("\u25ba"),cache=newf.cache=newf.cache||{},count=newf.count=newf.count||[];if(cache[has](args)){return postprocessor?postprocessor(cache[args]):cache[args];}
count[length]>=1e3&&delete cache[count.shift()];count[push](args);cache[args]=f[apply](scope,arg);return postprocessor?postprocessor(cache[args]):cache[args];}
return newf;}
R.getRGB=cacher(function(colour){if(!colour||!!((colour=colour+E).indexOf("-")+1)){return{r:-1,g:-1,b:-1,hex:"none",error:1};}
if(colour=="none"){return{r:-1,g:-1,b:-1,hex:"none"};}!(({hs:1,rg:1})[has](colour.substring(0,2))||colour.charAt()=="#")&&(colour=toHex(colour));var res,red,green,blue,t,rgb=colour.match(colourRegExp);if(rgb){if(rgb[2]){blue=toInt(rgb[2].substring(5),16);green=toInt(rgb[2].substring(3,5),16);red=toInt(rgb[2].substring(1,3),16);}
if(rgb[3]){blue=toInt((t=rgb[3].charAt(3))+t,16);green=toInt((t=rgb[3].charAt(2))+t,16);red=toInt((t=rgb[3].charAt(1))+t,16);}
if(rgb[4]){rgb=rgb[4][split](/\s*,\s*/);red=toFloat(rgb[0]);green=toFloat(rgb[1]);blue=toFloat(rgb[2]);}
if(rgb[5]){rgb=rgb[5][split](/\s*,\s*/);red=toFloat(rgb[0])*2.55;green=toFloat(rgb[1])*2.55;blue=toFloat(rgb[2])*2.55;}
if(rgb[6]){rgb=rgb[6][split](/\s*,\s*/);red=toFloat(rgb[0]);green=toFloat(rgb[1]);blue=toFloat(rgb[2]);return R.hsb2rgb(red,green,blue);}
if(rgb[7]){rgb=rgb[7][split](/\s*,\s*/);red=toFloat(rgb[0])*2.55;green=toFloat(rgb[1])*2.55;blue=toFloat(rgb[2])*2.55;return R.hsb2rgb(red,green,blue);}
rgb={r:red,g:green,b:blue};var r=(~~red)[toString](16),g=(~~green)[toString](16),b=(~~blue)[toString](16);r=r[rp](rg,"0");g=g[rp](rg,"0");b=b[rp](rg,"0");rgb.hex="#"+r+g+b;return rgb;}
return{r:-1,g:-1,b:-1,hex:"none",error:1};},R);R.getColor=function(value){var start=this.getColor.start=this.getColor.start||{h:0,s:1,b:value||.75},rgb=this.hsb2rgb(start.h,start.s,start.b);start.h+=.075;if(start.h>1){start.h=0;start.s-=.2;start.s<=0&&(this.getColor.start={h:0,s:1,b:start.b});}
return rgb.hex;};R.getColor.reset=function(){delete this.start;};R.parsePathString=cacher(function(pathString){if(!pathString){return null;}
var paramCounts={a:7,c:6,h:1,l:2,m:2,q:4,s:4,t:2,v:1,z:0},data=[];if(R.is(pathString,"array")&&R.is(pathString[0],"array")){data=pathClone(pathString);}
if(!data[length]){(pathString+E)[rp](/([achlmqstvz])[\s,]*((-?\d*\.?\d*(?:e[-+]?\d+)?\s*,?\s*)+)/ig,function(a,b,c){var params=[],name=lowerCase.call(b);c[rp](/(-?\d*\.?\d*(?:e[-+]?\d+)?)\s*,?\s*/ig,function(a,b){b&&params[push](+b);});while(params[length]>=paramCounts[name]){data[push]([b][concat](params.splice(0,paramCounts[name])));if(!paramCounts[name]){break;};}});}
data[toString]=R._path2string;return data;});R.findDotsAtSegment=function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t){var t1=1-t,x=pow(t1,3)*p1x+pow(t1,2)*3*t*c1x+t1*3*t*t*c2x+pow(t,3)*p2x,y=pow(t1,3)*p1y+pow(t1,2)*3*t*c1y+t1*3*t*t*c2y+pow(t,3)*p2y,mx=p1x+2*t*(c1x-p1x)+t*t*(c2x-2*c1x+p1x),my=p1y+2*t*(c1y-p1y)+t*t*(c2y-2*c1y+p1y),nx=c1x+2*t*(c2x-c1x)+t*t*(p2x-2*c2x+c1x),ny=c1y+2*t*(c2y-c1y)+t*t*(p2y-2*c2y+c1y),ax=(1-t)*p1x+t*c1x,ay=(1-t)*p1y+t*c1y,cx=(1-t)*c2x+t*p2x,cy=(1-t)*c2y+t*p2y,alpha=(90-math.atan((mx-nx)/(my-ny))*180/math.PI);(mx>nx||my<ny)&&(alpha+=180);return{x:x,y:y,m:{x:mx,y:my},n:{x:nx,y:ny},start:{x:ax,y:ay},end:{x:cx,y:cy},alpha:alpha};};var pathDimensions=cacher(function(path){if(!path){return{x:0,y:0,width:0,height:0};}
path=path2curve(path);var x=0,y=0,X=[],Y=[],p;for(var i=0,ii=path[length];i<ii;i++){p=path[i];if(p[0]=="M"){x=p[1];y=p[2];X[push](x);Y[push](y);}else{var dim=curveDim(x,y,p[1],p[2],p[3],p[4],p[5],p[6]);X=X[concat](dim.min.x,dim.max.x);Y=Y[concat](dim.min.y,dim.max.y);x=p[5];y=p[6];}}
var xmin=mmin[apply](0,X),ymin=mmin[apply](0,Y);return{x:xmin,y:ymin,width:mmax[apply](0,X)-xmin,height:mmax[apply](0,Y)-ymin};}),pathClone=function(pathArray){var res=[];if(!R.is(pathArray,"array")||!R.is(pathArray&&pathArray[0],"array")){pathArray=R.parsePathString(pathArray);}
for(var i=0,ii=pathArray[length];i<ii;i++){res[i]=[];for(var j=0,jj=pathArray[i][length];j<jj;j++){res[i][j]=pathArray[i][j];}}
res[toString]=R._path2string;return res;},pathToRelative=cacher(function(pathArray){if(!R.is(pathArray,"array")||!R.is(pathArray&&pathArray[0],"array")){pathArray=R.parsePathString(pathArray);}
var res=[],x=0,y=0,mx=0,my=0,start=0;if(pathArray[0][0]=="M"){x=pathArray[0][1];y=pathArray[0][2];mx=x;my=y;start++;res[push](["M",x,y]);}
for(var i=start,ii=pathArray[length];i<ii;i++){var r=res[i]=[],pa=pathArray[i];if(pa[0]!=lowerCase.call(pa[0])){r[0]=lowerCase.call(pa[0]);switch(r[0]){case"a":r[1]=pa[1];r[2]=pa[2];r[3]=pa[3];r[4]=pa[4];r[5]=pa[5];r[6]=+(pa[6]-x).toFixed(3);r[7]=+(pa[7]-y).toFixed(3);break;case"v":r[1]=+(pa[1]-y).toFixed(3);break;case"m":mx=pa[1];my=pa[2];default:for(var j=1,jj=pa[length];j<jj;j++){r[j]=+(pa[j]-((j%2)?x:y)).toFixed(3);}}}else{r=res[i]=[];if(pa[0]=="m"){mx=pa[1]+x;my=pa[2]+y;}
for(var k=0,kk=pa[length];k<kk;k++){res[i][k]=pa[k];}}
var len=res[i][length];switch(res[i][0]){case"z":x=mx;y=my;break;case"h":x+=+res[i][len-1];break;case"v":y+=+res[i][len-1];break;default:x+=+res[i][len-2];y+=+res[i][len-1];}}
res[toString]=R._path2string;return res;},0,pathClone),pathToAbsolute=cacher(function(pathArray){if(!R.is(pathArray,"array")||!R.is(pathArray&&pathArray[0],"array")){pathArray=R.parsePathString(pathArray);}
var res=[],x=0,y=0,mx=0,my=0,start=0;if(pathArray[0][0]=="M"){x=+pathArray[0][1];y=+pathArray[0][2];mx=x;my=y;start++;res[0]=["M",x,y];}
for(var i=start,ii=pathArray[length];i<ii;i++){var r=res[i]=[],pa=pathArray[i];if(pa[0]!=upperCase.call(pa[0])){r[0]=upperCase.call(pa[0]);switch(r[0]){case"A":r[1]=pa[1];r[2]=pa[2];r[3]=pa[3];r[4]=pa[4];r[5]=pa[5];r[6]=+(pa[6]+x);r[7]=+(pa[7]+y);break;case"V":r[1]=+pa[1]+y;break;case"H":r[1]=+pa[1]+x;break;case"M":mx=+pa[1]+x;my=+pa[2]+y;default:for(var j=1,jj=pa[length];j<jj;j++){r[j]=+pa[j]+((j%2)?x:y);}}}else{for(var k=0,kk=pa[length];k<kk;k++){res[i][k]=pa[k];}}
switch(r[0]){case"Z":x=mx;y=my;break;case"H":x=r[1];break;case"V":y=r[1];break;default:x=res[i][res[i][length]-2];y=res[i][res[i][length]-1];}}
res[toString]=R._path2string;return res;},null,pathClone),l2c=function(x1,y1,x2,y2){return[x1,y1,x2,y2,x2,y2];},q2c=function(x1,y1,ax,ay,x2,y2){var _13=1/3,_23=2/3;return[_13*x1+_23*ax,_13*y1+_23*ay,_13*x2+_23*ax,_13*y2+_23*ay,x2,y2];},a2c=function(x1,y1,rx,ry,angle,large_arc_flag,sweep_flag,x2,y2,recursive){var PI=math.PI,_120=PI*120/180,rad=PI/180*(+angle||0),res=[],xy,rotate=cacher(function(x,y,rad){var X=x*math.cos(rad)-y*math.sin(rad),Y=x*math.sin(rad)+y*math.cos(rad);return{x:X,y:Y};});if(!recursive){xy=rotate(x1,y1,-rad);x1=xy.x;y1=xy.y;xy=rotate(x2,y2,-rad);x2=xy.x;y2=xy.y;var cos=math.cos(PI/180*angle),sin=math.sin(PI/180*angle),x=(x1-x2)/2,y=(y1-y2)/2;rx=mmax(rx,math.abs(x));ry=mmax(ry,math.abs(y));var h=(x*x)/(rx*rx)+(y*y)/(ry*ry);if(h>1){rx=math.sqrt(h)*rx;ry=math.sqrt(h)*ry;}
var rx2=rx*rx,ry2=ry*ry,k=(large_arc_flag==sweep_flag?-1:1)*math.sqrt(math.abs((rx2*ry2-rx2*y*y-ry2*x*x)/(rx2*y*y+ry2*x*x))),cx=k*rx*y/ry+(x1+x2)/2,cy=k*-ry*x/rx+(y1+y2)/2,f1=math.asin(((y1-cy)/ry).toFixed(7)),f2=math.asin(((y2-cy)/ry).toFixed(7));f1=x1<cx?PI-f1:f1;f2=x2<cx?PI-f2:f2;f1<0&&(f1=PI*2+f1);f2<0&&(f2=PI*2+f2);if(sweep_flag&&f1>f2){f1=f1-PI*2;}
if(!sweep_flag&&f2>f1){f2=f2-PI*2;}}else{f1=recursive[0];f2=recursive[1];cx=recursive[2];cy=recursive[3];}
var df=f2-f1;if(math.abs(df)>_120){var f2old=f2,x2old=x2,y2old=y2;f2=f1+_120*(sweep_flag&&f2>f1?1:-1);x2=cx+rx*math.cos(f2);y2=cy+ry*math.sin(f2);res=a2c(x2,y2,rx,ry,angle,0,sweep_flag,x2old,y2old,[f2,f2old,cx,cy]);}
df=f2-f1;var c1=math.cos(f1),s1=math.sin(f1),c2=math.cos(f2),s2=math.sin(f2),t=math.tan(df/4),hx=4/3*rx*t,hy=4/3*ry*t,m1=[x1,y1],m2=[x1+hx*s1,y1-hy*c1],m3=[x2+hx*s2,y2-hy*c2],m4=[x2,y2];m2[0]=2*m1[0]-m2[0];m2[1]=2*m1[1]-m2[1];if(recursive){return[m2,m3,m4][concat](res);}else{res=[m2,m3,m4][concat](res)[join]()[split](",");var newres=[];for(var i=0,ii=res[length];i<ii;i++){newres[i]=i%2?rotate(res[i-1],res[i],rad).y:rotate(res[i],res[i+1],rad).x;}
return newres;}},findDotAtSegment=function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t){var t1=1-t;return{x:pow(t1,3)*p1x+pow(t1,2)*3*t*c1x+t1*3*t*t*c2x+pow(t,3)*p2x,y:pow(t1,3)*p1y+pow(t1,2)*3*t*c1y+t1*3*t*t*c2y+pow(t,3)*p2y};},curveDim=cacher(function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y){var a=(c2x-2*c1x+p1x)-(p2x-2*c2x+c1x),b=2*(c1x-p1x)-2*(c2x-c1x),c=p1x-c1x,t1=(-b+math.sqrt(b*b-4*a*c))/2/a,t2=(-b-math.sqrt(b*b-4*a*c))/2/a,y=[p1y,p2y],x=[p1x,p2x],dot;math.abs(t1)>1e12&&(t1=.5);math.abs(t2)>1e12&&(t2=.5);if(t1>0&&t1<1){dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t1);x[push](dot.x);y[push](dot.y);}
if(t2>0&&t2<1){dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t2);x[push](dot.x);y[push](dot.y);}
a=(c2y-2*c1y+p1y)-(p2y-2*c2y+c1y);b=2*(c1y-p1y)-2*(c2y-c1y);c=p1y-c1y;t1=(-b+math.sqrt(b*b-4*a*c))/2/a;t2=(-b-math.sqrt(b*b-4*a*c))/2/a;math.abs(t1)>1e12&&(t1=.5);math.abs(t2)>1e12&&(t2=.5);if(t1>0&&t1<1){dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t1);x[push](dot.x);y[push](dot.y);}
if(t2>0&&t2<1){dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t2);x[push](dot.x);y[push](dot.y);}
return{min:{x:mmin[apply](0,x),y:mmin[apply](0,y)},max:{x:mmax[apply](0,x),y:mmax[apply](0,y)}};}),path2curve=cacher(function(path,path2){var p=pathToAbsolute(path),p2=path2&&pathToAbsolute(path2),attrs={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},attrs2={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},processPath=function(path,d){var nx,ny;if(!path){return["C",d.x,d.y,d.x,d.y,d.x,d.y];}!(path[0]in{T:1,Q:1})&&(d.qx=d.qy=null);switch(path[0]){case"M":d.X=path[1];d.Y=path[2];break;case"A":path=["C"][concat](a2c[apply](0,[d.x,d.y][concat](path.slice(1))));break;case"S":nx=d.x+(d.x-(d.bx||d.x));ny=d.y+(d.y-(d.by||d.y));path=["C",nx,ny][concat](path.slice(1));break;case"T":d.qx=d.x+(d.x-(d.qx||d.x));d.qy=d.y+(d.y-(d.qy||d.y));path=["C"][concat](q2c(d.x,d.y,d.qx,d.qy,path[1],path[2]));break;case"Q":d.qx=path[1];d.qy=path[2];path=["C"][concat](q2c(d.x,d.y,path[1],path[2],path[3],path[4]));break;case"L":path=["C"][concat](l2c(d.x,d.y,path[1],path[2]));break;case"H":path=["C"][concat](l2c(d.x,d.y,path[1],d.y));break;case"V":path=["C"][concat](l2c(d.x,d.y,d.x,path[1]));break;case"Z":path=["C"][concat](l2c(d.x,d.y,d.X,d.Y));break;}
return path;},fixArc=function(pp,i){if(pp[i][length]>7){pp[i].shift();var pi=pp[i];while(pi[length]){pp.splice(i++,0,["C"][concat](pi.splice(0,6)));}
pp.splice(i,1);ii=mmax(p[length],p2&&p2[length]||0);}},fixM=function(path1,path2,a1,a2,i){if(path1&&path2&&path1[i][0]=="M"&&path2[i][0]!="M"){path2.splice(i,0,["M",a2.x,a2.y]);a1.bx=0;a1.by=0;a1.x=path1[i][1];a1.y=path1[i][2];ii=mmax(p[length],p2&&p2[length]||0);}};for(var i=0,ii=mmax(p[length],p2&&p2[length]||0);i<ii;i++){p[i]=processPath(p[i],attrs);fixArc(p,i);p2&&(p2[i]=processPath(p2[i],attrs2));p2&&fixArc(p2,i);fixM(p,p2,attrs,attrs2,i);fixM(p2,p,attrs2,attrs,i);var seg=p[i],seg2=p2&&p2[i],seglen=seg[length],seg2len=p2&&seg2[length];attrs.x=seg[seglen-2];attrs.y=seg[seglen-1];attrs.bx=toFloat(seg[seglen-4])||attrs.x;attrs.by=toFloat(seg[seglen-3])||attrs.y;attrs2.bx=p2&&(toFloat(seg2[seg2len-4])||attrs2.x);attrs2.by=p2&&(toFloat(seg2[seg2len-3])||attrs2.y);attrs2.x=p2&&seg2[seg2len-2];attrs2.y=p2&&seg2[seg2len-1];}
return p2?[p,p2]:p;},null,pathClone),parseDots=cacher(function(gradient){var dots=[];for(var i=0,ii=gradient[length];i<ii;i++){var dot={},par=gradient[i].match(/^([^:]*):?([\d\.]*)/);dot.color=R.getRGB(par[1]);if(dot.color.error){return null;}
dot.color=dot.color.hex;par[2]&&(dot.offset=par[2]+"%");dots[push](dot);}
for(var i=1,ii=dots[length]-1;i<ii;i++){if(!dots[i].offset){var start=toFloat(dots[i-1].offset||0),end=0;for(var j=i+1;j<ii;j++){if(dots[j].offset){end=dots[j].offset;break;}}
if(!end){end=100;j=ii;}
end=toFloat(end);var d=(end-start)/(j-i+1);for(;i<j;i++){start+=d;dots[i].offset=start+"%";}}}
return dots;}),getContainer=function(){var container,x,y,width,height;if(R.is(arguments[0],"string")||R.is(arguments[0],"object")){if(R.is(arguments[0],"string")){container=doc.getElementById(arguments[0]);}else{container=arguments[0];}
if(container.tagName){if(arguments[1]==null){return{container:container,width:container.style.pixelWidth||container.offsetWidth,height:container.style.pixelHeight||container.offsetHeight};}else{return{container:container,width:arguments[1],height:arguments[2]};}}}else if(R.is(arguments[0],nu)&&arguments[length]>3){return{container:1,x:arguments[0],y:arguments[1],width:arguments[2],height:arguments[3]};}},plugins=function(con,add){var that=this;for(var prop in add)if(add[has](prop)&&!(prop in con)){switch(typeof add[prop]){case"function":(function(f){con[prop]=con===that?f:function(){return f[apply](that,arguments);};})(add[prop]);break;case"object":con[prop]=con[prop]||{};plugins.call(this,con[prop],add[prop]);break;default:con[prop]=add[prop];break;}}},tear=function(el,paper){el==paper.top&&(paper.top=el.prev);el==paper.bottom&&(paper.bottom=el.next);el.next&&(el.next.prev=el.prev);el.prev&&(el.prev.next=el.next);},tofront=function(el,paper){if(paper.top===el){return;}
tear(el,paper);el.next=null;el.prev=paper.top;paper.top.next=el;paper.top=el;},toback=function(el,paper){if(paper.bottom===el){return;}
tear(el,paper);el.next=paper.bottom;el.prev=null;paper.bottom.prev=el;paper.bottom=el;},insertafter=function(el,el2,paper){tear(el,paper);el2==paper.top&&(paper.top=el);el2.next&&(el2.next.prev=el);el.next=el2.next;el.prev=el2;el2.next=el;},insertbefore=function(el,el2,paper){tear(el,paper);el2==paper.bottom&&(paper.bottom=el);el2.prev&&(el2.prev.next=el);el.prev=el2.prev;el2.prev=el;el.next=el2;},removed=function(methodname){return function(){throw new Error("Rapha\xebl: you are calling to method \u201c"+methodname+"\u201d of removed object");};},radial_gradient=/^r(?:\(([^,]+?)\s*,\s*([^\)]+?)\))?/;if(R.svg){Paper[proto].svgns="http://www.w3.org/2000/svg";Paper[proto].xlink="http://www.w3.org/1999/xlink";var round=function(num){return+num+(~~num===num)*.5;},roundPath=function(path){for(var i=0,ii=path[length];i<ii;i++){if(lowerCase.call(path[i][0])!="a"){for(var j=1,jj=path[i][length];j<jj;j++){path[i][j]=round(path[i][j]);}}else{path[i][6]=round(path[i][6]);path[i][7]=round(path[i][7]);}}
return path;},$=function(el,attr){if(attr){for(var key in attr)if(attr[has](key)){el[setAttribute](key,attr[key]);}}else{return doc.createElementNS(Paper[proto].svgns,el);}};R[toString]=function(){return"Your browser supports SVG.\nYou are running Rapha\xebl "+this.version;};var thePath=function(pathString,SVG){var el=$("path");SVG.canvas&&SVG.canvas[appendChild](el);var p=new Element(el,SVG);p.type="path";setFillAndStroke(p,{fill:"none",stroke:"#000",path:pathString});return p;};var addGradientFill=function(o,gradient,SVG){var type="linear",fx=.5,fy=.5,s=o.style;gradient=(gradient+E)[rp](radial_gradient,function(all,_fx,_fy){type="radial";if(_fx&&_fy){fx=toFloat(_fx);fy=toFloat(_fy);var dir=((fy>.5)*2-1);pow(fx-.5,2)+pow(fy-.5,2)>.25&&(fy=math.sqrt(.25-pow(fx-.5,2))*dir+.5)&&fy!=.5&&(fy=fy.toFixed(5)-1e-5*dir);}
return E;});gradient=gradient[split](/\s*\-\s*/);if(type=="linear"){var angle=gradient.shift();angle=-toFloat(angle);if(isNaN(angle)){return null;}
var vector=[0,0,math.cos(angle*math.PI/180),math.sin(angle*math.PI/180)],max=1/(mmax(math.abs(vector[2]),math.abs(vector[3]))||1);vector[2]*=max;vector[3]*=max;if(vector[2]<0){vector[0]=-vector[2];vector[2]=0;}
if(vector[3]<0){vector[1]=-vector[3];vector[3]=0;}}
var dots=parseDots(gradient);if(!dots){return null;}
var el=$(type+"Gradient");el.id="r"+(R._id++)[toString](36);$(el,type=="radial"?{fx:fx,fy:fy}:{x1:vector[0],y1:vector[1],x2:vector[2],y2:vector[3]});SVG.defs[appendChild](el);for(var i=0,ii=dots[length];i<ii;i++){var stop=$("stop");$(stop,{offset:dots[i].offset?dots[i].offset:!i?"0%":"100%","stop-color":dots[i].color||"#fff"});el[appendChild](stop);};$(o,{fill:"url(#"+el.id+")",opacity:1,"fill-opacity":1});s.fill=E;s.opacity=1;s.fillOpacity=1;return 1;};var updatePosition=function(o){var bbox=o.getBBox();$(o.pattern,{patternTransform:R.format("translate({0},{1})",bbox.x,bbox.y)});};var setFillAndStroke=function(o,params){var dasharray={"":[0],"none":[0],"-":[3,1],".":[1,1],"-.":[3,1,1,1],"-..":[3,1,1,1,1,1],". ":[1,3],"- ":[4,3],"--":[8,3],"- .":[4,3,1,3],"--.":[8,3,1,3],"--..":[8,3,1,3,1,3]},node=o.node,attrs=o.attrs,rot=o.rotate(),addDashes=function(o,value){value=dasharray[lowerCase.call(value)];if(value){var width=o.attrs["stroke-width"]||"1",butt={round:width,square:width,butt:0}[o.attrs["stroke-linecap"]||params["stroke-linecap"]]||0,dashes=[];var i=value[length];while(i--){dashes[i]=value[i]*width+((i%2)?1:-1)*butt;}
$(node,{"stroke-dasharray":dashes[join](",")});}};params[has]("rotation")&&(rot=params.rotation);var rotxy=(rot+E)[split](separator);if(!(rotxy.length-1)){rotxy=null;}else{rotxy[1]=+rotxy[1];rotxy[2]=+rotxy[2];}
toFloat(rot)&&o.rotate(0,true);for(var att in params)if(params[has](att)){if(!availableAttrs[has](att)){continue;}
var value=params[att];attrs[att]=value;switch(att){case"rotation":o.rotate(value,true);break;case"href":case"title":case"target":var pn=node.parentNode;if(lowerCase.call(pn.tagName)!="a"){var hl=$("a");pn.insertBefore(hl,node);hl[appendChild](node);pn=hl;}
pn.setAttributeNS(o.paper.xlink,att,value);break;case"cursor":node.style.cursor=value;break;case"clip-rect":var rect=(value+E)[split](separator);if(rect[length]==4){o.clip&&o.clip.parentNode.parentNode.removeChild(o.clip.parentNode);var el=$("clipPath"),rc=$("rect");el.id="r"+(R._id++)[toString](36);$(rc,{x:rect[0],y:rect[1],width:rect[2],height:rect[3]});el[appendChild](rc);o.paper.defs[appendChild](el);$(node,{"clip-path":"url(#"+el.id+")"});o.clip=rc;}
if(!value){var clip=doc.getElementById(node.getAttribute("clip-path")[rp](/(^url\(#|\)$)/g,E));clip&&clip.parentNode.removeChild(clip);$(node,{"clip-path":E});delete o.clip;}
break;case"path":if(value&&o.type=="path"){attrs.path=roundPath(pathToAbsolute(value));$(node,{d:attrs.path});}
break;case"width":node[setAttribute](att,value);if(attrs.fx){att="x";value=attrs.x;}else{break;}
case"x":if(attrs.fx){value=-attrs.x-(attrs.width||0);}
case"rx":if(att=="rx"&&o.type=="rect"){break;}
case"cx":rotxy&&(att=="x"||att=="cx")&&(rotxy[1]+=value-attrs[att]);node[setAttribute](att,round(value));o.pattern&&updatePosition(o);break;case"height":node[setAttribute](att,value);if(attrs.fy){att="y";value=attrs.y;}else{break;}
case"y":if(attrs.fy){value=-attrs.y-(attrs.height||0);}
case"ry":if(att=="ry"&&o.type=="rect"){break;}
case"cy":rotxy&&(att=="y"||att=="cy")&&(rotxy[2]+=value-attrs[att]);node[setAttribute](att,round(value));o.pattern&&updatePosition(o);break;case"r":if(o.type=="rect"){$(node,{rx:value,ry:value});}else{node[setAttribute](att,value);}
break;case"src":if(o.type=="image"){node.setAttributeNS(o.paper.xlink,"href",value);}
break;case"stroke-width":node.style.strokeWidth=value;node[setAttribute](att,value);if(attrs["stroke-dasharray"]){addDashes(o,attrs["stroke-dasharray"]);}
break;case"stroke-dasharray":addDashes(o,value);break;case"translation":var xy=(value+E)[split](separator);xy[0]=+xy[0]||0;xy[1]=+xy[1]||0;if(rotxy){rotxy[1]+=xy[0];rotxy[2]+=xy[1];}
translate.call(o,xy[0],xy[1]);break;case"scale":var xy=(value+E)[split](separator);o.scale(+xy[0]||1,+xy[1]||+xy[0]||1,+xy[2]||null,+xy[3]||null);break;case"fill":var isURL=(value+E).match(ISURL);if(isURL){var el=$("pattern"),ig=$("image");el.id="r"+(R._id++)[toString](36);$(el,{x:0,y:0,patternUnits:"userSpaceOnUse",height:1,width:1});$(ig,{x:0,y:0});ig.setAttributeNS(o.paper.xlink,"href",isURL[1]);el[appendChild](ig);var img=doc.createElement("img");img.style.cssText="position:absolute;left:-9999em;top-9999em";img.onload=function(){$(el,{width:this.offsetWidth,height:this.offsetHeight});$(ig,{width:this.offsetWidth,height:this.offsetHeight});doc.body.removeChild(this);o.paper.safari();};doc.body[appendChild](img);img.src=isURL[1];o.paper.defs[appendChild](el);node.style.fill="url(#"+el.id+")";$(node,{fill:"url(#"+el.id+")"});o.pattern=el;o.pattern&&updatePosition(o);break;}
if(!R.getRGB(value).error){delete params.gradient;delete attrs.gradient;!R.is(attrs.opacity,"undefined")&&R.is(params.opacity,"undefined")&&$(node,{opacity:attrs.opacity});!R.is(attrs["fill-opacity"],"undefined")&&R.is(params["fill-opacity"],"undefined")&&$(node,{"fill-opacity":attrs["fill-opacity"]});}else if((({circle:1,ellipse:1})[has](o.type)||(value+E).charAt()!="r")&&addGradientFill(node,value,o.paper)){attrs.gradient=value;attrs.fill="none";break;}
case"stroke":node[setAttribute](att,R.getRGB(value).hex);break;case"gradient":(({circle:1,ellipse:1})[has](o.type)||(value+E).charAt()!="r")&&addGradientFill(node,value,o.paper);break;case"opacity":case"fill-opacity":if(attrs.gradient){var gradient=doc.getElementById(node.getAttribute("fill")[rp](/^url\(#|\)$/g,E));if(gradient){var stops=gradient.getElementsByTagName("stop");stops[stops[length]-1][setAttribute]("stop-opacity",value);}
break;}
default:att=="font-size"&&(value=toInt(value,10)+"px");var cssrule=att[rp](/(\-.)/g,function(w){return upperCase.call(w.substring(1));});node.style[cssrule]=value;node[setAttribute](att,value);break;}}
tuneText(o,params);if(rotxy){o.rotate(rotxy.join(S));}else{toFloat(rot)&&o.rotate(rot,true);}};var leading=1.2;var tuneText=function(el,params){if(el.type!="text"||!(params[has]("text")||params[has]("font")||params[has]("font-size")||params[has]("x")||params[has]("y"))){return;}
var a=el.attrs,node=el.node,fontSize=node.firstChild?toInt(doc.defaultView.getComputedStyle(node.firstChild,E).getPropertyValue("font-size"),10):10;if(params[has]("text")){a.text=params.text;while(node.firstChild){node.removeChild(node.firstChild);}
var texts=(params.text+E)[split]("\n");for(var i=0,ii=texts[length];i<ii;i++)if(texts[i]){var tspan=$("tspan");i&&$(tspan,{dy:fontSize*leading,x:a.x});tspan[appendChild](doc.createTextNode(texts[i]));node[appendChild](tspan);}}else{var texts=node.getElementsByTagName("tspan");for(var i=0,ii=texts[length];i<ii;i++){i&&$(texts[i],{dy:fontSize*leading,x:a.x});}}
$(node,{y:a.y});var bb=el.getBBox(),dif=a.y-(bb.y+bb.height/2);dif&&isFinite(dif)&&$(node,{y:a.y+dif});};var Element=function(node,svg){var X=0,Y=0;this[0]=node;this.id=R._oid++;this.node=node;node.raphael=this;this.paper=svg;this.attrs=this.attrs||{};this.transformations=[];this._={tx:0,ty:0,rt:{deg:0,cx:0,cy:0},sx:1,sy:1};!svg.bottom&&(svg.bottom=this);this.prev=svg.top;svg.top&&(svg.top.next=this);svg.top=this;this.next=null;};Element[proto].rotate=function(deg,cx,cy){if(this.removed){return this;}
if(deg==null){if(this._.rt.cx){return[this._.rt.deg,this._.rt.cx,this._.rt.cy][join](S);}
return this._.rt.deg;}
var bbox=this.getBBox();deg=(deg+E)[split](separator);if(deg[length]-1){cx=toFloat(deg[1]);cy=toFloat(deg[2]);}
deg=toFloat(deg[0]);if(cx!=null){this._.rt.deg=deg;}else{this._.rt.deg+=deg;}
(cy==null)&&(cx=null);this._.rt.cx=cx;this._.rt.cy=cy;cx=cx==null?bbox.x+bbox.width/2:cx;cy=cy==null?bbox.y+bbox.height/2:cy;if(this._.rt.deg){this.transformations[0]=R.format("rotate({0} {1} {2})",this._.rt.deg,cx,cy);this.clip&&$(this.clip,{transform:R.format("rotate({0} {1} {2})",-this._.rt.deg,cx,cy)});}else{this.transformations[0]=E;this.clip&&$(this.clip,{transform:E});}
$(this.node,{transform:this.transformations[join](S)});return this;};Element[proto].hide=function(){!this.removed&&(this.node.style.display="none");return this;};Element[proto].show=function(){!this.removed&&(this.node.style.display="");return this;};Element[proto].remove=function(){if(this.removed){return;}
tear(this,this.paper);this.node.parentNode.removeChild(this.node);for(var i in this){delete this[i];}
this.removed=true;};Element[proto].getBBox=function(){if(this.removed){return this;}
if(this.type=="path"){return pathDimensions(this.attrs.path);}
if(this.node.style.display=="none"){this.show();var hide=true;}
var bbox={};try{bbox=this.node.getBBox();}catch(e){}finally{bbox=bbox||{};}
if(this.type=="text"){bbox={x:bbox.x,y:Infinity,width:0,height:0};for(var i=0,ii=this.node.getNumberOfChars();i<ii;i++){var bb=this.node.getExtentOfChar(i);(bb.y<bbox.y)&&(bbox.y=bb.y);(bb.y+bb.height-bbox.y>bbox.height)&&(bbox.height=bb.y+bb.height-bbox.y);(bb.x+bb.width-bbox.x>bbox.width)&&(bbox.width=bb.x+bb.width-bbox.x);}}
hide&&this.hide();return bbox;};Element[proto].attr=function(){if(this.removed){return this;}
if(arguments[length]==0){var res={};for(var i in this.attrs)if(this.attrs[has](i)){res[i]=this.attrs[i];}
this._.rt.deg&&(res.rotation=this.rotate());(this._.sx!=1||this._.sy!=1)&&(res.scale=this.scale());res.gradient&&res.fill=="none"&&(res.fill=res.gradient)&&delete res.gradient;return res;}
if(arguments[length]==1&&R.is(arguments[0],"string")){if(arguments[0]=="translation"){return translate.call(this);}
if(arguments[0]=="rotation"){return this.rotate();}
if(arguments[0]=="scale"){return this.scale();}
if(arguments[0]=="fill"&&this.attrs.fill=="none"&&this.attrs.gradient){return this.attrs.gradient;}
return this.attrs[arguments[0]];}
if(arguments[length]==1&&R.is(arguments[0],"array")){var values={};for(var j in arguments[0])if(arguments[0][has](j)){values[arguments[0][j]]=this.attrs[arguments[0][j]];}
return values;}
if(arguments[length]==2){var params={};params[arguments[0]]=arguments[1];setFillAndStroke(this,params);}else if(arguments[length]==1&&R.is(arguments[0],"object")){setFillAndStroke(this,arguments[0]);}
return this;};Element[proto].toFront=function(){if(this.removed){return this;}
this.node.parentNode[appendChild](this.node);var svg=this.paper;svg.top!=this&&tofront(this,svg);return this;};Element[proto].toBack=function(){if(this.removed){return this;}
if(this.node.parentNode.firstChild!=this.node){this.node.parentNode.insertBefore(this.node,this.node.parentNode.firstChild);toback(this,this.paper);var svg=this.paper;}
return this;};Element[proto].insertAfter=function(element){if(this.removed){return this;}
var node=element.node;if(node.nextSibling){node.parentNode.insertBefore(this.node,node.nextSibling);}else{node.parentNode[appendChild](this.node);}
insertafter(this,element,this.paper);return this;};Element[proto].insertBefore=function(element){if(this.removed){return this;}
var node=element.node;node.parentNode.insertBefore(this.node,node);insertbefore(this,element,this.paper);return this;};var theCircle=function(svg,x,y,r){x=round(x);y=round(y);var el=$("circle");svg.canvas&&svg.canvas[appendChild](el);var res=new Element(el,svg);res.attrs={cx:x,cy:y,r:r,fill:"none",stroke:"#000"};res.type="circle";$(el,res.attrs);return res;};var theRect=function(svg,x,y,w,h,r){x=round(x);y=round(y);var el=$("rect");svg.canvas&&svg.canvas[appendChild](el);var res=new Element(el,svg);res.attrs={x:x,y:y,width:w,height:h,r:r||0,rx:r||0,ry:r||0,fill:"none",stroke:"#000"};res.type="rect";$(el,res.attrs);return res;};var theEllipse=function(svg,x,y,rx,ry){x=round(x);y=round(y);var el=$("ellipse");svg.canvas&&svg.canvas[appendChild](el);var res=new Element(el,svg);res.attrs={cx:x,cy:y,rx:rx,ry:ry,fill:"none",stroke:"#000"};res.type="ellipse";$(el,res.attrs);return res;};var theImage=function(svg,src,x,y,w,h){var el=$("image");$(el,{x:x,y:y,width:w,height:h,preserveAspectRatio:"none"});el.setAttributeNS(svg.xlink,"href",src);svg.canvas&&svg.canvas[appendChild](el);var res=new Element(el,svg);res.attrs={x:x,y:y,width:w,height:h,src:src};res.type="image";return res;};var theText=function(svg,x,y,text){var el=$("text");$(el,{x:x,y:y,"text-anchor":"middle"});svg.canvas&&svg.canvas[appendChild](el);var res=new Element(el,svg);res.attrs={x:x,y:y,"text-anchor":"middle",text:text,font:availableAttrs.font,stroke:"none",fill:"#000"};res.type="text";setFillAndStroke(res,res.attrs);return res;};var setSize=function(width,height){this.width=width||this.width;this.height=height||this.height;this.canvas[setAttribute]("width",this.width);this.canvas[setAttribute]("height",this.height);return this;};var create=function(){var con=getContainer[apply](null,arguments),container=con&&con.container,x=con.x,y=con.y,width=con.width,height=con.height;if(!container){throw new Error("SVG container not found.");}
var cnvs=$("svg");width=width||512;height=height||342;$(cnvs,{xmlns:"http://www.w3.org/2000/svg",version:1.1,width:width,height:height});if(container==1){cnvs.style.cssText="position:absolute;left:"+x+"px;top:"+y+"px";doc.body[appendChild](cnvs);}else{if(container.firstChild){container.insertBefore(cnvs,container.firstChild);}else{container[appendChild](cnvs);}}
container=new Paper;container.width=width;container.height=height;container.canvas=cnvs;plugins.call(container,container,R.fn);container.clear();return container;};Paper[proto].clear=function(){var c=this.canvas;while(c.firstChild){c.removeChild(c.firstChild);}
this.bottom=this.top=null;(this.desc=$("desc"))[appendChild](doc.createTextNode("Created with Rapha\xebl"));c[appendChild](this.desc);c[appendChild](this.defs=$("defs"));};Paper[proto].remove=function(){this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas);for(var i in this){this[i]=removed(i);}};}
if(R.vml){var path2vml=function(path){var total=/[ahqstv]/ig,command=pathToAbsolute;(path+E).match(total)&&(command=path2curve);total=/[clmz]/g;if(command==pathToAbsolute&&!(path+E).match(total)){var map={M:"m",L:"l",C:"c",Z:"x",m:"t",l:"r",c:"v",z:"x"},bites=/([clmz]),?([^clmz]*)/gi,val=/-?[^,\s-]+/g;var res=(path+E)[rp](bites,function(all,command,args){var vals=[];args[rp](val,function(value){vals[push](round(value));});return map[command]+vals;});return res;}
var pa=command(path),p,res=[],r;for(var i=0,ii=pa[length];i<ii;i++){p=pa[i];r=lowerCase.call(pa[i][0]);r=="z"&&(r="x");for(var j=1,jj=p[length];j<jj;j++){r+=round(p[j])+(j!=jj-1?",":E);}
res[push](r);}
return res[join](S);};R[toString]=function(){return"Your browser doesn\u2019t support SVG. Falling down to VML.\nYou are running Rapha\xebl "+this.version;};var thePath=function(pathString,VML){var g=createNode("group");g.style.cssText="position:absolute;left:0;top:0;width:"+VML.width+"px;height:"+VML.height+"px";g.coordsize=VML.coordsize;g.coordorigin=VML.coordorigin;var el=createNode("shape"),ol=el.style;ol.width=VML.width+"px";ol.height=VML.height+"px";el.coordsize=this.coordsize;el.coordorigin=this.coordorigin;g[appendChild](el);var p=new Element(el,g,VML);p.isAbsolute=true;p.type="path";p.path=[];p.Path=E;pathString&&setFillAndStroke(p,{fill:"none",stroke:"#000",path:pathString});VML.canvas[appendChild](g);return p;};var setFillAndStroke=function(o,params){o.attrs=o.attrs||{};var node=o.node,a=o.attrs,s=node.style,xy,res=o;for(var par in params)if(params[has](par)){a[par]=params[par];}
params.href&&(node.href=params.href);params.title&&(node.title=params.title);params.target&&(node.target=params.target);params.cursor&&(s.cursor=params.cursor);if(params.path&&o.type=="path"){a.path=params.path;node.path=path2vml(a.path);}
if(params.rotation!=null){o.rotate(params.rotation,true);}
if(params.translation){xy=(params.translation+E)[split](separator);translate.call(o,xy[0],xy[1]);if(o._.rt.cx!=null){o._.rt.cx+=+xy[0];o._.rt.cy+=+xy[1];o.setBox(o.attrs,xy[0],xy[1]);}}
if(params.scale){xy=(params.scale+E)[split](separator);o.scale(+xy[0]||1,+xy[1]||+xy[0]||1,+xy[2]||null,+xy[3]||null);}
if("clip-rect"in params){var rect=(params["clip-rect"]+E)[split](separator);if(rect[length]==4){rect[2]=+rect[2]+(+rect[0]);rect[3]=+rect[3]+(+rect[1]);var div=node.clipRect||doc.createElement("div"),dstyle=div.style,group=node.parentNode;dstyle.clip=R.format("rect({1}px {2}px {3}px {0}px)",rect);if(!node.clipRect){dstyle.position="absolute";dstyle.top=0;dstyle.left=0;dstyle.width=o.paper.width+"px";dstyle.height=o.paper.height+"px";group.parentNode.insertBefore(div,group);div[appendChild](group);node.clipRect=div;}}
if(!params["clip-rect"]){node.clipRect&&(node.clipRect.style.clip=E);}}
if(o.type=="image"&&params.src){node.src=params.src;}
if(o.type=="image"&&params.opacity){node.filterOpacity=" progid:DXImageTransform.Microsoft.Alpha(opacity="+(params.opacity*100)+")";s.filter=(node.filterMatrix||E)+(node.filterOpacity||E);}
params.font&&(s.font=params.font);params["font-family"]&&(s.fontFamily='"'+params["font-family"][split](",")[0][rp](/^['"]+|['"]+$/g,E)+'"');params["font-size"]&&(s.fontSize=params["font-size"]);params["font-weight"]&&(s.fontWeight=params["font-weight"]);params["font-style"]&&(s.fontStyle=params["font-style"]);if(params.opacity!=null||params["stroke-width"]!=null||params.fill!=null||params.stroke!=null||params["stroke-width"]!=null||params["stroke-opacity"]!=null||params["fill-opacity"]!=null||params["stroke-dasharray"]!=null||params["stroke-miterlimit"]!=null||params["stroke-linejoin"]!=null||params["stroke-linecap"]!=null){node=o.shape||node;var fill=(node.getElementsByTagName("fill")&&node.getElementsByTagName("fill")[0]),newfill=false;!fill&&(newfill=fill=createNode("fill"));if("fill-opacity"in params||"opacity"in params){var opacity=((+a["fill-opacity"]+1||2)-1)*((+a.opacity+1||2)-1);opacity<0&&(opacity=0);opacity>1&&(opacity=1);fill.opacity=opacity;}
params.fill&&(fill.on=true);if(fill.on==null||params.fill=="none"){fill.on=false;}
if(fill.on&&params.fill){var isURL=params.fill.match(ISURL);if(isURL){fill.src=isURL[1];fill.type="tile";}else{fill.color=R.getRGB(params.fill).hex;fill.src=E;fill.type="solid";if(R.getRGB(params.fill).error&&(res.type in{circle:1,ellipse:1}||(params.fill+E).charAt()!="r")&&addGradientFill(res,params.fill)){a.fill="none";a.gradient=params.fill;}}}
newfill&&node[appendChild](fill);var stroke=(node.getElementsByTagName("stroke")&&node.getElementsByTagName("stroke")[0]),newstroke=false;!stroke&&(newstroke=stroke=createNode("stroke"));if((params.stroke&&params.stroke!="none")||params["stroke-width"]||params["stroke-opacity"]!=null||params["stroke-dasharray"]||params["stroke-miterlimit"]||params["stroke-linejoin"]||params["stroke-linecap"]){stroke.on=true;}
(params.stroke=="none"||stroke.on==null||params.stroke==0||params["stroke-width"]==0)&&(stroke.on=false);stroke.on&&params.stroke&&(stroke.color=R.getRGB(params.stroke).hex);var opacity=((+a["stroke-opacity"]+1||2)-1)*((+a.opacity+1||2)-1),width=(toFloat(params["stroke-width"])||1)*.75;opacity<0&&(opacity=0);opacity>1&&(opacity=1);params["stroke-width"]==null&&(width=a["stroke-width"]);params["stroke-width"]&&(stroke.weight=width);width&&width<1&&(opacity*=width)&&(stroke.weight=1);stroke.opacity=opacity;params["stroke-linejoin"]&&(stroke.joinstyle=params["stroke-linejoin"]||"miter");stroke.miterlimit=params["stroke-miterlimit"]||8;params["stroke-linecap"]&&(stroke.endcap=params["stroke-linecap"]=="butt"?"flat":params["stroke-linecap"]=="square"?"square":"round");if(params["stroke-dasharray"]){var dasharray={"-":"shortdash",".":"shortdot","-.":"shortdashdot","-..":"shortdashdotdot",". ":"dot","- ":"dash","--":"longdash","- .":"dashdot","--.":"longdashdot","--..":"longdashdotdot"};stroke.dashstyle=dasharray[has](params["stroke-dasharray"])?dasharray[params["stroke-dasharray"]]:E;}
newstroke&&node[appendChild](stroke);}
if(res.type=="text"){var s=res.paper.span.style;a.font&&(s.font=a.font);a["font-family"]&&(s.fontFamily=a["font-family"]);a["font-size"]&&(s.fontSize=a["font-size"]);a["font-weight"]&&(s.fontWeight=a["font-weight"]);a["font-style"]&&(s.fontStyle=a["font-style"]);res.node.string&&(res.paper.span.innerHTML=(res.node.string+E)[rp](/</g,"&#60;")[rp](/&/g,"&#38;")[rp](/\n/g,"<br>"));res.W=a.w=res.paper.span.offsetWidth;res.H=a.h=res.paper.span.offsetHeight;res.X=a.x;res.Y=a.y+round(res.H/2);switch(a["text-anchor"]){case"start":res.node.style["v-text-align"]="left";res.bbx=round(res.W/2);break;case"end":res.node.style["v-text-align"]="right";res.bbx=-round(res.W/2);break;default:res.node.style["v-text-align"]="center";break;}}};var addGradientFill=function(o,gradient){o.attrs=o.attrs||{};var attrs=o.attrs,fill=o.node.getElementsByTagName("fill"),type="linear",fxfy=".5 .5";o.attrs.gradient=gradient;gradient=(gradient+E)[rp](radial_gradient,function(all,fx,fy){type="radial";if(fx&&fy){fx=toFloat(fx);fy=toFloat(fy);pow(fx-.5,2)+pow(fy-.5,2)>.25&&(fy=math.sqrt(.25-pow(fx-.5,2))*((fy>.5)*2-1)+.5);fxfy=fx+S+fy;}
return E;});gradient=gradient[split](/\s*\-\s*/);if(type=="linear"){var angle=gradient.shift();angle=-toFloat(angle);if(isNaN(angle)){return null;}}
var dots=parseDots(gradient);if(!dots){return null;}
o=o.shape||o.node;fill=fill[0]||createNode("fill");if(dots[length]){fill.on=true;fill.method="none";fill.type=(type=="radial")?"gradientradial":"gradient";fill.color=dots[0].color;fill.color2=dots[dots[length]-1].color;var clrs=[];for(var i=0,ii=dots[length];i<ii;i++){dots[i].offset&&clrs[push](dots[i].offset+S+dots[i].color);}
fill.colors&&(fill.colors.value=clrs[length]?clrs[join](","):"0% "+fill.color);if(type=="radial"){fill.focus="100%";fill.focussize=fxfy;fill.focusposition=fxfy;}else{fill.angle=(270-angle)%360;}}
return 1;};var Element=function(node,group,vml){var Rotation=0,RotX=0,RotY=0,Scale=1;this[0]=node;this.id=R._oid++;this.node=node;node.raphael=this;this.X=0;this.Y=0;this.attrs={};this.Group=group;this.paper=vml;this._={tx:0,ty:0,rt:{deg:0},sx:1,sy:1};!vml.bottom&&(vml.bottom=this);this.prev=vml.top;vml.top&&(vml.top.next=this);vml.top=this;this.next=null;};Element[proto].rotate=function(deg,cx,cy){if(this.removed){return this;}
if(deg==null){if(this._.rt.cx){return[this._.rt.deg,this._.rt.cx,this._.rt.cy][join](S);}
return this._.rt.deg;}
deg=(deg+E)[split](separator);if(deg[length]-1){cx=toFloat(deg[1]);cy=toFloat(deg[2]);}
deg=toFloat(deg[0]);if(cx!=null){this._.rt.deg=deg;}else{this._.rt.deg+=deg;}
cy==null&&(cx=null);this._.rt.cx=cx;this._.rt.cy=cy;this.setBox(this.attrs,cx,cy);this.Group.style.rotation=this._.rt.deg;return this;};Element[proto].setBox=function(params,cx,cy){if(this.removed){return this;}
var gs=this.Group.style,os=(this.shape&&this.shape.style)||this.node.style;params=params||{};for(var i in params)if(params[has](i)){this.attrs[i]=params[i];}
cx=cx||this._.rt.cx;cy=cy||this._.rt.cy;var attr=this.attrs,x,y,w,h;switch(this.type){case"circle":x=attr.cx-attr.r;y=attr.cy-attr.r;w=h=attr.r*2;break;case"ellipse":x=attr.cx-attr.rx;y=attr.cy-attr.ry;w=attr.rx*2;h=attr.ry*2;break;case"rect":case"image":x=+attr.x;y=+attr.y;w=attr.width||0;h=attr.height||0;break;case"text":this.textpath.v=["m",round(attr.x),", ",round(attr.y-2),"l",round(attr.x)+1,", ",round(attr.y-2)][join](E);x=attr.x-round(this.W/2);y=attr.y-this.H/2;w=this.W;h=this.H;break;case"path":if(!this.attrs.path){x=0;y=0;w=this.paper.width;h=this.paper.height;}else{var dim=pathDimensions(this.attrs.path);x=dim.x;y=dim.y;w=dim.width;h=dim.height;}
break;default:x=0;y=0;w=this.paper.width;h=this.paper.height;break;}
cx=(cx==null)?x+w/2:cx;cy=(cy==null)?y+h/2:cy;var left=cx-this.paper.width/2,top=cy-this.paper.height/2;if(this.type=="path"||this.type=="text"){(gs.left!=left+"px")&&(gs.left=left+"px");(gs.top!=top+"px")&&(gs.top=top+"px");this.X=this.type=="text"?x:-left;this.Y=this.type=="text"?y:-top;this.W=w;this.H=h;(os.left!=-left+"px")&&(os.left=-left+"px");(os.top!=-top+"px")&&(os.top=-top+"px");}else{(gs.left!=left+"px")&&(gs.left=left+"px");(gs.top!=top+"px")&&(gs.top=top+"px");this.X=x;this.Y=y;this.W=w;this.H=h;(gs.width!=this.paper.width+"px")&&(gs.width=this.paper.width+"px");(gs.height!=this.paper.height+"px")&&(gs.height=this.paper.height+"px");(os.left!=x-left+"px")&&(os.left=x-left+"px");(os.top!=y-top+"px")&&(os.top=y-top+"px");(os.width!=w+"px")&&(os.width=w+"px");(os.height!=h+"px")&&(os.height=h+"px");var arcsize=(+params.r||0)/mmin(w,h);if(this.type=="rect"&&this.arcsize.toFixed(4)!=arcsize.toFixed(4)&&(arcsize||this.arcsize)){var o=createNode("roundrect"),a={},i=0,ii=this.events&&this.events[length];o.arcsize=arcsize;o.raphael=this;this.Group[appendChild](o);this.Group.removeChild(this.node);this[0]=this.node=o;this.arcsize=arcsize;for(var i in attr){a[i]=attr[i];}
delete a.scale;this.attr(a);if(this.events)for(;i<ii;i++){this.events[i].unbind=addEvent(this.node,this.events[i].name,this.events[i].f,this);}}}};Element[proto].hide=function(){!this.removed&&(this.Group.style.display="none");return this;};Element[proto].show=function(){!this.removed&&(this.Group.style.display="block");return this;};Element[proto].getBBox=function(){if(this.removed){return this;}
if(this.type=="path"){return pathDimensions(this.attrs.path);}
return{x:this.X+(this.bbx||0),y:this.Y,width:this.W,height:this.H};};Element[proto].remove=function(){if(this.removed){return;}
tear(this,this.paper);this.node.parentNode.removeChild(this.node);this.Group.parentNode.removeChild(this.Group);this.shape&&this.shape.parentNode.removeChild(this.shape);for(var i in this){delete this[i];}
this.removed=true;};Element[proto].attr=function(){if(this.removed){return this;}
if(arguments[length]==0){var res={};for(var i in this.attrs)if(this.attrs[has](i)){res[i]=this.attrs[i];}
this._.rt.deg&&(res.rotation=this.rotate());(this._.sx!=1||this._.sy!=1)&&(res.scale=this.scale());res.gradient&&res.fill=="none"&&(res.fill=res.gradient)&&delete res.gradient;return res;}
if(arguments[length]==1&&R.is(arguments[0],"string")){if(arguments[0]=="translation"){return translate.call(this);}
if(arguments[0]=="rotation"){return this.rotate();}
if(arguments[0]=="scale"){return this.scale();}
if(arguments[0]=="fill"&&this.attrs.fill=="none"&&this.attrs.gradient){return this.attrs.gradient;}
return this.attrs[arguments[0]];}
if(this.attrs&&arguments[length]==1&&R.is(arguments[0],"array")){var values={};for(var i=0,ii=arguments[0][length];i<ii;i++){values[arguments[0][i]]=this.attrs[arguments[0][i]];};return values;}
var params;if(arguments[length]==2){params={};params[arguments[0]]=arguments[1];}
arguments[length]==1&&R.is(arguments[0],"object")&&(params=arguments[0]);if(params){if(params.text&&this.type=="text"){this.node.string=params.text;}
setFillAndStroke(this,params);if(params.gradient&&(({circle:1,ellipse:1})[has](this.type)||(params.gradient+E).charAt()!="r")){addGradientFill(this,params.gradient);}
(this.type!="path"||this._.rt.deg)&&this.setBox(this.attrs);}
return this;};Element[proto].toFront=function(){!this.removed&&this.Group.parentNode[appendChild](this.Group);this.paper.top!=this&&tofront(this,this.paper);return this;};Element[proto].toBack=function(){if(this.removed){return this;}
if(this.Group.parentNode.firstChild!=this.Group){this.Group.parentNode.insertBefore(this.Group,this.Group.parentNode.firstChild);toback(this,this.paper);}
return this;};Element[proto].insertAfter=function(element){if(this.removed){return this;}
if(element.Group.nextSibling){element.Group.parentNode.insertBefore(this.Group,element.Group.nextSibling);}else{element.Group.parentNode[appendChild](this.Group);}
insertafter(this,element,this.paper);return this;};Element[proto].insertBefore=function(element){if(this.removed){return this;}
element.Group.parentNode.insertBefore(this.Group,element.Group);insertbefore(this,element,this.paper);return this;};var theCircle=function(vml,x,y,r){var g=createNode("group"),o=createNode("oval"),ol=o.style;g.style.cssText="position:absolute;left:0;top:0;width:"+vml.width+"px;height:"+vml.height+"px";g.coordsize=vml.coordsize;g.coordorigin=vml.coordorigin;g[appendChild](o);var res=new Element(o,g,vml);res.type="circle";setFillAndStroke(res,{stroke:"#000",fill:"none"});res.attrs.cx=x;res.attrs.cy=y;res.attrs.r=r;res.setBox({x:x-r,y:y-r,width:r*2,height:r*2});vml.canvas[appendChild](g);return res;},theRect=function(vml,x,y,w,h,r){var g=createNode("group"),o=createNode("roundrect"),arcsize=(+r||0)/(mmin(w,h));g.style.cssText="position:absolute;left:0;top:0;width:"+vml.width+"px;height:"+vml.height+"px";g.coordsize=vml.coordsize;g.coordorigin=vml.coordorigin;g[appendChild](o);o.arcsize=arcsize;var res=new Element(o,g,vml);res.type="rect";setFillAndStroke(res,{stroke:"#000"});res.arcsize=arcsize;res.setBox({x:x,y:y,width:w,height:h,r:r});vml.canvas[appendChild](g);return res;},theEllipse=function(vml,x,y,rx,ry){var g=createNode("group"),o=createNode("oval"),ol=o.style;g.style.cssText="position:absolute;left:0;top:0;width:"+vml.width+"px;height:"+vml.height+"px";g.coordsize=vml.coordsize;g.coordorigin=vml.coordorigin;g[appendChild](o);var res=new Element(o,g,vml);res.type="ellipse";setFillAndStroke(res,{stroke:"#000"});res.attrs.cx=x;res.attrs.cy=y;res.attrs.rx=rx;res.attrs.ry=ry;res.setBox({x:x-rx,y:y-ry,width:rx*2,height:ry*2});vml.canvas[appendChild](g);return res;},theImage=function(vml,src,x,y,w,h){var g=createNode("group"),o=createNode("image"),ol=o.style;g.style.cssText="position:absolute;left:0;top:0;width:"+vml.width+"px;height:"+vml.height+"px";g.coordsize=vml.coordsize;g.coordorigin=vml.coordorigin;o.src=src;g[appendChild](o);var res=new Element(o,g,vml);res.type="image";res.attrs.src=src;res.attrs.x=x;res.attrs.y=y;res.attrs.w=w;res.attrs.h=h;res.setBox({x:x,y:y,width:w,height:h});vml.canvas[appendChild](g);return res;},theText=function(vml,x,y,text){var g=createNode("group"),el=createNode("shape"),ol=el.style,path=createNode("path"),ps=path.style,o=createNode("textpath");g.style.cssText="position:absolute;left:0;top:0;width:"+vml.width+"px;height:"+vml.height+"px";g.coordsize=vml.coordsize;g.coordorigin=vml.coordorigin;path.v=R.format("m{0},{1}l{2},{1}",round(x),round(y),round(x)+1);path.textpathok=true;ol.width=vml.width;ol.height=vml.height;o.string=text+E;o.on=true;el[appendChild](o);el[appendChild](path);g[appendChild](el);var res=new Element(o,g,vml);res.shape=el;res.textpath=path;res.type="text";res.attrs.text=text;res.attrs.x=x;res.attrs.y=y;res.attrs.w=1;res.attrs.h=1;setFillAndStroke(res,{font:availableAttrs.font,stroke:"none",fill:"#000"});res.setBox();vml.canvas[appendChild](g);return res;},setSize=function(width,height){var cs=this.canvas.style;width==+width&&(width+="px");height==+height&&(height+="px");cs.width=width;cs.height=height;cs.clip="rect(0 "+width+" "+height+" 0)";return this;},createNode;doc.createStyleSheet().addRule(".rvml","behavior:url(#default#VML)");try{!doc.namespaces.rvml&&doc.namespaces.add("rvml","urn:schemas-microsoft-com:vml");createNode=function(tagName){return doc.createElement('<rvml:'+tagName+' class="rvml">');};}catch(e){createNode=function(tagName){return doc.createElement('<'+tagName+' xmlns="urn:schemas-microsoft.com:vml" class="rvml">');};}
var create=function(){var con=getContainer[apply](null,arguments),container=con.container,height=con.height,s,width=con.width,x=con.x,y=con.y;if(!container){throw new Error("VML container not found.");}
var res=new Paper,c=res.canvas=doc.createElement("div"),cs=c.style;width=width||512;height=height||342;width==+width&&(width+="px");height==+height&&(height+="px");res.width=1e3;res.height=1e3;res.coordsize="1000 1000";res.coordorigin="0 0";res.span=doc.createElement("span");res.span.style.cssText="position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;display:inline;";c[appendChild](res.span);cs.cssText=R.format("width:{0};height:{1};position:absolute;clip:rect(0 {0} {1} 0);overflow:hidden",width,height);if(container==1){doc.body[appendChild](c);cs.left=x+"px";cs.top=y+"px";}else{container.style.width=width;container.style.height=height;if(container.firstChild){container.insertBefore(c,container.firstChild);}else{container[appendChild](c);}}
plugins.call(res,res,R.fn);return res;};Paper[proto].clear=function(){this.canvas.innerHTML=E;this.span=doc.createElement("span");this.span.style.cssText="position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;display:inline;";this.canvas[appendChild](this.span);this.bottom=this.top=null;};Paper[proto].remove=function(){this.canvas.parentNode.removeChild(this.canvas);for(var i in this){this[i]=removed(i);}};}
if((/^Apple|^Google/).test(navigator.vendor)&&!(navigator.userAgent.indexOf("Version/4.0")+1)){Paper[proto].safari=function(){var rect=this.rect(-99,-99,this.width+99,this.height+99);setTimeout(function(){rect.remove();});};}else{Paper[proto].safari=function(){};}
var addEvent=(function(){if(doc.addEventListener){return function(obj,type,fn,element){var f=function(e){return fn.call(element,e);};obj.addEventListener(type,f,false);return function(){obj.removeEventListener(type,f,false);return true;};};}else if(doc.attachEvent){return function(obj,type,fn,element){var f=function(e){return fn.call(element,e||win.event);};obj.attachEvent("on"+type,f);var detacher=function(){obj.detachEvent("on"+type,f);return true;};return detacher;};}})();for(var i=events[length];i--;){(function(eventName){Element[proto][eventName]=function(fn){if(R.is(fn,"function")){this.events=this.events||[];this.events.push({name:eventName,f:fn,unbind:addEvent(this.shape||this.node,eventName,fn,this)});}
return this;};Element[proto]["un"+eventName]=function(fn){var events=this.events,l=events[length];while(l--)if(events[l].name==eventName&&events[l].f==fn){events[l].unbind();events.splice(l,1);!events.length&&delete this.events;return this;}
return this;};})(events[i]);}
Element[proto].hover=function(f_in,f_out){return this.mouseover(f_in).mouseout(f_out);};Element[proto].unhover=function(f_in,f_out){return this.unmouseover(f_in).unmouseout(f_out);};Paper[proto].circle=function(x,y,r){return theCircle(this,x||0,y||0,r||0);};Paper[proto].rect=function(x,y,w,h,r){return theRect(this,x||0,y||0,w||0,h||0,r||0);};Paper[proto].ellipse=function(x,y,rx,ry){return theEllipse(this,x||0,y||0,rx||0,ry||0);};Paper[proto].path=function(pathString){pathString&&!R.is(pathString,"string")&&!R.is(pathString[0],"array")&&(pathString+=E);return thePath(R.format[apply](R,arguments),this);};Paper[proto].image=function(src,x,y,w,h){return theImage(this,src||"about:blank",x||0,y||0,w||0,h||0);};Paper[proto].text=function(x,y,text){return theText(this,x||0,y||0,text||E);};Paper[proto].set=function(itemsArray){arguments[length]>1&&(itemsArray=Array[proto].splice.call(arguments,0,arguments[length]));return new Set(itemsArray);};Paper[proto].setSize=setSize;Paper[proto].top=Paper[proto].bottom=null;Paper[proto].raphael=R;function x_y(){return this.x+S+this.y;};Element[proto].scale=function(x,y,cx,cy){if(x==null&&y==null){return{x:this._.sx,y:this._.sy,toString:x_y};}
y=y||x;!+y&&(y=x);var dx,dy,dcx,dcy,a=this.attrs;if(x!=0){var bb=this.getBBox(),rcx=bb.x+bb.width/2,rcy=bb.y+bb.height/2,kx=x/this._.sx,ky=y/this._.sy;cx=(+cx||cx==0)?cx:rcx;cy=(+cy||cy==0)?cy:rcy;var dirx=~~(x/math.abs(x)),diry=~~(y/math.abs(y)),s=this.node.style,ncx=cx+(rcx-cx)*kx,ncy=cy+(rcy-cy)*ky;switch(this.type){case"rect":case"image":var neww=a.width*dirx*kx,newh=a.height*diry*ky;this.attr({height:newh,r:a.r*mmin(dirx*kx,diry*ky),width:neww,x:ncx-neww/2,y:ncy-newh/2});break;case"circle":case"ellipse":this.attr({rx:a.rx*dirx*kx,ry:a.ry*diry*ky,r:a.r*mmin(dirx*kx,diry*ky),cx:ncx,cy:ncy});break;case"path":var path=pathToRelative(a.path),skip=true;for(var i=0,ii=path[length];i<ii;i++){var p=path[i],j,P0=upperCase.call(p[0]);if(P0=="M"&&skip){continue;}else{skip=false;}
if(P0=="A"){p[path[i][length]-2]*=kx;p[path[i][length]-1]*=ky;p[1]*=dirx*kx;p[2]*=diry*ky;p[5]=+(dirx+diry?!!+p[5]:!+p[5]);}else if(P0=="H"){for(j=1,jj=p[length];j<jj;j++){p[j]*=kx;}}else if(P0=="V"){for(j=1,jj=p[length];j<jj;j++){p[j]*=ky;}}else{for(j=1,jj=p[length];j<jj;j++){p[j]*=(j%2)?kx:ky;}}}
var dim2=pathDimensions(path),dx=ncx-dim2.x-dim2.width/2,dy=ncy-dim2.y-dim2.height/2;path[0][1]+=dx;path[0][2]+=dy;this.attr({path:path});break;}
if(this.type in{text:1,image:1}&&(dirx!=1||diry!=1)){if(this.transformations){this.transformations[2]="scale("[concat](dirx,",",diry,")");this.node[setAttribute]("transform",this.transformations[join](S));dx=(dirx==-1)?-a.x-(neww||0):a.x;dy=(diry==-1)?-a.y-(newh||0):a.y;this.attr({x:dx,y:dy});a.fx=dirx-1;a.fy=diry-1;}else{this.node.filterMatrix=" progid:DXImageTransform.Microsoft.Matrix(M11="[concat](dirx,", M12=0, M21=0, M22=",diry,", Dx=0, Dy=0, sizingmethod='auto expand', filtertype='bilinear')");s.filter=(this.node.filterMatrix||E)+(this.node.filterOpacity||E);}}else{if(this.transformations){this.transformations[2]=E;this.node[setAttribute]("transform",this.transformations[join](S));a.fx=0;a.fy=0;}else{this.node.filterMatrix=E;s.filter=(this.node.filterMatrix||E)+(this.node.filterOpacity||E);}}
a.scale=[x,y,cx,cy][join](S);this._.sx=x;this._.sy=y;}
return this;};Element[proto].clone=function(){var attr=this.attr();delete attr.scale;delete attr.translation;return this.paper[this.type]().attr(attr);};var getLengthFactory=function(istotal,subpath){return function(path,length,onlystart){path=path2curve(path);var x,y,p,l,sp="",subpaths={},point,len=0;for(var i=0,ii=path.length;i<ii;i++){p=path[i];if(p[0]=="M"){x=+p[1];y=+p[2];}else{l=segmentLength(x,y,p[1],p[2],p[3],p[4],p[5],p[6]);if(len+l>length){if(subpath&&!subpaths.start){point=R.findDotsAtSegment(x,y,p[1],p[2],p[3],p[4],p[5],p[6],(length-len)/l);sp+=["C",point.start.x,point.start.y,point.m.x,point.m.y,point.x,point.y];if(onlystart)return sp;subpaths.start=sp;sp=["M",point.x,point.y+"C",point.n.x,point.n.y,point.end.x,point.end.y,p[5],p[6]][join]();len+=l;x=+p[5];y=+p[6];continue;}
if(!istotal&&!subpath){point=R.findDotsAtSegment(x,y,p[1],p[2],p[3],p[4],p[5],p[6],(length-len)/l);return{x:point.x,y:point.y,alpha:point.alpha};}}
len+=l;x=+p[5];y=+p[6];}
sp+=p;}
subpaths.end=sp;point=istotal?len:subpath?subpaths:R.findDotsAtSegment(x,y,p[1],p[2],p[3],p[4],p[5],p[6],1);point.alpha&&(point={x:point.x,y:point.y,alpha:point.alpha});return point;};},segmentLength=cacher(function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y){var old={x:0,y:0},len=0;for(var i=0;i<1.01;i+=.01){var dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,i);i&&(len+=math.sqrt(pow(old.x-dot.x,2)+pow(old.y-dot.y,2)));old=dot;}
return len;});var getTotalLength=getLengthFactory(1),getPointAtLength=getLengthFactory(),getSubpathsAtLength=getLengthFactory(0,1);Element[proto].getTotalLength=function(){if(this.type!="path")return;return getTotalLength(this.attrs.path);};Element[proto].getPointAtLength=function(length){if(this.type!="path")return;return getPointAtLength(this.attrs.path,length);};Element[proto].getSubpath=function(from,to){if(this.type!="path")return;if(math.abs(this.getTotalLength()-to)<1e-6){return getSubpathsAtLength(this.attrs.path,from).end;}
var a=getSubpathsAtLength(this.attrs.path,to,1);return from?getSubpathsAtLength(a,from).end:a;};R.easing_formulas={linear:function(n){return n;},"<":function(n){return pow(n,3);},">":function(n){return pow(n-1,3)+1;},"<>":function(n){n=n*2;if(n<1){return pow(n,3)/2;}
n-=2;return(pow(n,3)+2)/2;},backIn:function(n){var s=1.70158;return n*n*((s+1)*n-s);},backOut:function(n){n=n-1;var s=1.70158;return n*n*((s+1)*n+s)+1;},elastic:function(n){if(n==0||n==1){return n;}
var p=.3,s=p/4;return pow(2,-10*n)*math.sin((n-s)*(2*math.PI)/p)+1;},bounce:function(n){var s=7.5625,p=2.75,l;if(n<(1/p)){l=s*n*n;}else{if(n<(2/p)){n-=(1.5/p);l=s*n*n+.75;}else{if(n<(2.5/p)){n-=(2.25/p);l=s*n*n+.9375;}else{n-=(2.625/p);l=s*n*n+.984375;}}}
return l;}};var animationElements={length:0},animation=function(){var Now=+new Date;for(var l in animationElements)if(l!="length"&&animationElements[has](l)){var e=animationElements[l];if(e.stop){delete animationElements[l];animationElements[length]--;continue;}
var time=Now-e.start,ms=e.ms,easing=e.easing,from=e.from,diff=e.diff,to=e.to,t=e.t,prev=e.prev||0,that=e.el,callback=e.callback,set={},now;if(time<ms){var pos=R.easing_formulas[easing]?R.easing_formulas[easing](time/ms):time/ms;for(var attr in from)if(from[has](attr)){switch(availableAnimAttrs[attr]){case"along":now=pos*ms*diff[attr];to.back&&(now=to.len-now);var point=getPointAtLength(to[attr],now);that.translate(diff.sx-diff.x||0,diff.sy-diff.y||0);diff.x=point.x;diff.y=point.y;that.translate(point.x-diff.sx,point.y-diff.sy);to.rot&&that.rotate(diff.r+point.alpha,point.x,point.y);break;case"number":now=+from[attr]+pos*ms*diff[attr];break;case"colour":now="rgb("+[upto255(round(from[attr].r+pos*ms*diff[attr].r)),upto255(round(from[attr].g+pos*ms*diff[attr].g)),upto255(round(from[attr].b+pos*ms*diff[attr].b))][join](",")+")";break;case"path":now=[];for(var i=0,ii=from[attr][length];i<ii;i++){now[i]=[from[attr][i][0]];for(var j=1,jj=from[attr][i][length];j<jj;j++){now[i][j]=+from[attr][i][j]+pos*ms*diff[attr][i][j];}
now[i]=now[i][join](S);}
now=now[join](S);break;case"csv":switch(attr){case"translation":var x=diff[attr][0]*(time-prev),y=diff[attr][1]*(time-prev);t.x+=x;t.y+=y;now=x+S+y;break;case"rotation":now=+from[attr][0]+pos*ms*diff[attr][0];from[attr][1]&&(now+=","+from[attr][1]+","+from[attr][2]);break;case"scale":now=[+from[attr][0]+pos*ms*diff[attr][0],+from[attr][1]+pos*ms*diff[attr][1],(2 in to[attr]?to[attr][2]:E),(3 in to[attr]?to[attr][3]:E)][join](S);break;case"clip-rect":now=[];var i=4;while(i--){now[i]=+from[attr][i]+pos*ms*diff[attr][i];}
break;}
break;}
set[attr]=now;}
that.attr(set);that._run&&that._run.call(that);}else{if(to.along){var point=getPointAtLength(to.along,to.len*!to.back);that.translate(diff.sx-(diff.x||0)+point.x-diff.sx,diff.sy-(diff.y||0)+point.y-diff.sy);to.rot&&that.rotate(diff.r+point.alpha,point.x,point.y);}
(t.x||t.y)&&that.translate(-t.x,-t.y);to.scale&&(to.scale=to.scale+E);that.attr(to);delete animationElements[l];animationElements[length]--;that.in_animation=null;R.is(callback,"function")&&callback.call(that);}
e.prev=time;}
R.svg&&that&&that.paper.safari();animationElements[length]&&setTimeout(animation);},upto255=function(color){return color>255?255:(color<0?0:color);},translate=function(x,y){if(x==null){return{x:this._.tx,y:this._.ty,toString:x_y};}
this._.tx+=+x;this._.ty+=+y;switch(this.type){case"circle":case"ellipse":this.attr({cx:+x+this.attrs.cx,cy:+y+this.attrs.cy});break;case"rect":case"image":case"text":this.attr({x:+x+this.attrs.x,y:+y+this.attrs.y});break;case"path":var path=pathToRelative(this.attrs.path);path[0][1]+=+x;path[0][2]+=+y;this.attr({path:path});break;}
return this;};Element[proto].animateWith=function(element,params,ms,easing,callback){animationElements[element.id]&&(params.start=animationElements[element.id].start);return this.animate(params,ms,easing,callback);};Element[proto].animateAlong=along();Element[proto].animateAlongBack=along(1);function along(isBack){return function(path,ms,rotate,callback){var params={back:isBack};R.is(rotate,"function")?(callback=rotate):(params.rot=rotate);path&&path.constructor==Element&&(path=path.attrs.path);path&&(params.along=path);return this.animate(params,ms,callback);};}
Element[proto].onAnimation=function(f){this._run=f||0;return this;};Element[proto].animate=function(params,ms,easing,callback){if(R.is(easing,"function")||!easing){callback=easing||null;}
var from={},to={},diff={};for(var attr in params)if(params[has](attr)){if(availableAnimAttrs[has](attr)){from[attr]=this.attr(attr);(from[attr]==null)&&(from[attr]=availableAttrs[attr]);to[attr]=params[attr];switch(availableAnimAttrs[attr]){case"along":var len=getTotalLength(params[attr]),point=getPointAtLength(params[attr],len*!!params.back),bb=this.getBBox();diff[attr]=len/ms;diff.tx=bb.x;diff.ty=bb.y;diff.sx=point.x;diff.sy=point.y;to.rot=params.rot;to.back=params.back;to.len=len;params.rot&&(diff.r=toFloat(this.rotate())||0);break;case"number":diff[attr]=(to[attr]-from[attr])/ms;break;case"colour":from[attr]=R.getRGB(from[attr]);var toColour=R.getRGB(to[attr]);diff[attr]={r:(toColour.r-from[attr].r)/ms,g:(toColour.g-from[attr].g)/ms,b:(toColour.b-from[attr].b)/ms};break;case"path":var pathes=path2curve(from[attr],to[attr]);from[attr]=pathes[0];var toPath=pathes[1];diff[attr]=[];for(var i=0,ii=from[attr][length];i<ii;i++){diff[attr][i]=[0];for(var j=1,jj=from[attr][i][length];j<jj;j++){diff[attr][i][j]=(toPath[i][j]-from[attr][i][j])/ms;}}
break;case"csv":var values=(params[attr]+E)[split](separator),from2=(from[attr]+E)[split](separator);switch(attr){case"translation":from[attr]=[0,0];diff[attr]=[values[0]/ms,values[1]/ms];break;case"rotation":from[attr]=(from2[1]==values[1]&&from2[2]==values[2])?from2:[0,values[1],values[2]];diff[attr]=[(values[0]-from[attr][0])/ms,0,0];break;case"scale":params[attr]=values;from[attr]=(from[attr]+E)[split](separator);diff[attr]=[(values[0]-from[attr][0])/ms,(values[1]-from[attr][1])/ms,0,0];break;case"clip-rect":from[attr]=(from[attr]+E)[split](separator);diff[attr]=[];var i=4;while(i--){diff[attr][i]=(values[i]-from[attr][i])/ms;}
break;}
to[attr]=values;}}}
this.stop();this.in_animation=1;animationElements[this.id]={start:params.start||+new Date,ms:ms,easing:easing,from:from,diff:diff,to:to,el:this,callback:callback,t:{x:0,y:0}};++animationElements[length]==1&&animation();return this;};Element[proto].stop=function(){animationElements[this.id]&&animationElements[length]--;delete animationElements[this.id];return this;};Element[proto].translate=function(x,y){return this.attr({translation:x+" "+y});};Element[proto][toString]=function(){return"Rapha\xebl\u2019s object";};R.ae=animationElements;var Set=function(items){this.items=[];this[length]=0;if(items){for(var i=0,ii=items[length];i<ii;i++){if(items[i]&&(items[i].constructor==Element||items[i].constructor==Set)){this[this.items[length]]=this.items[this.items[length]]=items[i];this[length]++;}}}};Set[proto][push]=function(){var item,len;for(var i=0,ii=arguments[length];i<ii;i++){item=arguments[i];if(item&&(item.constructor==Element||item.constructor==Set)){len=this.items[length];this[len]=this.items[len]=item;this[length]++;}}
return this;};Set[proto].pop=function(){delete this[this[length]--];return this.items.pop();};for(var method in Element[proto])if(Element[proto][has](method)){Set[proto][method]=(function(methodname){return function(){for(var i=0,ii=this.items[length];i<ii;i++){this.items[i][methodname][apply](this.items[i],arguments);}
return this;};})(method);}
Set[proto].attr=function(name,value){if(name&&R.is(name,"array")&&R.is(name[0],"object")){for(var j=0,jj=name[length];j<jj;j++){this.items[j].attr(name[j]);}}else{for(var i=0,ii=this.items[length];i<ii;i++){this.items[i].attr[apply](this.items[i],arguments);}}
return this;};Set[proto].animate=function(params,ms,easing,callback){(R.is(easing,"function")||!easing)&&(callback=easing||null);var len=this.items[length],i=len,set=this,collector;callback&&(collector=function(){!--len&&callback.call(set);});this.items[--i].animate(params,ms,easing||collector,collector);while(i--){this.items[i].animateWith(this.items[len-1],params,ms,easing||collector,collector);}
return this;};Set[proto].insertAfter=function(el){var i=this.items[length];while(i--){this.items[i].insertAfter(el);}
return this;};Set[proto].getBBox=function(){var x=[],y=[],w=[],h=[];for(var i=this.items[length];i--;){var box=this.items[i].getBBox();x[push](box.x);y[push](box.y);w[push](box.x+box.width);h[push](box.y+box.height);}
x=mmin[apply](0,x);y=mmin[apply](0,y);return{x:x,y:y,width:mmax[apply](0,w)-x,height:mmax[apply](0,h)-y};};R.registerFont=function(font){if(!font.face){return font;}
this.fonts=this.fonts||{};var fontcopy={w:font.w,face:{},glyphs:{}},family=font.face["font-family"];for(var prop in font.face)if(font.face[has](prop)){fontcopy.face[prop]=font.face[prop];}
if(this.fonts[family]){this.fonts[family][push](fontcopy);}else{this.fonts[family]=[fontcopy];}
if(!font.svg){fontcopy.face["units-per-em"]=toInt(font.face["units-per-em"],10);for(var glyph in font.glyphs)if(font.glyphs[has](glyph)){var path=font.glyphs[glyph];fontcopy.glyphs[glyph]={w:path.w,k:{},d:path.d&&"M"+path.d[rp](/[mlcxtrv]/g,function(command){return{l:"L",c:"C",x:"z",t:"m",r:"l",v:"c"}[command]||"M";})+"z"};if(path.k){for(var k in path.k)if(path[has](k)){fontcopy.glyphs[glyph].k[k]=path.k[k];}}}}
return font;};Paper[proto].getFont=function(family,weight,style,stretch){stretch=stretch||"normal";style=style||"normal";weight=+weight||{normal:400,bold:700,lighter:300,bolder:800}[weight]||400;var font=R.fonts[family];if(!font){var name=new RegExp("(^|\\s)"+family[rp](/[^\w\d\s+!~.:_-]/g,E)+"(\\s|$)","i");for(var fontName in R.fonts)if(R.fonts[has](fontName)){if(name.test(fontName)){font=R.fonts[fontName];break;}}}
var thefont;if(font){for(var i=0,ii=font[length];i<ii;i++){thefont=font[i];if(thefont.face["font-weight"]==weight&&(thefont.face["font-style"]==style||!thefont.face["font-style"])&&thefont.face["font-stretch"]==stretch){break;}}}
return thefont;};Paper[proto].print=function(x,y,string,font,size,origin){origin=origin||"middle";var out=this.set(),letters=(string+E)[split](E),shift=0,path=E,scale;R.is(font,"string")&&(font=this.getFont(font));if(font){scale=(size||16)/font.face["units-per-em"];var bb=font.face.bbox.split(separator),top=+bb[0],height=+bb[1]+(origin=="baseline"?bb[3]-bb[1]+(+font.face.descent):(bb[3]-bb[1])/2);for(var i=0,ii=letters[length];i<ii;i++){var prev=i&&font.glyphs[letters[i-1]]||{},curr=font.glyphs[letters[i]];shift+=i?(prev.w||font.w)+(prev.k&&prev.k[letters[i]]||0):0;curr&&curr.d&&out[push](this.path(curr.d).attr({fill:"#000",stroke:"none",translation:[shift,0]}));}
out.scale(scale,scale,top,height).translate(x-top,y-height);}
return out;};R.format=function(token){var args=R.is(arguments[1],"array")?[0][concat](arguments[1]):arguments,rg=/\{(\d+)\}/g;token&&R.is(token,"string")&&args[length]-1&&(token=token[rp](rg,function(str,i){return args[++i]==null?E:args[i];}));return token||E;};R.ninja=function(){var r=Raphael;if(oldRaphael.was){Raphael=oldRaphael.is;}else{delete Raphael;}
return r;};R.el=Element[proto];return R;})();Raphael.el.anim=function(opts){if(opts['target']){if(opts['easing']){this.animateWith(opts['target'],opts['attrs'],opts['ms'],opts['callback']);}else{this.animateWith(opts['target'],opts['attrs'],opts['ms'],opts['easing'],opts['callback']);}}else{if(opts['easing']){this.animate(opts['attrs'],opts['ms'],opts['callback']);}else{this.animate(opts['attrs'],opts['ms'],opts['easing'],opts['callback']);}}};Raphael.fn.anim=Raphael.el.anim;madrona.measureConvTable=[['metric',[['m',1,500],['km',0.001,null]],[['sq m',1,100000],['sq km',0.000001,null]]],['english',[['ft',3.2808399,0.9144],['mi',0.000621371192,null]],[['sq ft',10.7639104,25899.8811],['sq mi',0.000000386102159,null]]],['nautical',[['naut mi',0.000539956803,null]],[['sq naut mi',0.00000029155335,null]]]];madrona.measureTool=function(){this.placemark=null;this.distTarget=null;this.areaTarget=null;this.gex=null;this.area=0.0;this.distance=0.0;this.units='metric';this.area_unit='sq m';this.distance_unit='m';};madrona.measureTool.prototype.clear=function()
{this.area=0.0;this.distance=0.0;if(this.placemark)
{if(this.distTarget)
{this.gex.edit.endEditLineString(this.placemark.getGeometry());document.getElementById(this.distTarget).innerHTML='N/A';this.distTarget=null;}
if(this.areaTarget)
{this.gex.edit.endEditLineString(this.placemark.getGeometry().getOuterBoundary());document.getElementById(this.areaTarget).innerHTML='N/A';this.areaTarget=null;}
this.gex.dom.removeObject(this.placemark);this.placemark=null;}};madrona.measureTool.prototype.setUnits=function(units){this.units=units;this.updateDistance();};madrona.measureTool.prototype.measureArea=function(gex,areaSpanId)
{var self=this;this.gex=gex;this.clear();this.areaTarget=areaSpanId;this.placemark=gex.dom.addPlacemark({polygon:[],style:{line:{width:2,color:'#ff0'},poly:{color:'8000ffff'}}});var drawLineStringOptions={bounce:false,drawCallback:function(){self.updateDistance();},finishCallback:function(){var editLineStringOptions={editCallback:function(){self.updateDistance();}}
gex.edit.editLineString(self.placemark.getGeometry().getOuterBoundary(),editLineStringOptions);}};gex.edit.drawLineString(this.placemark.getGeometry().getOuterBoundary(),drawLineStringOptions);};madrona.measureTool.prototype.measureDistance=function(gex,distSpanId)
{var self=this;this.gex=gex;this.clear();this.distTarget=distSpanId;this.placemark=gex.dom.addPlacemark({lineString:[],style:{line:{width:2,color:'#ff0'}}});var drawLineStringOptions={bounce:false,drawCallback:function(){self.updateDistance();},finishCallback:function(){var editLineStringOptions={editCallback:function(){self.updateDistance();}}
gex.edit.editLineString(self.placemark.getGeometry(),editLineStringOptions);}};gex.edit.drawLineString(this.placemark.getGeometry(),drawLineStringOptions);};madrona.measureTool.prototype.convertMetricValue=function(measure_type_str,value)
{var SYSTEM=0;var DISTANCE_MAPPINGS=1;var AREA_MAPPINGS=2;var UNIT=0;var CONVERSION_FACTOR=1;var RANGE_MAX=2;var measure_type=DISTANCE_MAPPINGS;if(measure_type_str=='area')
measure_type=AREA_MAPPINGS;for(var system_iter=0;system_iter<madrona.measureConvTable.length;system_iter++)
{if(madrona.measureConvTable[system_iter][SYSTEM]==this.units)
{for(var unit_iter=0;unit_iter<madrona.measureConvTable[system_iter][measure_type].length;unit_iter++)
{if(value<madrona.measureConvTable[system_iter][measure_type][unit_iter][RANGE_MAX]||madrona.measureConvTable[system_iter][measure_type][unit_iter][RANGE_MAX]==null)
return[value*madrona.measureConvTable[system_iter][measure_type][unit_iter][CONVERSION_FACTOR],madrona.measureConvTable[system_iter][measure_type][unit_iter][UNIT]];}}}
return[0,'invalid units set'];};madrona.measureTool.prototype.updateDistance=function()
{if(this.areaTarget)
{this.area=new geo.Polygon(this.placemark.getGeometry()).area();converted_val_n_unit=this.convertMetricValue('area',this.area);this.area=converted_val_n_unit[0];this.area_unit=converted_val_n_unit[1];document.getElementById(this.areaTarget).innerHTML=this.area.toFixed(2)+' '+this.area_unit;}
if(this.distTarget)
{this.distance=new geo.Path(this.placemark.getGeometry()).distance();converted_val_n_unit=this.convertMetricValue('distance',this.distance);this.distance=converted_val_n_unit[0];this.distance_unit=converted_val_n_unit[1];document.getElementById(this.distTarget).innerHTML=this.distance.toFixed(2)+' '+this.distance_unit;}};if(typeof madrona=='undefined'){madrona={};}
madrona.layout={};madrona.panel=function(options){var defaults={hideOnly:false,showCloseButton:true,content:false,appendTo:window.document.body,scrollable:true}
var that={options:$.extend({},defaults,options),shown:false};if(madrona&&madrona.addPanel){madrona.addPanel(that);}
var s='';var loader;if(!that.options.showCloseButton){s='display:none';}
var close='<a style="'+s+'" class="close" href="#"><img src="'+madrona.options.media_url+'common/images/close.png" width="17" height="16" /></a>';var other_classes=that.options.scrollable?'':'madrona-panel-noscroll';var el=$('<div style="display:none;" class="madrona-panel '+other_classes+'"><div class="loadingMask"><span>Loading</span></div><div class="panelMask"></div>'+close+'<div class="content container_12"><div class="panel"></div></div></div>');el.data('panelComponent',that);var anotherel=el;el.find('a.close').click(function(){that.close();});var content=el.find('.content');$(that.options.appendTo).append(el);if(that.options.content&&$(that.options.content).length){var c=$(that.options.content);c.remove();content.append(c);}
that.showContent=function(elements,opts){that.addContent(elements);if(opts&&opts.showClose){el.find('a.close').show();}
that.show();}
that.addContent=function(elements){if(!that.options.content){content.html('');content.append(elements);}}
that.show=function(animate){$(el[0]).show();$(el[0]).find('.madrona-table').each(function(){madrona.ui.table(this);});$(el[0]).scrollTop(0);that.shown=true;$(that).trigger('panelshow',that);}
that.close=function(){if(loader&&loader.destroy){loader.destroy();}
$(el[0]).scrollTop(1).scrollTop(0);el.find('a.close').hide();if(!that.options.hideOnly){el.hide();that.shown=false;el.find('div.content').html('');$(that).trigger('panelclose',that);}}
that.spin=function(message){if(el.is(':visible')){el.find('.loadingMask span').text(message||"Loading")
el.find('.loadingMask').show();}else{madrona.showLoadingMask(message);}};that.stopSpinning=function(){madrona.hideLoadingMask();el.find('.loadingMask').hide();};that.showError=function(title,message){};var getActiveTabs=function(element,list){var list=list||[];var selected=element.find('.ui-tabs:first .ui-tabs-selected:first > a');var href=selected.attr('href');var name=selected.text()
list.push(name);var panel=$(href);if(panel.find('.ui-tabs').length){getActiveTabs(panel,list);}
return list;};that.showUrl=function(url,options){that.spin(options.load_msg||"Loading");$(that).trigger('panelloading');loader=madrona.contentLoader($.extend({},{url:url,activeTabs:options.syncTabs?getActiveTabs(el):false,error:function(e){alert('error loading content in panel');that.stopSpinning();},behaviors:applyBehaviors,target:el.find('.content'),beforeCallbacks:function(){that.stopSpinning();el.find('a.close').show();that.show();}},options));loader.load();};that.showText=function(text,options){loader=madrona.contentLoader($.extend({},{text:text,activeTabs:options.syncTabs?getActiveTabs(el):false,error:options.error,behaviors:applyBehaviors,target:el.find('.content'),beforeCallbacks:function(){el.find('a.close').show();that.show();}},options));loader.load();}
var applyBehaviors=function(el){el.find('a.panel_link').click(function(e){that.showUrl($(this).attr('href'),options);e.preventDefault();});}
that.destroy=function(){that.getEl().remove();if(that.shown){that.close();}}
that.getEl=function(){return el;}
that.hide=function(){$(el[0]).scrollTop(0);el.hide();that.shown=false;$(that).trigger('panelhide',that);$(that).trigger('panelhide');}
return that;};madrona.layout.SanitizedContent=function(html){this.js=[];this.styles=[];this.html;var rscript=/<script(.|\s)*?\/script>/ig;var rstyle=/<style(.|\s)*?\/style>/ig;var that=this;html=html.replace(rscript,function(m){if(m.indexOf('text/javascript+protovis')!==-1){return m;}else if(m.indexOf('application/vnd.google-earth.kml+xml')!==-1){return m;}else{that.js.push(m.replace(/<script(.|\s)*?>/i,'').replace(/<\/script>/i,''));return'';}});html=html.replace(rstyle,function(m){that.styles.push({id:$(m).attr('id'),style:m.replace(/<style(.|\s)*?>/i,'').replace(/<\/style>/i,'')});return'';});if($.browser.msie&&$.browser.version==="8.0"&&html.match('<FORM')&&html.match('.errorlist')){var dom=$('<div>'+html+'</div>');if(dom.find('form div.json').length===0){var attrs=$(dom.children()[0].childNodes[1].childNodes[2]);var form=attrs.find('form');form.append(attrs.children().slice(1,-1));$(attrs.children()[1]).detach();}
var el=$('<div>');el.append(dom);html=el.html();}
this.html=jQuery.trim(html);return this;};madrona.layout.SanitizedContent.prototype.addStylesToDocument=function(){for(var i=0;i<this.styles.length;i++){var style=this.styles[i];if(!style.id||$('#'+style.id).length<1){var ss1=document.createElement('style');if(style.id){$(ss1).attr('id',style.id);}
ss1.setAttribute("type","text/css");if(ss1.styleSheet){ss1.styleSheet.cssText=style.style;}else{var tt1=document.createTextNode(style.style);ss1.appendChild(tt1);}
var hh1=document.getElementsByTagName('head')[0];hh1.appendChild(ss1);}}};madrona.layout.SanitizedContent.prototype.extractCallbacks=function(){var returnObj={panel:{},tabs:{}};function addCallback(type,target,callback){if(target&&!callback){callback=target;target=false;}
if(target){if(!returnObj.tabs[target]){returnObj.tabs[target]={};}
if(!returnObj.tabs[target][type]){returnObj.tabs[target][type]=[];}
returnObj.tabs[target][type].push(callback);}else{if(!returnObj.panel[type]){returnObj.panel[type]=[];}
returnObj.panel[type].push(callback);}}
madrona.onShow=function(target,callback){addCallback('show',target,callback);};madrona.onHide=function(target,callback){addCallback('hide',target,callback);};madrona.onUnhide=function(target,callback){addCallback('unhide',target,callback);};madrona.beforeDestroy=function(target,callback){if(!callback){callback=target;}
addCallback('destroy',false,callback);};jQuery.globalEval(this.js.join(';\n'));return returnObj;}
madrona.layout.SanitizedContent.prototype.cleanHtml=function(){return this.html;}
madrona.contentLoader=(function(){return function(options){if(!options.target&&(!options.url||!options.text)){throw('madrona.contentLoader: must specify a target, and a url or text option.');}
options.error=options.error||function(){alert('error loading content from '+options.url);};options.beforeCallbacks=options.beforeCallbacks||function(){};options.afterCallbacks=options.afterCallbacks||function(){};options.success=options.success||function(){};var that={};var callbacks=false;var still_staging=true;var staging=$('<div class="madrona-panel-staging"></div>');$(document.body).prepend(staging);function fireCallbacks(types,el){if(typeof types==='string'){types=[types];}
el.each(function(){var a=$(this);var callbacks=a.data('mm:callbacks');if(callbacks){for(var j=0;j<types.length;j++){var type=types[j];if(!still_staging&&callbacks[type]&&callbacks[type].length){for(var i=0;i<callbacks[type].length;i++){callbacks[type][i]();}
if(type==='show'||type==='destroy'){delete callbacks[type];}}}
a.data('mm:callbacks',callbacks);}});};var dataFilter=function(html,type){if(callbacks){throw('callbacks not handled before fetching new content!');}
var content=new madrona.layout.SanitizedContent(html);content.addStylesToDocument();callbacks=content.extractCallbacks();return content.cleanHtml();};var enableTabs=function(el){var tabs=el.find('div.tabs');if(tabs.length){var t=tabs.tabs({'spinner':'<img id="loadingTab" src="'+madrona.options.media_url+'common/images/small-loader.gif" />loading...',ajaxOptions:{error:function(e){if(e.statusText=='error'){$('#loadingTab').parent().parent().remove();alert('An error occured attempting to load this tab. '+'\nError code '+e.status+'\nIf the problem persists, please contact '+'help@madrona.org for assistance.');}},dataFilter:dataFilter},load:function(event,ui){var p=$(ui.panel);enableTabs(p);attachCallbacks($(ui.tab));fireCallbacks(['show','unhide'],$(ui.tab));fireCallbacks(['show','unhide'],p.find('.ui-tabs-selected a'));var after=$(ui.tab).data('mm:aftershow');if(after&&!$(ui.tab).parent().hasClass('ui-state-processing')){$(ui.tab).removeData('mm:aftershow')
after();}},show:function(event,ui){fireCallbacks(['show','unhide'],$(ui.tab));$(this).find('ul.ui-tabs-nav:first a').each(function(){if(!$(this).parent().hasClass('ui-tabs-selected')){fireCallbacks('hide',$(this));}});var selected_subtab=$(this).find('.ui-tabs-hide li.ui-tabs-selected a');if(selected_subtab.length){fireCallbacks('hide',selected_subtab);}
fireCallbacks(['show','unhide'],$(ui.panel).find('li.ui-tabs-selected a'));var after=$(ui.tab).data('mm:aftershow');if(after&&!$(ui.tab).parent().hasClass('ui-state-processing')){$(ui.tab).removeData('mm:aftershow')
after();}},cache:true});}};var followTabs=function(element,callback){if(options.activeTabs&&options.activeTabs.length>0){var t=options.activeTabs.shift();var link=element.find('div.tabs > ul li a').filter(function(){return $(this).text()===t;});if(link.length===0){followTabs(null,callback);return;}
var tabs=link.parent().parent().parent();var cback=function(){attachCallbacks(tabs);followTabs(tabs,callback);};if(link.parent().hasClass('ui-tabs-selected')){cback();}else{link.data('mm:aftershow',cback);link.click();}}else{callback();}};var attachCallbacks=function(el){el.data('mm:callbacks',callbacks['panel']);if(callbacks.tabs){if(el.is('a')){var el=el.parent().parent().parent().find(el.attr('href'));}
for(var key in callbacks['tabs']){var t=el.find('.ui-tabs-nav li a[href='+key+']');t.data('mm:callbacks',callbacks.tabs[key]);}}
callbacks=false;};that.destroy=function(){fireCallbacks('destroy',$(jQuery.merge(options.target.toArray(),options.target.find('.tabs, .ui-tabs-nav li a').toArray())));};var processText=function(data){staging.html(data);if(options.behaviors){options.behaviors(staging);}
enableTabs(staging);attachCallbacks(staging);followTabs(staging,function(){options.target.html('');var contents=staging.children();contents.detach();options.target.append(contents);options.beforeCallbacks();still_staging=false;fireCallbacks(['show','unhide'],staging);fireCallbacks(['show','unhide'],contents.find('.ui-tabs-selected a'));options.target.data('mm:callbacks',staging.data('mm:callbacks'));options.afterCallbacks();options.success();staging.remove();});}
that.load=function(){if(options.text){processText(dataFilter(options.text));}else{$.ajax({url:options.url,dataFilter:dataFilter,error:options.error,success:function(data,status,xhr){processText(data);}});}};return that;};})();function limit_to(textarea,max_chars,chars_used_el,alert_truncate){if(textarea.value.length>max_chars){if(alert_truncate){alert("The current text value exceeds the character limit; Any text after "+max_chars+" characters will be truncated");}
textarea.value=textarea.value.substring(0,max_chars);textarea.focus();}
document.getElementById(chars_used_el).innerHTML=textarea.value.length;}
madrona.menu_items=(function(){var that={};that.panels=[];var init=function(el){that.el=el;that.el.find('li.item_trigger').each(function(){var self=$(this);var els=$('<a style="display:none;" class="close" href="#"><img src="'+madrona.options.media_url+'common/images/tool_window_pointer.png" width="23" height="36" /></a></a>');els.click(function(){closeAll();return false;});self.append(els)
menuLink=self.find('span a');menuLink.click(function(){if(!that.el.hasClass('disabled')){closeAll();var parent=$(this).parent().parent()[0];openItem(parent);}
return false;});var href=menuLink.attr('href');var content=$(href);if(content){var panel=madrona.panel({scrollable:!self.hasClass('autosize'),content:content,hideOnly:true,showCloseButton:false,appendTo:$('#panel-holder')});panel.getEl().css('z-index','11');panel.getEl().addClass('madrona-menu-items');$.data(self[0],'panel',that.panels.length)
that.panels.push(panel);}});}
that.init=init;var closeAll=function(){var open=that.el.find('li.item_trigger.toggled');if(open.length===1){$('.madrona-panel:visible').each(function(){$(this).find('.panelMask').hide();});open.removeClass('toggled')
open.find('a.close').hide();open.each(function(){var item=$(this);var panel=that.panels[item.data('panel')];if(panel){panel.hide();}else{}});}}
that.closeAll=closeAll;var openItem=function(item){madrona.maskSidebar();item=$(item);item.addClass('toggled');item.find('a.close').show();if(item.data('panel')||item.data('panel')===0){$('.madrona-panel:visible').each(function(){$(this).find('.panelMask').show();});var panel=that.panels[item.data('panel')];panel.show();}else{}}
that.openItem=openItem;var disable=function(){that.el.addClass('disabled');};that.disable=disable;var enable=function(){that.el.removeClass('disabled');};that.enable=enable;return that;})();madrona.map={isnamespace_:true};madrona.map.googleLayers=function(ge,options_form,layers_form){this.layers=$(layers_form);this.options=$(options_form);this.ge=ge;var self=this;$(this.layers).find('input').click(function(){self.updateLayers();});$(this.options).find('input').click(function(){self.updateOptions();});this.updateLayers();this.updateOptions();}
madrona.map.googleLayers.prototype.updateLayers=function(){var self=this;this.layers.find('input').each(function(){self.ge.getLayerRoot().enableLayerById(self.ge[$(this).attr('name')],$(this).attr('checked'));});};madrona.map.googleLayers.prototype.updateOptions=function(){var self=this;var options=self.ge.getOptions();this.options.find('input').each(function(){var $input=$(this);var name=$input.attr('name');if(name!='nav'&&name!='sun'){options[name](this.checked);}});if(this.options.find('input[name="nav"]').length){if(this.options.find('input[name="nav"]:checked').length){self.ge.getNavigationControl().setVisibility(self.ge.VISIBILITY_SHOW);}else{self.ge.getNavigationControl().setVisibility(self.ge.VISIBILITY_HIDE);}}
if(this.options.find('input[name="sun"]').length){if(this.options.find('input[name="sun"]:checked').length){self.ge.getSun().setVisibility(true);}else{self.ge.getSun().setVisibility(false);}}};madrona.map.googleLayers.prototype.destroy=function(){$(this.layers).find('input').unbind('click');$(this.options).find('input').unbind('click');}
madrona.map.geocoder=function(gex,form){this.geocoder=new google.maps.Geocoder();this.form=form;this.get=ge;var self=this;var clearPlacemark=function(dont_clear_input){if(self.placemark){gex.dom.removeObject(self.placemark);self.placemark=false;}
if(dont_clear_input!==true){$(self.form).find('input[name=flyto_location]').val('');}
$(self.form).find('#flytoclear').addClass('disabled');return false;};var callback=function(e){var start_time=new Date().getTime();self.latest_geocode=start_time;clearPlacemark(true);var location=$(self.form).find('input:first').val();if(!location){alert('You need to type in a location name.');return false;}
self.geocoder.geocode({address:location,country:'.us'},function(results,status){if(status==google.maps.GeocoderStatus.OK&&results.length){if(status!=google.maps.GeocoderStatus.ZERO_RESULTS){if(start_time==self.latest_geocode){var viewport=results[0].geometry.viewport;var sw=new geo.Point(viewport.getSouthWest());var ne=new geo.Point(viewport.getNorthEast());var bounds=new geo.Bounds(sw,ne);var opts={aspectRatio:1.0};var bounding_view=gex.view.createBoundsView(bounds,opts);ge.getView().setAbstractView(bounding_view);var point=results[0].geometry.location;self.placemark=gex.dom.addPointPlacemark([point.lat(),point.lng()],{stockIcon:'shapes/cross-hairs',name:location});$(self.form).find('#flytoclear').removeClass('disabled');}}else{alert("geocoder didn't find any results.");}}else{alert("Geocoder failed due to: "+status);}});e.preventDefault();return false;}
$(this.form).find('#flytogo').click(callback);$(this.form).find('#flytoclear').click(clearPlacemark);$(this.form).submit(callback);};madrona.map.geocoder.prototype.destroy=function(){$(this.form).find('#flytogo').unbind('click');$(this.form).unbind('submit');};"use strict";if(!this.JSON){this.JSON={};}
(function(){function f(n){return n<10?'0'+n:n;}
if(typeof Date.prototype.toJSON!=='function'){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+'-'+
f(this.getUTCMonth()+1)+'-'+
f(this.getUTCDate())+'T'+
f(this.getUTCHours())+':'+
f(this.getUTCMinutes())+':'+
f(this.getUTCSeconds())+'Z':null;};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf();};}
var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={'\b':'\\b','\t':'\\t','\n':'\\n','\f':'\\f','\r':'\\r','"':'\\"','\\':'\\\\'},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==='string'?c:'\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4);})+'"':'"'+string+'"';}
function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==='object'&&typeof value.toJSON==='function'){value=value.toJSON(key);}
if(typeof rep==='function'){value=rep.call(holder,key,value);}
switch(typeof value){case'string':return quote(value);case'number':return isFinite(value)?String(value):'null';case'boolean':case'null':return String(value);case'object':if(!value){return'null';}
gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==='[object Array]'){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||'null';}
v=partial.length===0?'[]':gap?'[\n'+gap+
partial.join(',\n'+gap)+'\n'+
mind+']':'['+partial.join(',')+']';gap=mind;return v;}
if(rep&&typeof rep==='object'){length=rep.length;for(i=0;i<length;i+=1){k=rep[i];if(typeof k==='string'){v=str(k,value);if(v){partial.push(quote(k)+(gap?': ':':')+v);}}}}else{for(k in value){if(Object.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?': ':':')+v);}}}}
v=partial.length===0?'{}':gap?'{\n'+gap+partial.join(',\n'+gap)+'\n'+
mind+'}':'{'+partial.join(',')+'}';gap=mind;return v;}}
if(typeof JSON.stringify!=='function'){JSON.stringify=function(value,replacer,space){var i;gap='';indent='';if(typeof space==='number'){for(i=0;i<space;i+=1){indent+=' ';}}else if(typeof space==='string'){indent=space;}
rep=replacer;if(replacer&&typeof replacer!=='function'&&(typeof replacer!=='object'||typeof replacer.length!=='number')){throw new Error('JSON.stringify');}
return str('',{'':value});};}
if(typeof JSON.parse!=='function'){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==='object'){for(k in value){if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v;}else{delete value[k];}}}}
return reviver.call(holder,key,value);}
cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return'\\u'+
('0000'+a.charCodeAt(0).toString(16)).slice(-4);});}
if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,'@').replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,']').replace(/(?:^|:|,)(?:\s*\[)+/g,''))){j=eval('('+text+')');return typeof reviver==='function'?walk({'':j},''):j;}
throw new SyntaxError('JSON.parse');};}}());(function($,undefined){var numPages=5;$.widget("ui.slider",$.ui.mouse,{widgetEventPrefix:"slide",options:{animate:false,distance:0,max:100,min:0,orientation:"horizontal",range:false,step:1,value:0,values:null},_create:function(){var self=this,o=this.options,existingHandles=this.element.find(".ui-slider-handle").addClass("ui-state-default ui-corner-all"),handle="<a class='ui-slider-handle ui-state-default ui-corner-all' href='#'></a>",handleCount=(o.values&&o.values.length)||1,handles=[];this._keySliding=false;this._mouseSliding=false;this._animateOff=true;this._handleIndex=null;this._detectOrientation();this._mouseInit();this.element.addClass("ui-slider"+" ui-slider-"+this.orientation+" ui-widget"+" ui-widget-content"+" ui-corner-all"+
(o.disabled?" ui-slider-disabled ui-disabled":""));this.range=$([]);if(o.range){if(o.range===true){if(!o.values){o.values=[this._valueMin(),this._valueMin()];}
if(o.values.length&&o.values.length!==2){o.values=[o.values[0],o.values[0]];}}
this.range=$("<div></div>").appendTo(this.element).addClass("ui-slider-range"+" ui-widget-header"+
((o.range==="min"||o.range==="max")?" ui-slider-range-"+o.range:""));}
for(var i=existingHandles.length;i<handleCount;i+=1){handles.push(handle);}
this.handles=existingHandles.add($(handles.join("")).appendTo(self.element));this.handle=this.handles.eq(0);this.handles.add(this.range).filter("a").click(function(event){event.preventDefault();}).hover(function(){if(!o.disabled){$(this).addClass("ui-state-hover");}},function(){$(this).removeClass("ui-state-hover");}).focus(function(){if(!o.disabled){$(".ui-slider .ui-state-focus").removeClass("ui-state-focus");$(this).addClass("ui-state-focus");}else{$(this).blur();}}).blur(function(){$(this).removeClass("ui-state-focus");});this.handles.each(function(i){$(this).data("index.ui-slider-handle",i);});this.handles.keydown(function(event){var ret=true,index=$(this).data("index.ui-slider-handle"),allowed,curVal,newVal,step;if(self.options.disabled){return;}
switch(event.keyCode){case $.ui.keyCode.HOME:case $.ui.keyCode.END:case $.ui.keyCode.PAGE_UP:case $.ui.keyCode.PAGE_DOWN:case $.ui.keyCode.UP:case $.ui.keyCode.RIGHT:case $.ui.keyCode.DOWN:case $.ui.keyCode.LEFT:ret=false;if(!self._keySliding){self._keySliding=true;$(this).addClass("ui-state-active");allowed=self._start(event,index);if(allowed===false){return;}}
break;}
step=self.options.step;if(self.options.values&&self.options.values.length){curVal=newVal=self.values(index);}else{curVal=newVal=self.value();}
switch(event.keyCode){case $.ui.keyCode.HOME:newVal=self._valueMin();break;case $.ui.keyCode.END:newVal=self._valueMax();break;case $.ui.keyCode.PAGE_UP:newVal=self._trimAlignValue(curVal+((self._valueMax()-self._valueMin())/numPages));break;case $.ui.keyCode.PAGE_DOWN:newVal=self._trimAlignValue(curVal-((self._valueMax()-self._valueMin())/numPages));break;case $.ui.keyCode.UP:case $.ui.keyCode.RIGHT:if(curVal===self._valueMax()){return;}
newVal=self._trimAlignValue(curVal+step);break;case $.ui.keyCode.DOWN:case $.ui.keyCode.LEFT:if(curVal===self._valueMin()){return;}
newVal=self._trimAlignValue(curVal-step);break;}
self._slide(event,index,newVal);return ret;}).keyup(function(event){var index=$(this).data("index.ui-slider-handle");if(self._keySliding){self._keySliding=false;self._stop(event,index);self._change(event,index);$(this).removeClass("ui-state-active");}});this._refreshValue();this._animateOff=false;},destroy:function(){this.handles.remove();this.range.remove();this.element.removeClass("ui-slider"+" ui-slider-horizontal"+" ui-slider-vertical"+" ui-slider-disabled"+" ui-widget"+" ui-widget-content"+" ui-corner-all").removeData("slider").unbind(".slider");this._mouseDestroy();return this;},_mouseCapture:function(event){var o=this.options,position,normValue,distance,closestHandle,self,index,allowed,offset,mouseOverHandle;if(o.disabled){return false;}
this.elementSize={width:this.element.outerWidth(),height:this.element.outerHeight()};this.elementOffset=this.element.offset();position={x:event.pageX,y:event.pageY};normValue=this._normValueFromMouse(position);distance=this._valueMax()-this._valueMin()+1;self=this;this.handles.each(function(i){var thisDistance=Math.abs(normValue-self.values(i));if(distance>thisDistance){distance=thisDistance;closestHandle=$(this);index=i;}});if(o.range===true&&this.values(1)===o.min){index+=1;closestHandle=$(this.handles[index]);}
allowed=this._start(event,index);if(allowed===false){return false;}
this._mouseSliding=true;self._handleIndex=index;closestHandle.addClass("ui-state-active").focus();offset=closestHandle.offset();mouseOverHandle=!$(event.target).parents().andSelf().is(".ui-slider-handle");this._clickOffset=mouseOverHandle?{left:0,top:0}:{left:event.pageX-offset.left-(closestHandle.width()/2),top:event.pageY-offset.top-
(closestHandle.height()/2)-
(parseInt(closestHandle.css("borderTopWidth"),10)||0)-
(parseInt(closestHandle.css("borderBottomWidth"),10)||0)+
(parseInt(closestHandle.css("marginTop"),10)||0)};if(!this.handles.hasClass("ui-state-hover")){this._slide(event,index,normValue);}
this._animateOff=true;return true;},_mouseStart:function(event){return true;},_mouseDrag:function(event){var position={x:event.pageX,y:event.pageY},normValue=this._normValueFromMouse(position);this._slide(event,this._handleIndex,normValue);return false;},_mouseStop:function(event){this.handles.removeClass("ui-state-active");this._mouseSliding=false;this._stop(event,this._handleIndex);this._change(event,this._handleIndex);this._handleIndex=null;this._clickOffset=null;this._animateOff=false;return false;},_detectOrientation:function(){this.orientation=(this.options.orientation==="vertical")?"vertical":"horizontal";},_normValueFromMouse:function(position){var pixelTotal,pixelMouse,percentMouse,valueTotal,valueMouse;if(this.orientation==="horizontal"){pixelTotal=this.elementSize.width;pixelMouse=position.x-this.elementOffset.left-(this._clickOffset?this._clickOffset.left:0);}else{pixelTotal=this.elementSize.height;pixelMouse=position.y-this.elementOffset.top-(this._clickOffset?this._clickOffset.top:0);}
percentMouse=(pixelMouse/pixelTotal);if(percentMouse>1){percentMouse=1;}
if(percentMouse<0){percentMouse=0;}
if(this.orientation==="vertical"){percentMouse=1-percentMouse;}
valueTotal=this._valueMax()-this._valueMin();valueMouse=this._valueMin()+percentMouse*valueTotal;return this._trimAlignValue(valueMouse);},_start:function(event,index){var uiHash={handle:this.handles[index],value:this.value()};if(this.options.values&&this.options.values.length){uiHash.value=this.values(index);uiHash.values=this.values();}
return this._trigger("start",event,uiHash);},_slide:function(event,index,newVal){var otherVal,newValues,allowed;if(this.options.values&&this.options.values.length){otherVal=this.values(index?0:1);if((this.options.values.length===2&&this.options.range===true)&&((index===0&&newVal>otherVal)||(index===1&&newVal<otherVal))){newVal=otherVal;}
if(newVal!==this.values(index)){newValues=this.values();newValues[index]=newVal;allowed=this._trigger("slide",event,{handle:this.handles[index],value:newVal,values:newValues});otherVal=this.values(index?0:1);if(allowed!==false){this.values(index,newVal,true);}}}else{if(newVal!==this.value()){allowed=this._trigger("slide",event,{handle:this.handles[index],value:newVal});if(allowed!==false){this.value(newVal);}}}},_stop:function(event,index){var uiHash={handle:this.handles[index],value:this.value()};if(this.options.values&&this.options.values.length){uiHash.value=this.values(index);uiHash.values=this.values();}
this._trigger("stop",event,uiHash);},_change:function(event,index){if(!this._keySliding&&!this._mouseSliding){var uiHash={handle:this.handles[index],value:this.value()};if(this.options.values&&this.options.values.length){uiHash.value=this.values(index);uiHash.values=this.values();}
this._trigger("change",event,uiHash);}},value:function(newValue){if(arguments.length){this.options.value=this._trimAlignValue(newValue);this._refreshValue();this._change(null,0);return;}
return this._value();},values:function(index,newValue){var vals,newValues,i;if(arguments.length>1){this.options.values[index]=this._trimAlignValue(newValue);this._refreshValue();this._change(null,index);return;}
if(arguments.length){if($.isArray(arguments[0])){vals=this.options.values;newValues=arguments[0];for(i=0;i<vals.length;i+=1){vals[i]=this._trimAlignValue(newValues[i]);this._change(null,i);}
this._refreshValue();}else{if(this.options.values&&this.options.values.length){return this._values(index);}else{return this.value();}}}else{return this._values();}},_setOption:function(key,value){var i,valsLength=0;if($.isArray(this.options.values)){valsLength=this.options.values.length;}
$.Widget.prototype._setOption.apply(this,arguments);switch(key){case"disabled":if(value){this.handles.filter(".ui-state-focus").blur();this.handles.removeClass("ui-state-hover");this.handles.propAttr("disabled",true);this.element.addClass("ui-disabled");}else{this.handles.propAttr("disabled",false);this.element.removeClass("ui-disabled");}
break;case"orientation":this._detectOrientation();this.element.removeClass("ui-slider-horizontal ui-slider-vertical").addClass("ui-slider-"+this.orientation);this._refreshValue();break;case"value":this._animateOff=true;this._refreshValue();this._change(null,0);this._animateOff=false;break;case"values":this._animateOff=true;this._refreshValue();for(i=0;i<valsLength;i+=1){this._change(null,i);}
this._animateOff=false;break;}},_value:function(){var val=this.options.value;val=this._trimAlignValue(val);return val;},_values:function(index){var val,vals,i;if(arguments.length){val=this.options.values[index];val=this._trimAlignValue(val);return val;}else{vals=this.options.values.slice();for(i=0;i<vals.length;i+=1){vals[i]=this._trimAlignValue(vals[i]);}
return vals;}},_trimAlignValue:function(val){if(val<=this._valueMin()){return this._valueMin();}
if(val>=this._valueMax()){return this._valueMax();}
var step=(this.options.step>0)?this.options.step:1,valModStep=(val-this._valueMin())%step,alignValue=val-valModStep;if(Math.abs(valModStep)*2>=step){alignValue+=(valModStep>0)?step:(-step);}
return parseFloat(alignValue.toFixed(5));},_valueMin:function(){return this.options.min;},_valueMax:function(){return this.options.max;},_refreshValue:function(){var oRange=this.options.range,o=this.options,self=this,animate=(!this._animateOff)?o.animate:false,valPercent,_set={},lastValPercent,value,valueMin,valueMax;if(this.options.values&&this.options.values.length){this.handles.each(function(i,j){valPercent=(self.values(i)-self._valueMin())/(self._valueMax()-self._valueMin())*100;_set[self.orientation==="horizontal"?"left":"bottom"]=valPercent+"%";$(this).stop(1,1)[animate?"animate":"css"](_set,o.animate);if(self.options.range===true){if(self.orientation==="horizontal"){if(i===0){self.range.stop(1,1)[animate?"animate":"css"]({left:valPercent+"%"},o.animate);}
if(i===1){self.range[animate?"animate":"css"]({width:(valPercent-lastValPercent)+"%"},{queue:false,duration:o.animate});}}else{if(i===0){self.range.stop(1,1)[animate?"animate":"css"]({bottom:(valPercent)+"%"},o.animate);}
if(i===1){self.range[animate?"animate":"css"]({height:(valPercent-lastValPercent)+"%"},{queue:false,duration:o.animate});}}}
lastValPercent=valPercent;});}else{value=this.value();valueMin=this._valueMin();valueMax=this._valueMax();valPercent=(valueMax!==valueMin)?(value-valueMin)/(valueMax-valueMin)*100:0;_set[self.orientation==="horizontal"?"left":"bottom"]=valPercent+"%";this.handle.stop(1,1)[animate?"animate":"css"](_set,o.animate);if(oRange==="min"&&this.orientation==="horizontal"){this.range.stop(1,1)[animate?"animate":"css"]({width:valPercent+"%"},o.animate);}
if(oRange==="max"&&this.orientation==="horizontal"){this.range[animate?"animate":"css"]({width:(100-valPercent)+"%"},{queue:false,duration:o.animate});}
if(oRange==="min"&&this.orientation==="vertical"){this.range.stop(1,1)[animate?"animate":"css"]({height:valPercent+"%"},o.animate);}
if(oRange==="max"&&this.orientation==="vertical"){this.range[animate?"animate":"css"]({height:(100-valPercent)+"%"},{queue:false,duration:o.animate});}}}});$.extend($.ui.slider,{version:"1.8.16"});}(jQuery));(function(jq){var asArray=function(a){return Array.prototype.slice.call(a,0);}
jq.delegate=function(func,scope,params,overwriteDefault){if(!$.isArray(params))params=[params];return function(){if(!overwriteDefault)func.apply(scope,asArray(arguments).concat(params));else func.apply(scope,args);}}
jq.callback=function(func,params,overwriteDefault){return jq.delegate(func,this,params,overwriteDefault);}})(jQuery);;(function($){var l=location.href.replace(/#.*/,'');var g=$.localScroll=function(a){$('body').localScroll(a)};g.defaults={duration:1e3,axis:'y',event:'click',stop:true,target:window,reset:true};g.hash=function(a){if(location.hash){a=$.extend({},g.defaults,a);a.hash=false;if(a.reset){var e=a.duration;delete a.duration;$(a.target).scrollTo(0,a);a.duration=e}i(0,location,a)}};$.fn.localScroll=function(b){b=$.extend({},g.defaults,b);return b.lazy?this.bind(b.event,function(a){var e=$([a.target,a.target.parentNode]).filter(d)[0];if(e)i(a,e,b)}):this.find('a,area').filter(d).bind(b.event,function(a){i(a,this,b)}).end().end();function d(){return!!this.href&&!!this.hash&&this.href.replace(this.hash,'')==l&&(!b.filter||$(this).is(b.filter))}};function i(a,e,b){var d=e.hash.slice(1),f=document.getElementById(d)||document.getElementsByName(d)[0];if(!f)return;if(a)a.preventDefault();var h=$(b.target);if(b.lock&&h.is(':animated')||b.onBefore&&b.onBefore.call(b,a,f,h)===false)return;if(b.stop)h.stop(true);if(b.hash){var j=f.id==d?'id':'name',k=$('<a> </a>').attr(j,d).css({position:'absolute',top:$(window).scrollTop(),left:$(window).scrollLeft()});f[j]='';$('body').prepend(k);location=e.hash;k.remove();f[j]=d}h.scrollTo(f,b).trigger('notify.serialScroll',[f])}})(jQuery);;(function(d){var k=d.scrollTo=function(a,i,e){d(window).scrollTo(a,i,e)};k.defaults={axis:'xy',duration:parseFloat(d.fn.jquery)>=1.3?0:1};k.window=function(a){return d(window)._scrollable()};d.fn._scrollable=function(){return this.map(function(){var a=this,i=!a.nodeName||d.inArray(a.nodeName.toLowerCase(),['iframe','#document','html','body'])!=-1;if(!i)return a;var e=(a.contentWindow||a).document||a.ownerDocument||a;return d.browser.safari||e.compatMode=='BackCompat'?e.body:e.documentElement})};d.fn.scrollTo=function(n,j,b){if(typeof j=='object'){b=j;j=0}if(typeof b=='function')b={onAfter:b};if(n=='max')n=9e9;b=d.extend({},k.defaults,b);j=j||b.speed||b.duration;b.queue=b.queue&&b.axis.length>1;if(b.queue)j/=2;b.offset=p(b.offset);b.over=p(b.over);return this._scrollable().each(function(){var q=this,r=d(q),f=n,s,g={},u=r.is('html,body');switch(typeof f){case'number':case'string':if(/^([+-]=)?\d+(\.\d+)?(px|%)?$/.test(f)){f=p(f);break}f=d(f,this);case'object':if(f.is||f.style)s=(f=d(f)).offset()}d.each(b.axis.split(''),function(a,i){var e=i=='x'?'Left':'Top',h=e.toLowerCase(),c='scroll'+e,l=q[c],m=k.max(q,i);if(s){g[c]=s[h]+(u?0:l-r.offset()[h]);if(b.margin){g[c]-=parseInt(f.css('margin'+e))||0;g[c]-=parseInt(f.css('border'+e+'Width'))||0}g[c]+=b.offset[h]||0;if(b.over[h])g[c]+=f[i=='x'?'width':'height']()*b.over[h]}else{var o=f[h];g[c]=o.slice&&o.slice(-1)=='%'?parseFloat(o)/100*m:o}if(/^\d+$/.test(g[c]))g[c]=g[c]<=0?0:Math.min(g[c],m);if(!a&&b.queue){if(l!=g[c])t(b.onAfterFirst);delete g[c]}});t(b.onAfter);function t(a){r.animate(g,j,b.easing,a&&function(){a.call(this,n,b)})}}).end()};k.max=function(a,i){var e=i=='x'?'Width':'Height',h='scroll'+e;if(!d(a).is('html,body'))return a[h]-d(a)[e.toLowerCase()]();var c='client'+e,l=a.ownerDocument.documentElement,m=a.ownerDocument.body;return Math.max(l[h],m[h])-Math.min(l[c],m[c])};function p(a){return typeof a=='object'?a:{top:a,left:a}}})(jQuery);madrona.Formats=function(){};madrona.Formats.prototype.geojsonToWkt=function(geojson_obj){var coords=geojson_obj.coordinates;var wkt='POLYGON(';var numPolys=coords.length;for(var poly=0;poly<numPolys;poly++){var numPoints=coords[poly].length;if(poly==0)
wkt+='(';else
wkt+=', (';for(var point=0;point<numPoints;point++){if(point>0)
wkt+=',';wkt+=coords[poly][point][0]+' '+coords[poly][point][1];}
wkt+=')';}
wkt+=')';return wkt;};madrona.Formats.prototype.kmlToWkt=function(shape){var linearRing=shape.getGeometry().getOuterBoundary();var wkt='POLYGON((';for(var i=0;i<linearRing.getCoordinates().getLength();i++){if(i>0)
wkt=wkt+',';wkt=wkt+linearRing.getCoordinates().get(i).getLongitude()+' '+linearRing.getCoordinates().get(i).getLatitude();}
wkt=wkt+'))';return wkt;};madrona.Formats.prototype.geojsonToKmlPlacemark=function(geojson_obj){var coords=geojson_obj.coordinates;var inner_kml=this.innerKml(coords);var kml='<Placemark> <Style> <LineStyle><color>ffffffff</color><width>2</width></LineStyle> <PolyStyle><color>8000ff00</color></PolyStyle> </Style>'+inner_kml+'</Placemark>';return kml;};madrona.Formats.prototype.innerKml=function(coords){var kml='<Polygon>';var numPolys=coords.length;for(var poly=0;poly<numPolys;poly++){var numPoints=coords[poly].length;if(poly==0)
kml+='<outerBoundaryIs><LinearRing><coordinates>';else
kml+='<innerBoundaryIs><LinearRing><coordinates>';for(var point=0;point<numPoints;point++){if(point>0)
kml+=' ';kml+=coords[poly][point][0]+','+coords[poly][point][1]+',0';}
if(poly==0)
kml+='</coordinates></LinearRing></outerBoundaryIs>';else
kml+='</coordinates></LinearRing></innerBoundaryIs>';}
kml+='</Polygon>';return kml;};madrona.Formats.prototype.wktPolyToKml=function(wkt){var wkt=wkt.replace('POLYGON','');wkt=wkt.replace('SRID=4326;','');wkt=jQuery.trim(wkt.replace('((','').replace('))',''));var coords=wkt.split(',');var new_coords=[];for(var i=0;i<coords.length;i++){var values=jQuery.trim(coords[i]).split(' ');new_coords.push([values[0],values[1]]);}
var inner_kml=this.innerKml([new_coords]);var kml='<Placemark><Style><LineStyle><color>ffffffff</color><width>2</width></LineStyle> <PolyStyle><color>8000ff00</color></PolyStyle></Style>'+inner_kml+'</Placemark>';return kml;};madrona.Manipulator=function(gex,form,render_target,div){this.altitude=100;var json=false;var data=form.find('.json').html();if(data){json=JSON.parse(data);}
this.needed=true;if(!json||!json.url){this.needed=false;return false;}
this.div=div;this.shape_;this.required_manipulators=json.manipulators;this.optional_manipulators=json.optional_manipulators;this.manip_desc=json.descriptions;this.manip_name=json.display_names;this.active=this.required_manipulators.slice();this.manipulators_url=json.url;this.gex_=gex;this.form_=form;this.render_target_=render_target;this.render_target_.html($('#geopanel').html());var self=this;$.each(json.geometry_input_methods,function(index,value){if(value=='loadshp'&&!$.browser.msie){self.render_target_.find('.load_shape').show();self.loadshp_url=json.loadshp_url;}});if(this.optional_manipulators){var required_html="<form action=''><ul>";$.each(this.required_manipulators,function(index,value){var display_name=self.manip_name[value];if(!display_name)
display_name=value;var description=self.manip_desc[value];required_html+="<li class=\"required_manipulator\">";required_html+="<input class=\"required_manipulator\" type=\"checkbox\" name=\"required_manipulators\"";required_html+=" value=\""+value+"\" id=\"required_manipulator_"+value+"\" CHECKED DISABLED />";required_html+="<span>"+display_name+"</span>";if(description)
required_html+="<p><em>"+description+"</em></p>";required_html+="</li>";});required_html+="</ul></form>";this.render_target_.find('.requiredManipulators').html(required_html);var optional_html="<form action=''><ul>";var stored_manipulator_string=this.form_.find('#id_manipulators').attr('value');$.each(this.optional_manipulators,function(index,value){var display_name=self.manip_name[value];if(!display_name)
display_name=value;var description=self.manip_desc[value];optional_html+="<li class=\"optional_manipulator\">";optional_html+="<input class=\"optional_manipulator\" type=\"checkbox\" name=\"optional_manipulators\"";optional_html+=" value=\""+value+"\" id=\"optional_manipulator_"+value+"\"";if(stored_manipulator_string&&stored_manipulator_string.indexOf(value)>=0){optional_html+=" CHECKED";}
optional_html+="/>";optional_html+="<span>"+display_name+"</span>";if(description)
optional_html+="<p><em>"+description+"</em></p>";optional_html+="</li>";});optional_html+="</ul></form>";this.render_target_.find('.optionalManipulators').html(optional_html);this.render_target_.find('input.optional_manipulator').each(function(index){$(this).click(function(){self.constructUrl_();});});self.constructUrl_();}
this.render_target_.find('.draw_shape').click(function(){if(!$(this).hasClass('disabled')){$(this).addClass('disabled');self.render_target_.find('.load_shape').addClass('disabled');self.drawNewShape_();}});this.render_target_.find('.load_shape').click(function(){if(!$(this).hasClass('disabled')){$(this).addClass('disabled');self.render_target_.find('.draw_shape').addClass('disabled');self.loadShapeForm_();}});this.render_target_.find('div.manipulated .edit_shape').click(function(){if(!$(this).hasClass('disabled')){$(this).addClass('disabled');self.editExistingShape_();}});this.render_target_.find('.done_editing').click(function(){self.render_target_.find('.done_editing').addClass('disabled');self.finishedEditingCallback_();});this.render_target_.find('div.edit .edit_shape').click(function(){if(!$(this).hasClass('disabled')){$(this).addClass('disabled');self.editExistingShape_();}});this.type=$('#geometry_orig_kml').attr('class');if(this.form_.find('#id_geometry_orig').val()){this.enterExistingShapeState_();}else{this.enterNewState_();}}
madrona.Manipulator.prototype.constructUrl_=function(){var self=this;self.active=self.required_manipulators.slice();this.render_target_.find('input.optional_manipulator').each(function(index){if($(this).attr("checked")){self.active.push($(this).attr("value"));}});var url_parts=this.manipulators_url.split("/").slice(1);url_parts.pop();url_parts.pop();url_parts.push(self.active.join(","));this.manipulators_url="/"+url_parts.join("/")+"/";this.form_.find('#id_manipulators').val(self.active.join(","));}
madrona.Manipulator.prototype.drawNewShape_=function(){this.is_defining_shape_=true;this.is_defining_new_shape_=true;this.addNewShape_();var bounds;if(this.type==='polygon'){bounds=this.shape_.getGeometry().getOuterBoundary();}else{bounds=this.shape_.getGeometry();}
var self=this;if(this.type==='point'){this.gex_.edit.place(this.shape_,{bounce:false,dropCallback:function(){self.finishedEditingCallback_();}});}else{this.gex_.edit.drawLineString(bounds,{bounce:false,finishCallback:function(){self.finishedEditingCallback_();},drawCallback:function(i){var coords=bounds.getCoordinates();var coord=coords.get(i);coord.setAltitude(self.altitude);coords.set(i,coord);},ensureCounterClockwise:false});}}
madrona.Manipulator.prototype.loadShapeForm_=function(){this.is_defining_shape_=true;this.is_defining_new_shape_=true;var self=this;if(typeof(self.loadshp_url)=='undefined'){console.log("loadshp_url is undefined");}
$.ajax({url:self.loadshp_url,type:'GET',success:function(data,status){if(status==='success'){$('#load_shape_div').show().find('>p').html(data);self.render_target_.find('.upload_button').hide();var button_html=['<a href="#" id="load_shape_submit_button" class="button" onclick="this.blur(); return false;">','<span>Upload File</span>','</a>',].join('');var form=$('#load_shape_form');form.after(button_html);var errors='<ul id="load_shape_errorlist" class="errorlist" style="display:none"></ul>';form.before(errors);var ule=$('#load_shape_errorlist')
var opts={dataType:'json',beforeSubmit:function(formData,b,c){$(self).trigger('saving',["Uploading Shape"]);return true;},success:function(response){$(self).trigger('doneSaving');if(response.status=='success'){self.shape_=self.gex_.pluginInstance.parseKml(response.input_kml);self.finishedEditingCallback_();}else{ule.show();ule.html("<li>"+response.error_html+"</li>");}
return true;},error:function(data,stat,ethrown){alert(stat);alert(data);alert(ethrown);$(self).trigger('error',"There was an error processing your shape; Status was "+stat+".");return true;}}
$('#load_shape_submit_button').click(function(){$(form).ajaxSubmit(opts);return false;});}else{$(self).trigger('error',"There was an error retrieving the form; Status was "+status+".");}},error:function(data,status){$(self).trigger('error','There was an error processing your shape.');}});}
madrona.Manipulator.prototype.addNewShape_=function(kml){this.clearShape_();var geom;if(kml){this.shape_=this.gex_.pluginInstance.parseKml(kml);geom=this.shape_.getGeometry();}
var popts={visibility:true,style:{line:{width:2,color:'#FF0'},poly:{color:'#FF0',opacity:0.5},icon:{stockIcon:'shapes/cross-hairs',color:'#FF0'}}}
if(this.type==='polygon'){popts['polygon']=geom||[];}else if(this.type==='linestring'){popts['lineString']=geom||[];}else{popts['point']=geom||[0,0];}
this.shape_=this.gex_.dom.addPlacemark(popts);this.setZ(this.shape_,this.altitude);return this.shape_;}
madrona.Manipulator.prototype.setZ=function(kmlObject,z){if(this.type!=='polygon'){return kmlObject;}
var geo=kmlObject.getGeometry();geo.setAltitudeMode(ge.ALTITUDE_ABSOLUTE);geo.setExtrude(true);var coords=geo.getOuterBoundary().getCoordinates();var length=coords.getLength();for(var i=0;i<length;i++){var coord=coords.get(i)
coord.setAltitude(z);coords.set(i,coord);}
return kmlObject;}
madrona.Manipulator.prototype.finishedEditingCallback_=function(){var self=this;this.process(this.shape_.getKml(),this.manipulators_url,function(data){if(data.success==='1'){var kmlObject=self.addNewShape_(data.final_shape_kml);if(self.type!='point'){self.gex_.util.flyToObject(kmlObject,{boundsFallback:true,aspectRatio:$(self.div).width()/$(self.div).height()});}
self.setGeometryFields_(data.user_shape,data.submitted,data.final_shape,data.final_shape_kml);self.enterManipulatedState_(data.html,true);}else{self.setGeometryFields_('',data.submitted,'','');self.addNewShape_(data.submitted);if(self.type!='point'){self.gex_.util.flyToObject(self.shape_,{boundsFallback:true,aspectRatio:$(self.div).width()/$(self.div).height()});}
self.enterManipulatedState_(data.html,false);}});}
madrona.Manipulator.prototype.setGeometryFields_=function(original_wkt,original_kml,final_wkt,final_kml){this.form_.find('#id_geometry_orig').val(original_wkt);$('#geometry_final_kml').replaceWith('<script id="geometry_final_kml" type="application/vnd.google-earth.kml+xml">'+final_kml+'</script>');$('#geometry_orig_kml').replaceWith('<script id="geometry_orig_kml" type="application/vnd.google-earth.kml+xml">'+original_kml+'</script>');}
madrona.Manipulator.prototype.hideStates_=function(){this.render_target_.find('div.manipulators, div.new, div.edit, div.manipulated, div.editing').hide();}
madrona.Manipulator.prototype.enterManipulatedState_=function(html,success){this.hideStates_();if(success===true){this.render_target_.find('div.manipulated').removeClass('error');this.is_invalid_geometry=false;this.is_defining_shape_=false;this.is_defining_new_shape_=false;}else{this.is_invalid_geometry=true;this.render_target_.find('div.manipulated').addClass('error');}
this.render_target_.find('div.manipulated a.edit_shape').removeClass('disabled');this.render_target_.find('div.manipulated').show().find('>p').html(html);}
madrona.Manipulator.prototype.isInvalidGeometry=function(){return this.is_invalid_geometry;}
madrona.Manipulator.prototype.enterNewState_=function(){this.hideStates_();if(this.type==='point'){this.render_target_.find('div.new p.poly').hide();this.render_target_.find('div.new p.point').show();}else{this.render_target_.find('div.new p.poly').show();this.render_target_.find('div.new p.point').hide();}
this.render_target_.find('div.new').show();this.render_target_.find('a.draw_shape').removeClass('disabled');this.render_target_.find('a.load_shape').removeClass('disabled');if(this.optional_manipulators){this.render_target_.find('div.manipulators').show();}}
madrona.Manipulator.prototype.isDefiningNewShape=function(){return this.is_defining_new_shape_;}
madrona.Manipulator.prototype.enterEditingState_=function(){this.hideStates_();this.is_invalid_geometry=false;this.is_defining_shape_=true;this.is_defining_new_shape_=false;this.render_target_.find('.done_editing').removeClass('disabled');if(this.type==='point'){this.render_target_.find('div.editing p.poly').hide();this.render_target_.find('div.editing p.point').show();}else{this.render_target_.find('div.editing p.poly').show();this.render_target_.find('div.editing p.point').hide();}
this.render_target_.find('div.editing').show();if(this.optional_manipulators){this.render_target_.find('div.manipulators').show();}}
madrona.Manipulator.prototype.enterExistingShapeState_=function(){var self=this;this.hideStates_();this.is_defining_shape=false;this.render_target_.find('div.edit .edit_shape').removeClass('disabled');if(this.type==='point'){this.render_target_.find('div.edit p.poly').hide();this.render_target_.find('div.edit p.point').show();}else{this.render_target_.find('div.edit p.poly').show();this.render_target_.find('div.edit p.point').hide();}
this.render_target_.find('div.edit').show();var kml=jQuery.trim($('#geometry_final_kml').html());if(!kml){var kml=jQuery.trim($('#geometry_orig_kml').html());this.process(kml,this.manipulators_url,function(data){if(data.success==='1'){var kmlObject=self.addNewShape_(data.final_shape_kml);if(self.type!='point'){self.gex_.util.flyToObject(kmlObject,{boundsFallback:true,aspectRatio:$(self.div).width()/$(self.div).height()});}}else{}});}
this.addNewShape_(kml);if(this.type!='point'){this.gex_.util.flyToObject(this.shape_,{boundsFallback:true,aspectRatio:$(this.div).width()/$(this.div).height()});}
var self=this;}
madrona.Manipulator.prototype.isShapeDefined=function(){return!!this.form_.find('#id_geometry_orig').val();}
madrona.Manipulator.prototype.isDefiningShape=function(){return this.is_defining_shape_;}
madrona.Manipulator.prototype.process=function(kml,url,callback){$(this).trigger('processing');var self=this;$.ajax({url:url,type:'POST',data:{target_shape:kml},success:function(data,status){$(self).trigger('doneprocessing');if(status==='success'){callback(JSON.parse(data));}else{$(self).trigger('error',"There was an error processing your shape.");callback({success:false,html:$('#manipulators_server_error')});}},error:function(data,status){$(self).trigger('doneprocessing');$(self).trigger('error','There was an error processing your shape.');callback({success:false,html:$('#manipulators_server_error').html()});}});}
madrona.Manipulator.prototype.editExistingShape_=function(){var kml=jQuery.trim($('#geometry_orig_kml').html());this.addNewShape_(kml);if(this.type!='point'){this.gex_.util.flyToObject(this.shape_,{boundsFallback:true,aspectRatio:$(this.div).width()/$(this.div).height()});}
this.edit_();this.enterEditingState_();}
madrona.Manipulator.prototype.clearShape_=function(){if(this.shape_&&this.shape_.getParentNode()){this.endEdit_();gex.dom.removeObject(this.shape_);this.shape_=false;}}
madrona.Manipulator.prototype.edit_=function(){switch(this.type){case'polygon':this.gex_.edit.editLineString(this.shape_.getGeometry().getOuterBoundary());break;case'linestring':this.gex_.edit.editLineString(this.shape_.getGeometry());break;case'point':this.gex_.edit.makeDraggable(this.shape_,{bounce:false});break;default:alert('Unrecognized geometry type');}}
madrona.Manipulator.prototype.endEdit_=function(){switch(this.type){case'polygon':this.gex_.edit.endEditLineString(this.shape_.getGeometry().getOuterBoundary());break;case'linestring':this.gex_.edit.endEditLineString(this.shape_.getGeometry());break;case'point':this.gex_.edit.endDraggable(this.shape_);break;default:alert('Unrecognized geometry type');}}
madrona.Manipulator.prototype.destroy=function(){this.clearShape_();}
madrona.graphics=(function(){var ScaleBar=function(opts){this.opts=opts;this.tics=[];var baseline=opts.origin[1]-16;var position=opts.origin[0];var end=position+opts.width;var value=0;while(value<=opts.maxValue){this.tics.push(new Tic(value,position,opts.paper,opts.ticHeight,baseline,opts.color,true));var value=value+opts.majorInterval;var position=this.calculateXPosition(value,opts.width,opts.maxValue,opts.origin[0]);}
var position=opts.origin[0];var end=position+opts.width;var value=0;var height=opts.ticHeight/2;var b=baseline-(height/2);while(value<=opts.maxValue){if(value%opts.majorInterval!==0){this.tics.push(new Tic(value,position,opts.paper,height,b,opts.color,false));}
var value=value+opts.minorInterval;var position=this.calculateXPosition(value,opts.width,opts.maxValue,opts.origin[0])}
this.maxValue=opts.maxValue;if(opts.initialMaxValue){this.update(opts.initialMaxValue,false);}
if(opts.label){this.label=opts.paper.text(opts.origin[0]+(opts.width/2),opts.origin[1]+15,opts.label);}};ScaleBar.prototype.calculateXPosition=function(value,width,maxValue,originX){return Math.round(((value/maxValue)*width)+originX);};ScaleBar.prototype.update=function(maxValue,animate){var ticZero=this.tics[0];var x=this.calculateXPosition(ticZero.value,this.opts.width,maxValue,this.opts.origin[0]);if(animate){ticZero.changePosition(x,true,this.opts.animationEasing,this.opts.animationDuration);}else{ticZero.changePosition(x,false);}
for(var i=1;i<this.tics.length;i++){var tic=this.tics[i];var x=this.calculateXPosition(tic.value,this.opts.width,maxValue,this.opts.origin[0]);if(animate){tic.changePosition(x,true,this.opts.animationEasing,this.opts.animationDuration,ticZero);}else{tic.changePosition(x,false);}}
this.maxValue=maxValue;return ticZero.path;};ScaleBar.prototype.changeY=function(y,target,easing,duration){for(var i=0;i<this.tics.length;i++){var el=this.tics[i].changeY(y,easing,duration,target);if(!target){target=el;}}
if(this.label){this.label.anim({attrs:{y:this.label.attr('y')+y},easing:easing,ms:duration,target:target});}}
var Tic=function(value,initial_position,paper,ticHeight,origin,color,showValue){this.y1=(origin);this.y2=((origin-ticHeight));this.x=initial_position;this.path=paper.path("M"+this.x+' '+this.y1+'L'+this.x+' '+this.y2);this.path.attr({'stroke':color});if(showValue){this.tx=initial_position;this.ty=origin+10;this.t=paper.text(this.tx,this.ty,String(value));this.t.attr({'fill':color});}
this.initial_position=initial_position;this.value=value;this.paper=paper;};Tic.prototype.changePosition=function(x,animate,animationEasing,animationDuration,animationTarget){this.x=x;var new_path='M'+this.x+' '+this.y1+'L'+this.x+' '+this.y2;if(!animate){this.path.attr('path',new_path);}else{this.path.anim({attrs:{path:new_path},ms:animationDuration,easing:animationEasing,target:animationTarget});}
if(this.t){this.tx=x;if(!animate){this.t.attr('x',this.tx);}else{this.t.anim({attrs:{x:this.tx,y:this.ty},ms:animationDuration,easing:animationEasing,target:animationTarget});}}};Tic.prototype.changeY=function(y,easing,duration,target){this.y1=this.y1+y;this.y2=this.y2+y;var new_path='M'+this.x+' '+this.y1+'L'+this.x+' '+this.y2;this.path.anim({attrs:{path:new_path},ms:duration,easing:easing,target:target});if(!target){target=this.path;}
if(this.t){this.ty=this.ty+y;this.t.anim({attrs:{y:this.ty},ms:duration,easing:easing,target:target});}
return target;}
var that={};that.ScaleBar=ScaleBar;return that;})();madrona.ui={};madrona.ui.table=(function(){return function(element){var element=$(element);if(element.hasClass('madrona-table')){if(element.hasClass('processed')){return;}
element.addClass('processed');if(element.hasClass('madrona-table-zebra')){var odd=false;element.find('tbody tr').each(function(){if(odd){$(this).addClass('zebra');}
odd=!odd;});}
if(element.find('span.hover').length>0){element.addClass('madrona-table-hover');}
if(element.find('span.popup').length>0){element.addClass('madrona-table-popup');}}else{throw('element does not have class madrona-table');}}})();if(!window.madrona){madrona={};}
madrona.geographicReport=(function(){var ScaleBar=madrona.graphics.ScaleBar;return function(options){if(!options.element||!options.maxScale){throw('need an element to render to.');}
var that={};var el=$(options.element);var paper=new Raphael(el[0],el.width(),160);options.maxScale=Math.round(options.maxScale);options.animationEasing=options.animationEasing||'<>';options.animationDuration=options.animationDuration||500;var leftMargin=5;var rightMargin=10;var dataWidth=el.width()-(leftMargin+rightMargin);var majorTicInterval=options.majorTicInterval||10;var minorTicInterval=options.minorTicInterval||5;var scalebarY=80;var ticHeight=10;that.currentScale=options.maxScale;var rectHeight=40;var x1=leftMargin;var y1=scalebarY-ticHeight-20-rectHeight;var width=1;var height=rectHeight;var valueRect=paper.rect(x1,y1,width,height);valueRect.attr({fill:"90-#5394AD-#62ABCD",'stroke-width':1,'stroke':'#3D75AA'});var annotations=[];var max_annotation_value=false;var start_max_annotation=0;var outOfRange=paper.set();var tw=el.width();var bg=paper.rect(tw*.25,y1+5,tw*.5,height-10,5);bg.attr({'fill':'270-#356375-#16272F','stroke-width':0});var t=paper.text(el.width()/2,y1+20,'Out of Range');t.attr({'fill':'#BBD6D8','font-size':18});outOfRange.push(bg);outOfRange.push(t);outOfRange.hide();var widthFromValue=function(value){return Math.round((value/that.currentScale)*dataWidth);};var annotationHover=paper.set();var background=paper.rect(0,0,110,20);background.attr({'fill':'#F6EDC8','stroke':'#8F8F8F','stroke-width':'1'});var annotationText=paper.text(55,11,"");annotationHover.push(background);annotationHover.push(annotationText);annotationHover.hide();annotationHover.toFront();var addAnnotation=function(opts){var w=widthFromValue(opts.max-opts.min);var x=(opts.min/that.currentScale)*dataWidth+leftMargin;var anno=paper.set();var a=paper.rect(x,0,w,120);var opacity;a.attr({'fill':opts.color,'stroke-width':1,'stroke':opts.color});a.toBack();var text_x=Math.round(x+w/2);var text=paper.text(text_x,100,opts.label);var subtext=paper.text(text_x,110,opts.min+' to '+opts.max+' sq miles');if(w<100){a.textHidden=true;text.hide();subtext.hide();}else{a.textHidden=false;text.show();subtext.show();}
var obj={rect:a,text:text,subtext:subtext,opts:opts};annotations.push(obj);if(!max_annotation_value||opts.max>max_annotation_value){max_annotation_value=opts.max;}
anno.push(a);anno.push(text);anno.push(subtext);anno.hover(function(e){a.attr({opacity:0.85});});anno.attr({title:opts.label});anno.mouseout(function(){a.attr({opacity:1});a.attr({fill:opts.color})});};if(options.annotations.length){for(var i=0;i<options.annotations.length;i++){if(options.annotations[i].max>start_max_annotation){start_max_annotation=options.annotations[i].max;}}
that.currentScale=start_max_annotation;for(var i=0;i<options.annotations.length;i++){addAnnotation(options.annotations[i]);}}
var scaleBar=new ScaleBar({paper:paper,origin:[leftMargin,scalebarY],width:dataWidth,ticHeight:ticHeight,color:'black',maxValue:options.maxScale,minorInterval:5,majorInterval:10,animationEasing:options.animationEasing,animationDuration:options.animationDuration,initialMaxValue:that.currentScale});that.scaleBar=scaleBar;that.paper=paper;var updateValue=function(value,animate,animationTarget){if(max_annotation_value&&value>max_annotation_value){var scale;if(value+(value*0.1)>options.maxScale){scale=options.maxScale;}else{scale=value+(value*0.1);}
updateScale(scale,animate,function(){updateValueCallback(value,animate);});}else{if(max_annotation_value&&that.currentScale>max_annotation_value){updateScale(max_annotation_value,animate,function(){updateValueCallback(value,animate);});}else{updateValueCallback(value,animate,animationTarget);}}};that.updateValue=updateValue;var updateValueCallback=function(value,animate,animationTarget,callback){var prevValue=that.value||1;var value=value||0;that.value=value;var w=widthFromValue(value);if(animate){if(animationTarget){valueRect.animateWith(animationTarget,{'width':w},options.animationDuration,options.animationEasing,callback);}else{valueRect.animate({'width':w},options.animationDuration,options.animationEasing,callback);}}else{valueRect.attr('width',w);if(callback){callback(value,animate);}}
if(annotations.length){for(var i=0;i<annotations.length;i++){var a=annotations[i];if(value<=a.opts.max&&value>=a.opts.min){a.text.attr({'font-weight':'bold'});}else{a.text.attr({'font-weight':'normal'});}}}
if(value>options.maxScale){outOfRange.show();}else{outOfRange.hide();}}
var render=function(){};that.render=render;var updateScale=function(value,animate,callback){var target=scaleBar.update(value,animate);that.currentScale=value;scaleAnnotations(target,false);updateValueCallback(that.value,animate,target,callback);};that.updateScale=updateScale;var scaleAnnotations=function(animationTarget,animate){for(var i=0;i<annotations.length;i++){var a=annotations[i];var w=widthFromValue(a.opts.max-a.opts.min);var x=(a.opts.min/that.currentScale)*dataWidth+leftMargin;var text_x=Math.round(x+w/2);if(!animate){a.rect.attr({x:x,width:w});if(w<100){a.text.attr({x:text_x});a.text.hide();a.textHidden=true;a.subtext.attr({x:text_x});a.subtext.hide();}else{a.textHidden=false;a.text.attr({x:text_x});a.subtext.attr({x:text_x});a.text.show();a.subtext.show();a.subtext.show();}}else if(animationTarget){a.rect.animateWith(animationTarget,{x:x,width:w},options.animationDuration,options.animationEasing);if(w<100){a.textHidden=true;a.text.hide();a.subtext.hide();}else{a.textHidden=false;a.text.show();a.subtext.show();}}else{a.animate({x:x,width:w},options.animationDuration,options.animationEasing);a.text.animate({x:text_x},options.animationDuration,options.animationEasing);a.subtext.animate({x:text_x},options.animationDuration,options.animationEasing);}}}
return that;}})();if(typeof madrona=='undefined'){madrona={};}
madrona.features={};madrona.features.model=function(kmlObject){var id=kmlObject.getId();if(!id){return false;}
var matches=id.match(/(\w+)_\d+/);if(matches.length){return matches[1];}else{return false;}};madrona.features.workspace=(function(){function ucase(string){return string.charAt(0).toUpperCase()+string.slice(1);}
function idsToUniqueClasses(uids){var klasses=[];var existing={};jQuery.each(uids,function(i,v){var klass=v.replace(/_\d+$/,'');if(!existing[klass]){klasses.push(klass);existing[klass]=true;}});return klasses;}
function extractActions(doc){var actions=[];jQuery.each(doc['feature-classes'],function(i,klass){jQuery.each(klass['link-relations'],function(linkrel,links){if(links instanceof Array){jQuery.each(links,function(i,link){if(link.title){link.title=ucase(link.title);var action=getOrCreateAction(link,actions)
action.addLink(link);}else{throw('invalid link with no title');}});}else{var action=getOrCreateAction(links,actions);action.addLink(links);}});});jQuery.each(doc['generic-links'],function(i,link){if(link.title){link.title=ucase(link.title);var action=getOrCreateAction(link,actions)
action.addLink(link);}else{throw('invalid link with no title');}});jQuery.each(doc['feature-classes'],function(i,klass){var rels=klass['link-relations'];var self=rels['self'];if(typeof self==='undefined'||self instanceof Array){throw('undefined or invalid self link for '+klass.title);}else{self.rel='self';var action=getOrCreateAction(self,actions);}});return actions;}
function getOrCreateAction(link,actions){var action=new Action(link.title,link.rel);for(var i=0;i<actions.length;i++){if(actions[i].id===action.id){return actions[i];}}
actions.push(action);return action;}
function extractFeatureClasses(doc){var classes=[];jQuery.each(doc['feature-classes'],function(i,klass){if(typeof klass['link-relations']['self']==='undefined'||self instanceof Array){throw('feature class '+klass.title+' has missing or improperly configured self link.');}
jQuery.each(klass['link-relations'],function(linkrel,items){if(items instanceof Array){jQuery.each(items,function(i,link){link.rel=linkrel;link.featureClass=klass;link.models=[klass.id];});}else{items.rel=linkrel;items.featureClass=klass;items.models=[klass.id];}});klass['is_collection']=('collection'in klass);if(klass.is_collection){klass['accepts']=klass['collection']['classes'];klass['buildAddUrl']=function(collection_id,ids){var uri=klass['collection']['add']['uri-template'];var repl='{collection_uid}';uri=uri.replace(repl,collection_id);var repl='{uid}';if(uri.indexOf(repl)===-1){repl='{uid+}';}
return uri.replace(repl,ids.join(','));}
klass['buildRemoveUrl']=function(collection_id,ids){var uri=klass['collection']['remove']['uri-template'];var repl='{collection_uid}';uri=uri.replace(repl,collection_id);var repl='{uid}';if(uri.indexOf(repl)===-1){repl='{uid+}';}
return uri.replace(repl,ids.join(','));}}
classes.push(klass);});return classes;}
var constructor=function(doc,options){var that={};var options=jQuery.extend(options||{},defaults);var getById=function(id){for(var i=0;i<that.featureClasses.all.length;i++){if(that.featureClasses.all[i].id===id){return that.featureClasses.all[i];}}
return false;};that.featureClasses={all:extractFeatureClasses(doc),getById:getById};function getByRel(rel){var actions=[];for(var i=0;i<that.actions.all.length;i++){if(that.actions.all[i].rel===rel){actions.push(that.actions.all[i]);}}
return actions;}
function getByTitle(title){var actions=[];for(var i=0;i<that.actions.all.length;i++){if(that.actions.all[i].title===title){actions.push(that.actions.all[i]);}}
return actions;}
function getActionById(id){for(var i=0;i<that.actions.all.length;i++){if(that.actions.all[i].id===id){return that.actions.all[i];}}
return false;}
that.actions={all:extractActions(doc),getByRel:getByRel,getByTitle:getByTitle,getById:getActionById,each:function(callback){jQuery.each(that.actions.all,function(i,v){callback(v)});}}
var collectables={};that.collections=[];jQuery.each(that.featureClasses.all,function(i,f){if(f['collection']){that.collections.push(f);jQuery.each(f['collection']['classes'],function(j,k){collectables[k]=true;});}});that.collectables=[];for(var uid in collectables){that.collectables.push(uid);}
that.getActiveActions=function(selection){if(!selection.length){return[];}
var multiple=selection.length>1;var klasses=idsToUniqueClasses(selection);var actions=[];that.actions.each(function(action){if(action.active(klasses,multiple)){actions.push(action);}});return actions;}
that.doc=doc;return that;}
var defaults={shareInEditLinks:false}
var id_counter=0;function Action(title,rel){var that={};that.title=title;that.rel=rel;if(that.rel==='self'){that.id=that.rel;}else if(that.rel==='create'){that.id=that.rel+id_counter;id_counter++;}else{that.id=that.rel+'_'+that.title;}
that.links=[];that.addLink=function(link){if(link.rel!==that.rel){throw('Wrong link type! Must be '+that.rel+'. Is '+
link.rel);}else{that.links.push(link);}
if(link.rel==='create'){that.title=ucase(link.featureClass.title);}
if(typeof link.method==='undefined'){link.method='GET';}}
that.active=function(selected){var valid_link=false;for(var j=0;j<that.links.length;j++){var link=that.links[j];for(var i=0;i<selected.length;i++){var model=selected[i];if(typeof model['getType']!=='undefined'){model=madrona.features.model(model);}
if(jQuery.inArray(model,link.models)===-1){valid_link=false;break;}
if(selected.length>1){if(!link.select||jQuery.inArray('multiple',link.select.split(' '))===-1){valid_link=false;break;}}
valid_link=link;}
if(valid_link){return valid_link;}};return false;}
that.getUrl=function(selected){if(that.rel==='create'){return that.links[0]['uri-template'];}
var link=that.getLink(selected);var uri=link['uri-template'];var repl='{uid}';if(uri.indexOf(repl)===-1){repl='{uid+}';}
return uri.replace(repl,selected.join(','));}
that.getLink=function(selected){if(that.links[0].rel==='create'){return that.links[0];}
return that.active(idsToUniqueClasses(selected));}
return that;}
return constructor;})();madrona.features.kmlEditor=(function(){function checkOptions(opts){if(!opts||!opts.url||!opts.appendTo||!opts.gex||!opts.panel){throw('kmlEditor needs url, appendTo, panel and gex options');}
return opts;}
return function(options){options=checkOptions(options);var that={};that.workspace;that.tree;that.el;that.panel=options.panel;var panel=that.panel;var tbar;var create_menu;var refresh_button;var tree;var kmlEl;var create_button;var attr;var edit;var download_button;var download_menu;var edit_button;var edit_menu;var menus=[];var buttons=[];var selection;var textLookup={'saving':'Saving Changes'}
$.extend(textLookup,options.textLookup);var previousSelection;var selectedKmlObjects;var selectedNodes;var dragDropSelection;that.el=$(['<div class="kmlEditor">','<h1 class="name"></h1>','<div class="toolbar"></div>','<div class="kmllist kmlEditor"></div>','</div>'].join(''));kmlEl=that.el.find('.kmllist');tbar=new goog.ui.Toolbar();if(options.refreshButton===true){refresh_button=new goog.ui.ToolbarButton('Refresh');refresh_button.setEnabled(false);goog.events.listen(refresh_button,'action',function(e){that.refresh();});tbar.addChild(refresh_button,true);buttons.push(refresh_button);tbar.addChild(new goog.ui.ToolbarSeparator(),true);}
create_menu=new goog.ui.Menu();create_button=new goog.ui.ToolbarMenuButton('Create',create_menu);create_button.setVisible(false);menus.push(create_menu);tbar.addChild(create_button,true);goog.events.listen(create_menu,'action',onAction);tbar.addChild(new goog.ui.ToolbarSeparator(),true);attr=new goog.ui.ToolbarButton('');attr.setEnabled(false);attr.setVisible(false);attr.setTooltip("Show the selected feature's attributes");goog.events.listen(attr,'action',onAction);tbar.addChild(attr,true);edit_menu=new goog.ui.Menu();edit_button=new goog.ui.ToolbarMenuButton('Edit',edit_menu);edit_button.setEnabled(false);edit_button.setVisible(false);tbar.addChild(edit_button,true);goog.events.listen(edit_menu,'action',onAction);download_menu=new goog.ui.Menu();download_button=new goog.ui.ToolbarMenuButton('Download',download_menu);download_button.setEnabled(false);download_button.setVisible(false);tbar.addChild(download_button,true);goog.events.listen(download_menu,'action',onAction);var tree=kmltree({url:options.url,gex:options.gex,mapElement:$('#map'),element:kmlEl,bustCache:true,restoreState:true,supportItemIcon:true,multipleSelect:true,selectable:true,displayDocumentRoot:true,displayEnhancedContent:options.enhancedContent||false,classname:function(kmlObject){return madrona.features.model(kmlObject)||'';}});that.tree=tree;tree.load();$(tree).bind('kmlLoaded',onKmlLoad);$(tree).bind('kmlLoaded',function(event,kmlObject){$(that).trigger('kmlLoaded',[event,kmlObject]);});$(tree).bind('networklinkload',function(e,node,kmlObject,old){$(node).addClass(old);enableDragDrop(node);});$(tree).bind('dblclick',function(e,kmlObject){if(that.workspace){attr.dispatchEvent('action');}});$(tree).bind('kmlLoadError',function(){create_button.setEnabled(false);});$(tree).bind('select',onSelect);tbar.render(that.el.find('.toolbar')[0]);$(options.appendTo).append(that.el);function onKmlLoad(e,kmlObject){var kml=$($.parseXML(kmlObject.getKml()));var link=kml.find('[nodename=atom:link][rel=workspace]');if(link.length<1){alert('kml file did not have workspace document link');}
if(that.workspace){return;}
spin('fetching workspace');$.ajax({url:link.attr('href'),dataType:'json',success:onWorkspaceLoad,error:function(){alert('error loading workspace document');}});}
function onWorkspaceLoad(data,textStatus){unspin();if(selection){return;}
that.workspace=madrona.features.workspace(data);populateCreateMenu(create_menu,create_button,that.workspace);populateEditMenu(edit_menu,edit_button,that.workspace);populateDownloadMenu(download_menu,download_button,that.workspace);attr.action=that.workspace.actions.getByRel('self')[0];attr.setCaption(that.workspace.actions.getByRel('self')[0].title);attr.setVisible(true);if(typeof refresh_button!='undefined'){refresh_button.setEnabled(true);}
enableDragDrop();}
function populateCreateMenu(menu,button,workspace){while(menu.getItemCount()>0){menu.removeItemAt(0);}
var createActions=workspace.actions.getByRel('create');if(createActions.length<1){button.setEnabled(false);button.setVisible(false);}else{button.setVisible(true);jQuery.each(createActions,function(i,action){var cls=action.links[0].featureClass.id;var item=new goog.ui.MenuItem(action.title);item.addClassName(cls);if(item.content_!='Bookmark'){item.action=action;menu.addItem(item);}});}}
function populateEditMenu(menu,button,workspace){while(menu.getItemCount()>0){menu.removeItemAt(0);}
var actions=workspace.actions.getByRel('edit');if(actions.length<1){button.setEnabled(false);button.setVisible(false);}else{jQuery.each(actions,function(i,action){var item=new goog.ui.MenuItem(action.title);item.setEnabled(false);item.action=action;menu.addItem(item);});button.setVisible(true);}}
function populateDownloadMenu(menu,button,workspace){while(menu.getItemCount()>0){menu.removeItemAt(0);}
var actions=workspace.actions.getByRel('related');if(actions.length<1){button.setEnabled(false);button.setVisible(false);}else{jQuery.each(actions,function(i,action){var item=new goog.ui.MenuItem(action.title);item.setEnabled(false);item.action=action;menu.addItem(item);});button.setVisible(true);}
var as=new goog.ui.MenuItem('as file type...');menu.addItem(as);as.setEnabled(false);var actions=workspace.actions.getByRel('alternate');if(actions.length<1){button.setEnabled(false);button.setVisible(false);}else{jQuery.each(actions,function(i,action){var item=new goog.ui.MenuItem(action.title);item.setEnabled(false);item.action=action;menu.addItem(item);});button.setVisible(true);}}
function onSelect(e,selectData){if(!that.workspace){return;}
if(selectData.length!==1){attr.setEnabled(false);}else{attr.setEnabled(true);}
selectedNodes=$(jQuery.map(selectData,function(d){return d.node[0];}));selectData=jQuery.map(selectData,function(d){var orig=$(d.node).data('original-networklink');if(typeof orig!=='undefined'){return orig}else{return d.kmlObject;}});selectedKmlObjects=selectData;selection=jQuery.map(selectData,function(d){return d.getId();});var i=tbar.getChildCount();while(i){i--;if(child===attr){continue;}
if(typeof refresh_button!=='undefined'){if(child===refresh_button){continue;}}
var child=tbar.getChildAt(i);if(child instanceof goog.ui.ToolbarMenuButton){var menu=child.getMenu();var enabled=false;var j=menu.getChildCount();while(j!=0){j--;var item=menu.getChildAt(j);if(item.action){var active=item.action.active(selectData);if(active){enabled=true;item.setEnabled(true);}else{item.setEnabled(false);}}}
child.setEnabled(enabled);}}}
function onAction(e){previouslySelected=[];var action=e.target.action;var panelOpts={loading_msg:'Loading '+action.title,showClose:true};if(action.rel!=='create'&&(!selection||selection.length===0)){return;}
var link=action.getLink(selection);if(link.confirm){if(!confirm(link.confirm)){return;}}
var url=action.getUrl(selection);if(link.method==='GET'){if(action.rel==='self'){panel.showUrl(url,panelOpts);}else if(action.rel in{alternate:1,related:1}){window.open(url);}else{if(action.rel==='create'){tree.clearSelection();}
panelOpts['showCloseButton']=false;panelOpts['success']=function(){madrona.setupForm=function(){alert('error:setupForm called after clearing?');};}
madrona.setupForm=function(form){setupForm(form);}
panelOpts['loading_msg']='Loading form';panel.showUrl(url,panelOpts);return;}}else if(link.method==='DELETE'||link.method==='POST'){tree.clearSelection();spin('Performing action');$.ajax({url:url,type:link.method,dataType:'text',error:onError,success:onChange,context:{action:action,link:link}});}else{alert('invalid link method "'+link.method+'"');}}
function setupForm(form,options){options=options||{};var el=panel.getEl();el.find('.close').hide();el.find('input[type=submit]').hide();var manipulator;if($('#PanelGeometry').length){if(selectedKmlObjects.length){selectedKmlObjects[0].setVisibility(0);previouslySelected=selectedKmlObjects[0];}
var tabs=el.find('.tabs');tabs.bind('tabsshow',function(e){var div=$(this).parent().parent().parent();div.scrollTop(1);div.scrollTop(0);});var manipulator=new madrona.Manipulator(gex,form,$('#PanelGeometry'),$('#map_container'));$(manipulator).bind('processing',function(){panel.spin('Processing your shape');});$(manipulator).bind('doneprocessing',function(){panel.stopSpinning();});if(manipulator&&manipulator.needed){tabs.tabs('select','#PanelGeometry');}else{manipulator=false;tabs.tabs('select','#PanelAttributes');tabs.tabs('disable',0);tabs.find('> .ui-tabs-nav').hide();}}
opts={iframe:true,beforeSubmit:function(a,b,c){if(manipulator){var errMsg=false;if(manipulator.isDefiningShape()){if(manipulator.isInvalidGeometry()){errMsg='The shape you defined is invalid. Return to Step 1 and click "Edit Shape" to correct any mistakes.';}else if(manipulator.isDefiningNewShape()){errMsg='You must finish defining your shape before creating this feature. Double-Click on the last vertex to finish drawing your shape.';}else{errMsg='You must finish defining your shape before creating this feature. Return to Step 1 and click "Done Editing", when you are finished.';}}else if(manipulator.isShapeDefined()===false){errMsg='You must create a geometry for this feature before continuing. Return to Step 1 and click on "Draw Shape" to begin.';}
if(errMsg){tabs.tabs('select','#PanelGeometry');alert(errMsg);return false;}else{manipulator.destroy();}}
panel.spin(textLookup['saving']);$(that).trigger('saving',[textLookup['saving']]);return true;},success:function(text,status,req,formel){$(that).trigger('doneSaving');if(text.match('<form')||text.match('<FORM')){var panelOpts={loading_msg:'Loading form',showClose:true};panelOpts['showCloseButton']=false;panelOpts['success']=function(){madrona.setupForm=function(){alert('error:setupForm called after clearing?');};}
madrona.setupForm=function(form){setupForm(form);}
panel.close();panel.stopSpinning();panel.showText(text,panelOpts);}else{panel.close();panel.stopSpinning();var info=jQuery.parseJSON(text);if(info['status']!=200&&info['status']!=201){unspin();tree.refresh();alert('There was an error saving your feature.');}else{onChange(text,status,req);}}}};var a=$(form).attr('action');if(typeof a!=='undefined'){if(a[a.length-1]!=='/'){$(form).attr('action',a+'/');}}
$(form).ajaxForm(opts);el.find('.submit_button').click(function(){form.trigger('submit');});el.find('.cancel_button').click(function(){if(previouslySelected){if(jQuery.isArray(previouslySelected)){jQuery.each(previouslySelected,function(i,kmlObject){kmlObject.setVisibility(true);});}else{previouslySelected.setVisibility(true);}}
if(manipulator){manipulator.destroy();}
panel.close();if(options.cancel){options.cancel();}});if(tabs&&tabs.length&&$('.errorlist').length){tabs.tabs('select','#PanelAttributes');}
panel.show();if($('#PanelAttributes').length){$('#PanelAttributes').parent().parent().parent().parent().scrollTop(1).scrollTop(0);}
$(that).trigger('form_shown',[panel,null]);};function onError(xhr,status,errorThrown){alert('failed to perform '+
this.action.title+' action.\n'+status+'\n'+errorThrown);unspin();}
var to_concat=['X-Madrona-Select','X-Madrona-Toggle','X-Madrona-Untoggle','X-Madrona-Parent-Hint'];function onChange(data,status,xhr){unspin();$(that).trigger('edit',[data,status,xhr,this]);}
function spin(msg){tbar.setEnabled(false);tree.showLoading(msg);}
function unspin(){tbar.setEnabled(true);tree.hideLoading();}
function enableDragDrop(node){if(!that.workspace){return;}
node=node||kmlEl;jQuery.each(that.workspace.collections,function(i,feature){node.find('li.'+feature.id).droppable({accept:function(target){var feature_type=$(this).data('feature');var passes=true;var selector=jQuery.map(feature_type.accepts,function(a){return'.'+a}).join(', ');jQuery.each(dragDropSelection,function(){passes=passes&&$(this).is(selector);});return passes;},activeClass:'ui-state-highlight',hoverClass:'drophover',tolerance:'pointer',drop:onDrop,greedy:true}).data('feature',feature);});node.find(jQuery.map(that.workspace.collectables,function(f){return'li.'+f}).join(', ')).draggable({helper:function(e){var li=$(e.target).parent();var alreadySelected=li.hasClass('kmltree-selected');var helper=$('<ul class="mm-drag-helper"></ul>');$(document.body).append(helper);dragDropSelection=$(alreadySelected?selectedNodes:$(e.target).parent());dragDropSelection.clone().appendTo(helper);helper.blur();if(!alreadySelected){tree.clearSelection();tree.selectNodes(li);}
return helper;},scroll:true,revert:'invalid',handle:'span.name, span.icon',delay:150,scroll:true,greedy:true});jQuery.each(that.workspace.featureClasses.all,function(i,f){node.find('li.'+f.id).data('feature',f);});if(node.hasClass('kmlEditor')){node.find('li:first > span, li:first > div').droppable({activeClass:'ui-state-highlight',hoverClass:'drophover',tolerance:'pointer',drop:onDrop,greedy:true});}}
function onDrop(event,ui){$('.mm-drag-helper').hide();var destination=$(event.target);if(destination.is('span, div')){destination=destination.parent();}
var parentCollections={};jQuery.each(dragDropSelection,function(i,node){var parent=$(node).parent().parent();if(parent.hasClass('kmltree-item')&&parent!==kmlEl){var id=$(parent).data('id');if(id in parentCollections){parentCollections[id].children.push($(node).data('id'));}else{parentCollections[id]={id:id,node:parent,feature:$(parent).data('feature'),children:[$(node).data('id')]}}}else{if('none'in parentCollections){parentCollections['none']['children'].push($(node).data('id'));}else{parentCollections['none']={node:destination,children:[$(node).data('id')]}}}});dragDropSelection=[];var parents=[];for(var key in parentCollections){parents.push(parentCollections[key]);}
parents=jQuery.map(parents,function(parent){if(destination[0]===parent['node'][0]){return null;}else{return parent;}});spin('Moving selected features');requests=[];jQuery.each(parents,function(i,parent){var url;if(!$(destination).data('feature')){url=parent.feature.buildRemoveUrl(parent.id,parent.children);}else{var collection=$(destination).data('feature');url=collection.buildAddUrl($(destination).data('id'),parent.children);}
requests.push(jQuery.ajax({url:url,type:'POST',dataType:'text',context:{action:{title:'move items'}}}));});jQuery.when.apply(that,requests).then(function(){unspin();if(requests.length===0){return;}
var info={};jQuery.each(requests,function(i,xhr){try{var resp=jQuery.parseJSON(xhr.responseText);}catch(e){alert('Problem parsing server response');}
jQuery.each(to_concat,function(i,key){if(key in resp&&resp[key].length){if(key in info){info[key]=info[key]+' '+resp[key];}else{info[key]=resp[key];}}});});onChange(info);},function(){alert('error moving features');unspin();});}
that.clearSelection=tree.clearSelection;that.refresh=function(callback){tbar.setEnabled(false);var cback=function(e,kmlObject){enableDragDrop(kmlEl);tbar.setEnabled(true);create_button.setEnabled(true);callback(e,kmlObject);}
$(tree).one('kmlLoaded',cback);tree.refresh(true);};return that;}})();function setupBookmarkFeatureUI(){$('#bookmark-close').click(function(){$('.cancel_button').click();$('#bookmark-close').hide();return false;});$('#bookmark-menu-link').click(function(e){e.preventDefault();var url="/features/bookmark/form/";var panelOpts={loading_msg:'Loading Bookmark Form',showClose:true};var panel=madrona.editors[0].panel;function setupForm(form,options){options=options||{};var el=panel.getEl();el.find('.close').hide();el.find('input[type=submit]').hide();var manipulator;opts={iframe:true,beforeSubmit:function(a,b,c){panel.spin('Please wait while we save your bookmark.');$(that).trigger('saving',["Saving changes"]);return true;},success:function(text,status,req,formel){$(that).trigger('doneSaving');if(text.match('<form')||text.match('<FORM')){var panelOpts={loading_msg:'Loading form',showClose:true};panelOpts['showCloseButton']=false;panelOpts['success']=function(){madrona.setupForm=function(){alert('error:setupForm called after clearing?');};}
madrona.setupForm=function(form){setupForm(form);}
panel.close();panel.stopSpinning();panel.showText(text,panelOpts);}else{panel.close();panel.stopSpinning();var info=jQuery.parseJSON(text);if(info['status']!=200&&info['status']!=201){tree.refresh();alert('There was an error saving your feature.');}else{$(madrona.editors[0]).trigger('edit',[text,status,req,this]);}}}};var a=$(form).attr('action');if(typeof a!=='undefined'){if(a[a.length-1]!=='/'){$(form).attr('action',a+'/');}}
$(form).ajaxForm(opts);el.find('.submit_button').click(function(){$('#bookmark-close').hide();form.trigger('submit');});el.find('.cancel_button').click(function(){$('#bookmark-close').hide();panel.close();if(options.cancel){options.cancel();}});var tabs=el.find('.tabs');tabs.bind('tabsshow',function(e){var div=$(this).parent().parent().parent();div.scrollTop(1);div.scrollTop(0);});tabs.tabs('select','#PanelAttributes');tabs.tabs('disable',0);tabs.find('> .ui-tabs-nav').hide();if(tabs&&tabs.length&&$('.errorlist').length){tabs.tabs('select','#PanelAttributes');}
panel.show();if($('#PanelAttributes').length){$('#PanelAttributes').parent().parent().parent().parent().scrollTop(1).scrollTop(0);}
$(that).trigger('form_shown',[panel,null]);};madrona.setupForm=function(form){setupForm(form);}
madrona.menu_items.closeAll();$('.panelMask').hide();panel.showUrl(url,panelOpts);});}